<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Discussion - Brilliant Minds</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }
        
        .container {
            background: white;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 24px;
            box-shadow: 0 32px 80px rgba(0,0,0,0.12);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 48px 40px;
            text-align: center;
            position: relative;
        }
        
        .nav-back {
            position: absolute;
            top: 20px;
            left: 30px;
        }
        
        .nav-back a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 16px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 48px;
        }
        
        .group-setup {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .setup-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .setup-header h3 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .discussion-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .discussion-type {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .discussion-type:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
        }
        
        .discussion-type.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
        }
        
        .type-icon {
            font-size: 2rem;
            margin-bottom: 15px;
        }
        
        .type-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .type-description {
            font-size: 0.9rem;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .participant-slot {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .slot-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .participant-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 10px;
        }
        
        .slot-title {
            font-weight: 600;
            color: #2c3e50;
        }
        
        select, input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            margin-bottom: 10px;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .moderator-setup {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #ff9800;
        }
        
        .moderator-title {
            font-weight: 700;
            color: #e65100;
            margin-bottom: 10px;
        }
        
        .moderator-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .moderator-option {
            padding: 8px 16px;
            background: white;
            border: 2px solid #ff9800;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .moderator-option:hover {
            background: #ff9800;
            color: white;
        }
        
        .moderator-option.selected {
            background: #ff9800;
            color: white;
        }
        
        .topic-setup {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .topic-title {
            font-weight: 700;
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #4caf50;
            border-radius: 10px;
            min-height: 100px;
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
        }
        
        .controls {
            text-align: center;
        }
        
        .start-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 18px 40px;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 8px 24px rgba(76, 175, 80, 0.3);
        }
        
        .start-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(76, 175, 80, 0.4);
        }
        
        .start-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .discussion-arena {
            display: none;
            background: #f8f9fa;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            min-height: 400px;
        }
        
        .discussion-round {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
        }
        
        .round-header {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.2rem;
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
            border-radius: 10px;
        }
        
        .phase-indicator {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #e65100;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }
        
        .speaker {
            margin: 20px 0;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }
        
        .speaker-name {
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .speaker-content {
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .speaker:nth-child(odd) {
            border-left-color: #667eea;
            background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
        }
        
        .speaker:nth-child(even) {
            border-left-color: #764ba2;
            background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
        }
        
        .moderator-speaker {
            border-left-color: #ff9800;
            background: linear-gradient(135deg, #fff8f0 0%, #fff3e0 100%);
        }
        
        .academic-referee-speaker {
            border-left-color: #8e24aa;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .role-assignment {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }
        
        .role-title {
            font-weight: 700;
            color: #2e7d32;
            margin-bottom: 5px;
        }
        
        .role-description {
            color: #4a5568;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nav-back">
                <a href="index.html">🧠 ← Back to Discussion Arena</a>
            </div>
            <h1>🎭 Group Discussion Arena</h1>
            <p class="subtitle">Create multi-person conversations with distinct formats</p>
        </div>
        
        <div class="content">
            <div class="group-setup" id="setupSection">
                <div class="setup-header">
                    <h3>Choose Discussion Format</h3>
                    <p>Each format creates a completely different discussion experience</p>
                </div>
                
                <div class="discussion-types">
                    <div class="discussion-type" onclick="selectDiscussionType('panel', 3)">
                        <div class="type-icon">🎪</div>
                        <div class="type-title">Panel Discussion</div>
                        <div class="type-description">3 experts share professional knowledge and perspectives on a topic</div>
                    </div>
                    
                    <div class="discussion-type" onclick="selectDiscussionType('debate', 4)">
                        <div class="type-icon">⚖️</div>
                        <div class="type-title">Formal Debate</div>
                        <div class="type-description">4 participants argue opposing positions with structured rebuttals</div>
                    </div>
                    
                    <div class="discussion-type" onclick="selectDiscussionType('roundtable', 5)">
                        <div class="type-icon">🔄</div>
                        <div class="type-title">Roundtable</div>
                        <div class="type-description">5 minds collaborate to explore ideas and build solutions together</div>
                    </div>
                    
                    <div class="discussion-type" onclick="selectDiscussionType('symposium', 4)">
                        <div class="type-icon">🏛️</div>
                        <div class="type-title">Academic Symposium</div>
                        <div class="type-description">4 scholars present research and engage in peer review discussion</div>
                    </div>
                </div>
                
                <div class="participants-grid" id="participantsGrid">
                    <!-- Participant slots will be generated here -->
                </div>
                
                <div class="moderator-setup">
                    <div class="moderator-title">🎯 Discussion Moderator</div>
                    <div class="moderator-options">
                        <div class="moderator-option selected" onclick="selectModerator('ai')">AI Moderator</div>
                        <div class="moderator-option" onclick="selectModerator('socrates')">Socratic Guide</div>
                        <div class="moderator-option" onclick="selectModerator('journalist')">Investigative Journalist</div>
                        <div class="moderator-option" onclick="selectModerator('academic-referee')">Academic Referee</div>
                    </div>
                </div>
                
                <div class="topic-setup">
                    <div class="topic-title">💭 Discussion Topic</div>
                    <textarea id="topicInput" placeholder="What should they discuss? Be specific about the angle or question you want explored..."></textarea>
                </div>
                
                <div class="controls">
                    <button class="start-button" onclick="startGroupDiscussion()" id="startButton" disabled>
                        ✨ Start Group Discussion
                    </button>
                </div>
            </div>
            
            <div class="discussion-arena" id="discussionArena">
                <!-- Group discussion will appear here -->
            </div>
        </div>
    </div>

    <script>
        let discussionState = {
            type: null,
            participantCount: 0,
            participants: [],
            moderator: 'ai',
            topic: '',
            currentRound: 0,
            currentPhase: 0
        };

        // Enhanced discussion formats with true structural differences
        const discussionFormats = {
            panel: {
                name: "Panel Discussion",
                participants: 3,
                phases: [
                    { name: "Expert Presentations", description: "Each panelist shares their professional perspective" },
                    { name: "Cross-Discussion", description: "Panelists respond to each other's insights" },
                    { name: "Audience Q&A", description: "Final clarifications and key takeaways" }
                ],
                description: "Professional experts sharing knowledge and perspectives"
            },
            
            debate: {
                name: "Formal Debate", 
                participants: 4,
                phases: [
                    { name: "Opening Arguments", description: "Pro and Con sides present their cases" },
                    { name: "Rebuttals", description: "Counter-arguments and responses" },
                    { name: "Cross-Examination", description: "Direct challenges and clarifications" },
                    { name: "Closing Statements", description: "Final arguments and summations" }
                ],
                description: "Structured argumentative discussion with opposing sides"
            },
            
            roundtable: {
                name: "Roundtable",
                participants: 5,
                phases: [
                    { name: "Initial Perspectives", description: "Each participant shares their viewpoint" },
                    { name: "Collaborative Building", description: "Building on others' ideas constructively" },
                    { name: "Synthesis", description: "Finding common ground and connections" },
                    { name: "Consensus Building", description: "Working toward shared understanding" }
                ],
                description: "Collaborative exploration seeking synthesis and solutions"
            },
            
            symposium: {
                name: "Academic Symposium",
                participants: 4,
                phases: [
                    { name: "Scholarly Presentations", description: "Academic papers and research findings" },
                    { name: "Peer Review", description: "Scholarly critique and methodology discussion" },
                    { name: "Academic Exchange", description: "Theoretical debate and implications" },
                    { name: "Research Synthesis", description: "Future directions and collaborative insights" }
                ],
                description: "Scholarly presentations with academic peer review"
            }
        };

        // Enhanced moderator personalities
        const moderatorStyles = {
            'ai': {
                name: "AI Moderator",
                prompt: "You are a neutral AI moderator. Keep discussions on track, summarize key points, and ensure all participants contribute. Be objective and helpful."
            },
            'socrates': {
                name: "Socratic Guide", 
                prompt: "You are a Socratic moderator. Ask probing questions that challenge assumptions and lead to deeper understanding. Guide through questioning rather than stating."
            },
            'journalist': {
                name: "Investigative Journalist",
                prompt: "You are an investigative journalist moderating. Ask tough, probing questions. Challenge claims, seek evidence, and push for specificity and accountability."
            },
            'academic-referee': {
                name: "Academic Referee",
                prompt: "You are an academic referee moderating scholarly discourse. Ensure rigorous methodology, proper citations, and intellectual honesty. Challenge logical fallacies and demand evidence-based arguments."
            }
        };

        // Import figures from your main app (simplified version)
        const figures = {
            // Philosophers
            confucius: { name: "Confucius", prompt: "You are Confucius. Speak with wisdom about social harmony, virtue, and proper relationships." },
            plato: { name: "Plato", prompt: "You are Plato. Speak about ideals, truth, and the nature of reality." },
            aristotle: { name: "Aristotle", prompt: "You are Aristotle. Speak as a systematic philosopher and logician." },
            kant: { name: "Immanuel Kant", prompt: "You are Immanuel Kant. Speak about duty, categorical imperatives, and moral philosophy." },
            nietzsche: { name: "Friedrich Nietzsche", prompt: "You are Friedrich Nietzsche. Speak provocatively about the will to power." },
            
            // Scientists & Others
            einstein: { name: "Albert Einstein", prompt: "You are Albert Einstein. Speak about relativity, the nature of space and time." },
            darwin: { name: "Charles Darwin", prompt: "You are Charles Darwin. Speak about evolution and natural selection." },
            hawking: { name: "Stephen Hawking", prompt: "You are Stephen Hawking. Speak about black holes and cosmology." },
            feynman: { name: "Richard Feynman", prompt: "You are Richard Feynman. Speak with curiosity about physics using simple explanations." },
            
            // Add more figures as needed...
        };

        function selectDiscussionType(type, count) {
            document.querySelectorAll('.discussion-type').forEach(el => {
                el.classList.remove('selected');
            });
            
            event.target.closest('.discussion-type').classList.add('selected');
            
            discussionState.type = type;
            discussionState.participantCount = count;
            
            generateParticipantSlots(count, type);
            checkReadiness();
        }

        function generateParticipantSlots(count, type) {
            const grid = document.getElementById('participantsGrid');
            grid.innerHTML = '';
            
            // Add role assignments for certain formats
            if (type === 'debate') {
                const roleDiv = document.createElement('div');
                roleDiv.className = 'role-assignment';
                roleDiv.innerHTML = `
                    <div class="role-title">🏛️ Debate Structure</div>
                    <div class="role-description">Participants 1 & 2 will argue FOR the position. Participants 3 & 4 will argue AGAINST.</div>
                `;
                grid.appendChild(roleDiv);
            }
            
            if (type === 'symposium') {
                const roleDiv = document.createElement('div');
                roleDiv.className = 'role-assignment';
                roleDiv.innerHTML = `
                    <div class="role-title">🎓 Academic Format</div>
                    <div class="role-description">Each participant will present research, then engage in scholarly peer review and discussion.</div>
                `;
                grid.appendChild(roleDiv);
            }
            
            for (let i = 1; i <= count; i++) {
                const slot = document.createElement('div');
                slot.className = 'participant-slot';
                
                let roleLabel = `Participant ${i}`;
                if (type === 'debate') {
                    roleLabel = i <= 2 ? `Pro Side ${i}` : `Con Side ${i-2}`;
                } else if (type === 'symposium') {
                    roleLabel = `Scholar ${i}`;
                } else if (type === 'panel') {
                    roleLabel = `Expert ${i}`;
                }
                
                slot.innerHTML = `
                    <div class="slot-header">
                        <div class="participant-number">${i}</div>
                        <div class="slot-title">${roleLabel}</div>
                    </div>
                    <select onchange="updateParticipant(${i}, this.value)">
                        <option value="">Choose a brilliant mind...</option>
                        <optgroup label="🤔 Philosophers">
                            <option value="confucius">Confucius</option>
                            <option value="plato">Plato</option>
                            <option value="aristotle">Aristotle</option>
                            <option value="kant">Immanuel Kant</option>
                            <option value="nietzsche">Friedrich Nietzsche</option>
                        </optgroup>
                        <optgroup label="🔬 Scientists">
                            <option value="einstein">Albert Einstein</option>
                            <option value="darwin">Charles Darwin</option>
                            <option value="hawking">Stephen Hawking</option>
                            <option value="feynman">Richard Feynman</option>
                        </optgroup>
                    </select>
                    <input type="text" placeholder="Or enter any name..." onchange="updateCustomParticipant(${i}, this.value)">
                `;
                grid.appendChild(slot);
            }
        }

        function updateParticipant(slot, figureId) {
            if (figureId) {
                discussionState.participants[slot - 1] = figures[figureId];
            } else {
                delete discussionState.participants[slot - 1];
            }
            checkReadiness();
        }

        function updateCustomParticipant(slot, customName) {
            if (customName.trim()) {
                discussionState.participants[slot - 1] = {
                    name: customName.trim(),
                    prompt: `You are ${customName.trim()}. Embody their personality, knowledge, and speaking style as accurately as possible.`
                };
            } else {
                delete discussionState.participants[slot - 1];
            }
            checkReadiness();
        }

        function selectModerator(type) {
            document.querySelectorAll('.moderator-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.classList.add('selected');
            discussionState.moderator = type;
        }

        function checkReadiness() {
            const button = document.getElementById('startButton');
            const topic = document.getElementById('topicInput').value.trim();
            const hasParticipants = discussionState.participants.filter(p => p).length >= 2;
            
            if (hasParticipants && topic && discussionState.type) {
                button.disabled = false;
                discussionState.topic = topic;
            } else {
                button.disabled = true;
            }
        }

        async function startGroupDiscussion() {
            discussionState.topic = document.getElementById('topicInput').value.trim();
            
            // Hide setup and show arena
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'block';
            
            const arena = document.getElementById('discussionArena');
            arena.innerHTML = '';
            
            // Start the format-specific discussion
            await runFormatSpecificDiscussion();
        }

        async function runFormatSpecificDiscussion() {
            const format = discussionFormats[discussionState.type];
            const arena = document.getElementById('discussionArena');
            
            // Run each phase of the discussion format
            for (let phaseIndex = 0; phaseIndex < format.phases.length; phaseIndex++) {
                const phase = format.phases[phaseIndex];
                
                // Create phase container
                const phaseRound = document.createElement('div');
                phaseRound.className = 'discussion-round';
                phaseRound.innerHTML = `
                    <div class="phase-indicator">
                        Phase ${phaseIndex + 1}: ${phase.name}
                    </div>
                    <div class="round-header">${phase.description}</div>
                `;
                arena.appendChild(phaseRound);
                
                // Get responses based on format and phase
                await runPhaseDiscussion(phaseRound, phaseIndex);
                
                // Add moderator transition (except for last phase)
                if (phaseIndex < format.phases.length - 1) {
                    await addModeratorTransition(phaseRound, phaseIndex);
                }
            }
            
            // Final moderator summary
            await getModeratorSummary(arena);
        }

        async function runPhaseDiscussion(container, phaseIndex) {
            const format = discussionFormats[discussionState.type];
            
            if (discussionState.type === 'debate') {
                await runDebatePhase(container, phaseIndex);
            } else if (discussionState.type === 'symposium') {
                await runSymposiumPhase(container, phaseIndex);
            } else {
                // Panel and Roundtable use similar structure
                for (let i = 0; i < discussionState.participants.length; i++) {
                    const participant = discussionState.participants[i];
                    if (participant) {
                        await getParticipantResponse(container, participant, phaseIndex, i);
                    }
                }
            }
        }

        async function runDebatePhase(container, phaseIndex) {
            if (phaseIndex === 0) { // Opening Arguments
                // Pro side first
                for (let i = 0; i < 2; i++) {
                    if (discussionState.participants[i]) {
                        await getDebateResponse(container, discussionState.participants[i], 'pro', phaseIndex);
                    }
                }
                // Con side
                for (let i = 2; i < 4; i++) {
                    if (discussionState.participants[i]) {
                        await getDebateResponse(container, discussionState.participants[i], 'con', phaseIndex);
                    }
                }
            } else {
                // Other phases - alternating responses
                for (let i = 0; i < discussionState.participants.length; i++) {
                    const participant = discussionState.participants[i];
                    if (participant) {
                        const side = i < 2 ? 'pro' : 'con';
                        await getDebateResponse(container, participant, side, phaseIndex);
                    }
                }
            }
        }

        async function runSymposiumPhase(container, phaseIndex) {
            for (let i = 0; i < discussionState.participants.length; i++) {
                const participant = discussionState.participants[i];
                if (participant) {
                    await getSymposiumResponse(container, participant, phaseIndex);
                }
            }
        }

        async function getDebateResponse(container, participant, side, phaseIndex) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${participant.name} (${side.toUpperCase()} side)</div>
                <div><span class="loading"></span>Preparing argument...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const phasePrompts = {
                    0: side === 'pro' ? 'argue-for' : 'argue-against',
                    1: 'rebuttal',
                    2: 'cross-examination', 
                    3: 'closing-argument'
                };
                
                const prompt = getFormatSpecificPrompt(phasePrompts[phaseIndex], participant, side);
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${participant.name} (${side.toUpperCase()} side)</div>
                    <div class="speaker-content">${response}</div>
                `;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${participant.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }

        async function getSymposiumResponse(container, participant, phaseIndex) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker';
            speakerDiv.innerHTML = `
                <div class="speaker-name">Dr. ${participant.name}</div>
                <div><span class="loading"></span>Preparing scholarly contribution...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const phaseTypes = ['presentation', 'peer-review', 'academic-exchange', 'synthesis'];
                const prompt = getFormatSpecificPrompt(phaseTypes[phaseIndex], participant, 'academic');
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">Dr. ${participant.name}</div>
                    <div class="speaker-content">${response}</div>
                `;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">Dr. ${participant.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }

        function getFormatSpecificPrompt(promptType, participant, context = '') {
            const basePrompt = participant.prompt;
            const topic = discussionState.topic;
            const format = discussionFormats[discussionState.type].name;
            
            const prompts = {
                'argue-for': `${basePrompt}

You are in a FORMAL DEBATE arguing FOR this position: "${topic}"

Your role is to make the strongest possible case supporting this position. Use evidence, logical reasoning, and persuasive arguments. Be competitive but respectful.

Present your argument in 120-150 words.`,

                'argue-against': `${basePrompt}

You are in a FORMAL DEBATE arguing AGAINST this position: "${topic}"

Your role is to make the strongest possible case opposing this position. Challenge assumptions, present counter-evidence, and expose flaws.

Present your opposition in 120-150 words.`,

                'presentation': `${basePrompt}

You are presenting at an ACADEMIC SYMPOSIUM on: "${topic}"

Present your scholarly research and findings on this topic. Be rigorous, cite evidence, and present original insights. Use academic language appropriate for peer review.

Present your research in 150-180 words.`,

                'peer-review': `${basePrompt}

You are providing PEER REVIEW at an academic symposium on: "${topic}"

Critique the presentations you've heard with scholarly rigor. Comment on methodology, evidence, logical consistency, and theoretical implications.

Provide your academic critique in 120-150 words.`
            };
            
            return prompts[promptType] || `${basePrompt}

You are participating in a ${format} about: "${topic}"

Contribute meaningfully to this discussion in 120-150 words.`;
        }

        async function getParticipantResponse(container, participant, phaseIndex, participantIndex) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${participant.name}</div>
                <div><span class="loading"></span>Thinking...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${participant.prompt}

You are participating in a ${discussionFormats[discussionState.type].name} about: "${discussionState.topic}"

${getPhaseSpecificInstructions(phaseIndex)}

Respond in 120-150 words.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${participant.name}</div>
                    <div class="speaker-content">${response}</div>
                `;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${participant.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }

        function getPhaseSpecificInstructions(phaseIndex) {
            const format = discussionFormats[discussionState.type];
            const phase = format.phases[phaseIndex];
            
            if (discussionState.type === 'panel') {
                const instructions = [
                    "As an expert, share your professional perspective and knowledge on this topic.",
                    "Respond to the insights shared by other panelists. Build on their points or offer different perspectives.",
                    "Provide final clarifications and key takeaways for the audience."
                ];
                return instructions[phaseIndex] || instructions[0];
            } else if (discussionState.type === 'roundtable') {
                const instructions = [
                    "Share your initial perspective on this topic.",
                    "Build constructively on what others have shared. Look for connections and add nuance.",
                    "Help synthesize the different viewpoints. Look for common ground.",
                    "Work toward a collaborative understanding or solution."
                ];
                return instructions[phaseIndex] || instructions[0];
            }
            
            return phase.description;
        }

        async function addModeratorTransition(container, phaseIndex) {
            const moderatorDiv = document.createElement('div');
            const moderatorInfo = moderatorStyles[discussionState.moderator];
            moderatorDiv.className = `speaker ${discussionState.moderator === 'academic-referee' ? 'academic-referee-speaker' : 'moderator-speaker'}`;
            moderatorDiv.innerHTML = `
                <div class="speaker-name">${moderatorInfo.name}</div>
                <div><span class="loading"></span>Transitioning to next phase...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `${moderatorInfo.prompt}

You are moderating a ${discussionFormats[discussionState.type].name} about "${discussionState.topic}".

We just completed: ${discussionFormats[discussionState.type].phases[phaseIndex].name}
Next phase: ${discussionFormats[discussionState.type].phases[phaseIndex + 1].name}

Provide a brief transition that summarizes key points from this phase and sets up the next phase. Be concise (50-80 words).`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">${moderatorInfo.name}</div>
                    <div class="speaker-content">${response}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">${moderatorInfo.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }

        async function getModeratorSummary(arena) {
            const summaryRound = document.createElement('div');
            summaryRound.className = 'discussion-round';
            summaryRound.innerHTML = `<div class="round-header">📋 Final Summary & Analysis</div>`;
            arena.appendChild(summaryRound);
            
            const moderatorInfo = moderatorStyles[discussionState.moderator];
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = `speaker ${discussionState.moderator === 'academic-referee' ? 'academic-referee-speaker' : 'moderator-speaker'}`;
            moderatorDiv.innerHTML = `
                <div class="speaker-name">${moderatorInfo.name}</div>
                <div><span class="loading"></span>Analyzing the complete discussion...</div>
            `;
            summaryRound.appendChild(moderatorDiv);
            
            try {
                const prompt = `${moderatorInfo.prompt}

You just moderated a ${discussionFormats[discussionState.type].name} about "${discussionState.topic}" between ${discussionState.participants.map(p => p.name).join(', ')}.

Provide a comprehensive summary that includes:
- Key insights that emerged
- Main areas of agreement and disagreement  
- Most compelling arguments or evidence presented
- Questions worth exploring further
- Overall assessment of the discussion

Keep it insightful but concise (200-250 words).`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">${moderatorInfo.name}</div>
                    <div class="speaker-content">${response}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">${moderatorInfo.name}</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }

        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'group-discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }

        // Listen for topic input changes
        document.getElementById('topicInput').addEventListener('input', function() {
            discussionState.topic = this.value.trim();
            checkReadiness();
        });
    </script>
</body>
</html>