async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <button class="bookmark-button" onclick="addBookmark('${discussionState.figure2.name}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brilliant Minds - Discussion Arena</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .container {
            background: white;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 24px;
            box-shadow: 0 32px 80px rgba(0,0,0,0.12), 0 8px 32px rgba(0,0,0,0.06);
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 48px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            opacity: 0.5;
        }
        
        .header * {
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 3.2rem;
            font-weight: 800;
            margin-bottom: 16px;
            text-shadow: 0 4px 12px rgba(0,0,0,0.15);
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .nav-links {
            position: absolute;
            top: 20px;
            left: 30px;
            z-index: 2;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }
        
        .nav-links a:hover {
            opacity: 1;
            text-decoration: underline;
        }
        
        .content {
            padding: 48px;
        }
        
        .setup-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .setup-section h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .figures-setup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .figure-selection {
            background: white;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
            border: 2px solid #f8f9fa;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .figure-selection:hover {
            transform: translateY(-8px);
            box-shadow: 0 24px 60px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08);
            border-color: #e9ecef;
        }
        
        .figure-1 {
            border-left: 4px solid #667eea;
        }
        
        .figure-2 {
            border-left: 4px solid #764ba2;
        }
        
        .figure-selection h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .figure-selection label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        /* Toggle buttons for selection mode */
        .selection-mode {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .mode-button {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            color: #6c757d;
        }
        
        .mode-button.active {
            background: white;
            color: #495057;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .mode-button:hover:not(.active) {
            color: #495057;
        }
        
        select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
        }
        
        .custom-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
        }
        
        .custom-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
        }
        
        .custom-input::placeholder {
            color: #6c757d;
            font-style: italic;
        }
        
        .suggestion-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 13px;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .suggestion-box strong {
            color: #495057;
            display: block;
            margin-bottom: 6px;
        }
        
        optgroup {
            font-weight: bold;
            color: #495057;
            padding: 8px 0;
        }
        
        option {
            font-weight: normal;
            padding: 8px 12px;
        }
        
        .participants-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            color: white;
            display: none;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .participant {
            display: inline-block;
            margin: 0 15px;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .participant:hover {
            transform: scale(1.05);
        }
        
        .participant-1 {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }
        
        .participant-2 {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }
        
        .question-input-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            display: none;
            border: 1px solid #2196F3;
        }
        
        .question-input-section h4 {
            color: #1565C0;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .discussion-arena {
            border: 2px solid #f1f3f5;
            border-radius: 24px;
            padding: 40px;
            min-height: 500px;
            margin-bottom: 32px;
            background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
            overflow-y: auto;
            max-height: none;
            display: none;
        }
        
        .discussion-round {
            margin-bottom: 40px;
            padding: 32px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 12px 32px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
            border-left: 6px solid #667eea;
            max-height: none;
            overflow: visible;
        }
        
        .question-header {
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #2e7d32;
            border: 2px solid #4caf50;
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .speaker {
            margin: 24px 0;
            padding: 24px;
            border-radius: 16px;
            border-left: 5px solid;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.04);
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: auto;
            max-height: none;
            overflow: visible;
            position: relative;
        }
        
        .speaker:hover {
            transform: translateX(8px);
        }
        
        .speaker-content {
            line-height: 1.7;
            color: #2c3e50;
        }
        
        .speaker-content p {
            margin: 16px 0;
            line-height: 1.7;
        }
        
        .speaker-content p:first-child {
            margin-top: 0;
        }
        
        .speaker-content p:last-child {
            margin-bottom: 0;
        }
        
        .figure-1-speaker {
            border-left-color: #667eea;
            background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .figure-2-speaker {
            border-left-color: #764ba2;
            background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .moderator-speaker {
            border-left-color: #ff9800;
            background: linear-gradient(135deg, #fff8f0 0%, #fff3e0 100%);
            min-height: auto;
            overflow: visible;
            max-height: none;
            height: auto;
        }
        
        .moderator-content {
            line-height: 1.7;
            max-height: none;
            overflow: visible;
            height: auto;
        }
        
        .moderator-content h4 {
            font-weight: 700;
            font-size: 1.1rem;
            color: #e65100;
            margin: 20px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffcc02;
            display: block;
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .moderator-content h4:first-child {
            margin-top: 0;
        }
        
        .moderator-content p {
            margin: 12px 0;
            color: #424242;
            font-size: 15px;
        }
        
        .moderator-content ul, .moderator-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .moderator-content li {
            margin: 8px 0;
            color: #424242;
        }
        
        .speaker-name {
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .extended-separator {
            margin: 25px 0;
            padding: 15px;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border-radius: 10px;
            text-align: center;
            font-weight: 700;
            color: #1976D2;
            border: 2px dashed #2196F3;
        }
        
        .controls {
            text-align: center;
            margin: 25px 0;
        }
        
        button {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            margin: 0 8px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.01em;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08);
        }
        
        button:active {
            transform: translateY(-2px);
        }
        
        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .start-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            font-size: 18px;
            padding: 18px 40px;
        }
        
        .ask-button {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }
        
        .continue-button {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }
        
        .secondary-button {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .figures-setup {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .participant {
                display: block;
                margin: 10px 0;
            }
            
            button {
                display: block;
                width: 100%;
                margin: 8px 0;
            }
        }
        
        /* Question Generator Styles */
        .question-generator {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #4caf50;
        }
        
        .generator-header h5 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .generator-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .generator-controls select {
            padding: 10px 15px;
            border: 2px solid #4caf50;
            border-radius: 8px;
            background: white;
            color: #2e7d32;
            font-weight: 500;
            font-size: 14px;
            min-width: 180px;
        }
        
        .generate-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }
        
        .generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }
        
        .generate-button:disabled {
            background: #ccc;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        .generated-questions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .questions-list {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .question-suggestion {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            border-left: 4px solid #4caf50;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }
        
        .question-suggestion:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            background: #f8f9fa;
        }
        
        .question-suggestion:active {
            transform: translateX(3px);
        }
        
        .question-text {
            color: #2e7d32;
            font-weight: 500;
            font-size: 15px;
            line-height: 1.4;
        }
        
        .question-category-tag {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .generator-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .loading-questions {
            text-align: center;
            padding: 20px;
            color: #4caf50;
            font-style: italic;
        }
        .bookmark-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            color: #f57c00;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .bookmark-button:hover {
            background: rgba(255, 193, 7, 0.2);
            transform: scale(1.05);
        }
        
        .bookmark-button.bookmarked {
            background: #ffc107;
            color: white;
        }
        
        .export-controls {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            display: none;
            border: 1px solid #4caf50;
        }
        
        .export-controls h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .export-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .export-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }
        
        .bookmarks-panel {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            display: none;
            border: 1px solid #ffc107;
        }
        
        .bookmarks-panel h4 {
            color: #f57c00;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .bookmark-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .bookmark-speaker {
            font-weight: 600;
            color: #f57c00;
            margin-bottom: 8px;
        }
        
        .bookmark-content {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .bookmark-meta {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-bookmark {
            background: #ff5722;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .bookmarks-empty {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }
        
        /* Direct chat section styles */
        .direct-chat-section {
            margin-top: 40px;
            padding: 0 48px 48px 48px;
        }
        
        .direct-chat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            border: 2px solid #e9ecef;
            box-shadow: 0 12px 32px rgba(0,0,0,0.06);
        }
        
        .direct-chat-card h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .direct-chat-card p {
            color: #495057;
            margin-bottom: 32px;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .figure-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .figure-chat-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 16px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
            margin: 8px;
        }
        
        .figure-chat-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(102, 126, 234, 0.3);
        }
        
        @media (max-width: 768px) {
            .direct-chat-section {
                padding: 0 20px 20px 20px;
            }
            
            .direct-chat-card {
                padding: 24px;
            }
            
            .figure-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .figure-chat-button {
                width: 100%;
                max-width: 280px;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pulse animation for important buttons */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(102, 126, 234, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Brilliant Minds</h1>
            <p class="subtitle">Watch brilliant minds explore ideas together through thoughtful conversation</p>
        </div>
            
            <!-- Discussion Setup -->
            <div class="setup-section fade-in" id="setupSection">
                <h3>🎭 Choose Your Discussion Participants</h3>
                
                <div class="figures-setup">
                    <div style="grid-column: 1 / -1; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); padding: 20px; border-radius: 15px; border-left: 4px solid #4CAF50;">
            <h4 style="color: #2e7d32; margin-bottom: 12px;">💡 Try These Fascinating Discussions:</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                <div>"What is the meaning of life?" <br><em>Socrates vs Einstein</em></div>
                <div>"How should we approach AI development?" <br><em>Turing vs Musk</em></div>
                <div>"What makes great leadership?" <br><em>Lincoln vs Churchill</em></div>
                <div>"Is free will real?" <br><em>Kant vs Hawking</em></div>
                <div>"What is the nature of consciousness?" <br><em>Penrose vs Descartes</em></div>
                <div>"How do we create a just society?" <br><em>Plato vs Jefferson</em></div>
            </div>
        </div>
    </div>

                    <div class="figure-selection figure-1">
                        <h4>🎤 First Speaker</h4>
                        
                        <!-- Selection Mode Toggle -->
                        <div class="selection-mode">
                            <button type="button" class="mode-button active" onclick="toggleMode(1, 'preset')">📋 Preset Figures</button>
                            <button type="button" class="mode-button" onclick="toggleMode(1, 'custom')">✏️ Write Your Own</button>
                        </div>
                        
                        <label>Brilliant Figure:</label>
                        <select id="figure1" class="preset-select">
                             <optgroup label="🤔 Philosophers">
                                <option value="aristotle" selected="selected">Aristotle</option>
                                <option value="socrates">Socrates</option>
                                <option value="plato">Plato</option>
                                <option value="confucius">Confucius</option>
                                <option value="kant">Immanuel Kant</option>
                                <option value="nietzsche">Friedrich Nietzsche</option>
                            </optgroup>
                            <optgroup label="🔬 Scientists & Mathematicians">
                                <option value="einstein">Albert Einstein</option>
                                <option value="newton">Isaac Newton</option>
                                <option value="darwin">Charles Darwin</option>
                                <option value="curie">Marie Curie</option>
                                <option value="galileo">Galileo Galilei</option>
                                <option value="hawking">Stephen Hawking</option>
                                <option value="feynman">Richard Feynman</option>
                                <option value="tesla">Nikola Tesla</option>
                                <option value="pasteur">Louis Pasteur</option>
                                <option value="watson">James Watson</option>
                                <option value="turing">Alan Turing</option>
                            </optgroup>
                            <optgroup label="🖥️ Logic, Mathematics & Computing Pioneers">
                                <option value="frege">Gottlob Frege</option>
                                <option value="russell">Bertrand Russell</option>
                                <option value="hilbert">David Hilbert</option>
                                <option value="vonneumann">John von Neumann</option>
                                <option value="godel">Kurt Gödel</option>
                                <option value="shannon">Claude Shannon</option>
                                <option value="church_historical">Alonzo Church</option>
                                <option value="babbage">Charles Babbage</option>
                                <option value="lovelace">Ada Lovelace</option>
                            </optgroup>
                            <optgroup label="🧬 Contemporary Scientists & Thinkers">
                                <option value="penrose">Roger Penrose</option>
                                <option value="witten">Edward Witten</option>
                                <option value="venter">Craig Venter</option>
                                <option value="tao">Terence Tao</option>
                                <option value="yau">Shing-Tung Yau</option>
                                <option value="church">Alonzo Church</option>
                                <option value="kahneman">Daniel Kahneman</option>
                                <option value="wilson">Edward O. Wilson</option>
                                <option value="chomsky">Noam Chomsky</option>
                                <option value="pinker">Steven Pinker</option>
                                <option value="harari">Yuval Noah Harari</option>
                                <option value="tegmark">Max Tegmark</option>
                            </optgroup>
                            <optgroup label="👑 Leaders & Statesmen">
                                <option value="lincoln">Abraham Lincoln</option>
                                <option value="churchill">Winston Churchill</option>
                                <option value="gandhi">Mahatma Gandhi</option>
                                <option value="jefferson">Thomas Jefferson</option>
                                <option value="cleopatra">Cleopatra</option>
                                <option value="mandela">Nelson Mandela</option>
                            </optgroup>
                            <optgroup label="🎨 Artists & Writers">
                                <option value="shakespeare">William Shakespeare</option>
                                <option value="leonardo">Leonardo da Vinci</option>
                                <option value="michelangelo">Michelangelo</option>
                                <option value="beethoven">Ludwig van Beethoven</option>
                            </optgroup>
                            <optgroup label="💰 Economic & Social Thinkers">
                                <option value="smith">Adam Smith</option>
                                <option value="marx">Karl Marx</option>
                                <option value="keynes">John Maynard Keynes</option>
                                <option value="friedman">Milton Friedman</option>
                            </optgroup>
                            <optgroup label="💼 Contemporary Leaders & Innovators">
                                <option value="gates">Bill Gates</option>
                                <option value="musk">Elon Musk</option>
                                <option value="bezos">Jeff Bezos</option>
                                <option value="jobs">Steve Jobs</option>
                                <option value="buffett">Warren Buffett</option>
                                <option value="branson">Richard Branson</option>
                            </optgroup>
                        </select>
                        
                        <input type="text" id="figure1Custom" class="custom-input" placeholder="Enter any name (e.g., Taylor Swift, Napoleon, Frida Kahlo, your grandmother...)">
                        
                        <div class="suggestion-box" id="suggestion1" style="display: none;">
                            <strong>💡 Custom Figure Tips:</strong>
                            Try historical figures, celebrities, fictional characters, or even people you know! The AI will research and embody their personality, knowledge, and speaking style.
                        </div>
                    </div>
                    
                    <div class="figure-selection figure-2">
                        <h4>🎯 Second Speaker</h4>
                        
                        <!-- Selection Mode Toggle -->
                        <div class="selection-mode">
                            <button type="button" class="mode-button active" onclick="toggleMode(2, 'preset')">📋 Preset Figures</button>
                            <button type="button" class="mode-button" onclick="toggleMode(2, 'custom')">✏️ Write Your Own</button>
                        </div>
                        
                        <label>Brilliant Figure:</label>
                        <select id="figure2" class="preset-select">
                             <optgroup label="🤔 Philosophers">
                                <option value="aristotle">Aristotle</option>
                                <option value="socrates" selected="selected">Socrates</option>
                                <option value="plato">Plato</option>
                                <option value="confucius">Confucius</option>
                                <option value="kant">Immanuel Kant</option>
                                <option value="nietzsche">Friedrich Nietzsche</option>
                            </optgroup>
                            <optgroup label="🔬 Scientists & Mathematicians">
                                <option value="einstein">Albert Einstein</option>
                                <option value="newton">Isaac Newton</option>
                                <option value="darwin">Charles Darwin</option>
                                <option value="curie">Marie Curie</option>
                                <option value="galileo">Galileo Galilei</option>
                                <option value="hawking">Stephen Hawking</option>
                                <option value="feynman">Richard Feynman</option>
                                <option value="tesla">Nikola Tesla</option>
                                <option value="pasteur">Louis Pasteur</option>
                                <option value="watson">James Watson</option>
                                <option value="turing">Alan Turing</option>
                            </optgroup>
                            <optgroup label="🖥️ Logic, Mathematics & Computing Pioneers">
                                <option value="frege">Gottlob Frege</option>
                                <option value="russell">Bertrand Russell</option>
                                <option value="hilbert">David Hilbert</option>
                                <option value="vonneumann">John von Neumann</option>
                                <option value="godel">Kurt Gödel</option>
                                <option value="shannon">Claude Shannon</option>
                                <option value="church_historical">Alonzo Church</option>
                                <option value="babbage">Charles Babbage</option>
                                <option value="lovelace">Ada Lovelace</option>
                            </optgroup>
                            <optgroup label="🧬 Contemporary Scientists & Thinkers">
                                <option value="penrose">Roger Penrose</option>
                                <option value="witten">Edward Witten</option>
                                <option value="venter">Craig Venter</option>
                                <option value="tao">Terence Tao</option>
                                <option value="yau">Shing-Tung Yau</option>
                                <option value="church">Alonzo Church</option>
                                <option value="kahneman">Daniel Kahneman</option>
                                <option value="wilson">Edward O. Wilson</option>
                                <option value="chomsky">Noam Chomsky</option>
                                <option value="pinker">Steven Pinker</option>
                                <option value="harari">Yuval Noah Harari</option>
                                <option value="tegmark">Max Tegmark</option>
                            </optgroup>
                            <optgroup label="👑 Leaders & Statesmen">
                                <option value="lincoln">Abraham Lincoln</option>
                                <option value="churchill">Winston Churchill</option>
                                <option value="gandhi">Mahatma Gandhi</option>
                                <option value="jefferson">Thomas Jefferson</option>
                                <option value="cleopatra">Cleopatra</option>
                                <option value="mandela">Nelson Mandela</option>
                            </optgroup>
                            <optgroup label="🎨 Artists & Writers">
                                <option value="shakespeare">William Shakespeare</option>
                                <option value="leonardo">Leonardo da Vinci</option>
                                <option value="michelangelo">Michelangelo</option>
                                <option value="beethoven">Ludwig van Beethoven</option>
                            </optgroup>
                            <optgroup label="💰 Economic & Social Thinkers">
                                <option value="smith">Adam Smith</option>
                                <option value="marx">Karl Marx</option>
                                <option value="keynes">John Maynard Keynes</option>
                                <option value="friedman">Milton Friedman</option>
                            </optgroup>
                            <optgroup label="💼 Contemporary Leaders & Innovators">
                                <option value="gates">Bill Gates</option>
                                <option value="musk">Elon Musk</option>
                                <option value="bezos">Jeff Bezos</option>
                                <option value="jobs">Steve Jobs</option>
                                <option value="buffett">Warren Buffett</option>
                                <option value="branson">Richard Branson</option>
                            </optgroup>
                        </select>
                        
                        <input type="text" id="figure2Custom" class="custom-input" placeholder="Enter any name (e.g., Marie Antoinette, Carl Sagan, Maya Angelou...)">
                        
                        <div class="suggestion-box" id="suggestion2" style="display: none;">
                            <strong>💡 Custom Figure Tips:</strong>
                            Try historical figures, celebrities, fictional characters, or even people you know! The AI will research and embody their personality, knowledge, and speaking style.
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="start-button pulse" onclick="startDiscussion()">✨ Start Discussion</button>
                    <button class="secondary-button" onclick="showQuickQuestions()">🎲 Get Question Ideas</button>
                </div>
            </div>
            
            <!-- Participants Display -->
            <div class="participants-display fade-in" id="participantsDisplay">
                <h3 style="margin-bottom: 20px;">Today's Conversation Partners</h3>
                <div class="participant participant-1" id="participant1Name"></div>
                <span style="font-size: 30px; margin: 0 20px;">🤝</span>
                <div class="participant participant-2" id="participant2Name"></div>
            </div>
            
            <!-- Question Input -->
            <div class="question-input-section fade-in" id="questionSection">
                <h4>💬 What would you like them to discuss?</h4>
                
                <!-- Question Generator -->
                <div class="question-generator">
                    <div class="generator-header">
                        <h5>🎲 Need inspiration? Let AI suggest questions!</h5>
                        <div class="generator-controls">
                            <select id="questionCategory">
                                <option value="philosophical">🤔 Philosophical</option>
                                <option value="scientific">🔬 Scientific</option>
                                <option value="creative">🎨 Creative</option>
                                <option value="practical">💼 Practical</option>
                                <option value="ethical">⚖️ Ethical</option>
                                <option value="futuristic">🚀 Futuristic</option>
                                <option value="personal">💭 Personal</option>
                                <option value="controversial">⚡ Controversial</option>
                                <option value="custom">🎯 Tailored to These Figures</option>
                            </select>
                            <button type="button" class="generate-button" onclick="generateQuestions()">✨ Generate Questions</button>
                        </div>
                    </div>
                    
                    <div class="generated-questions" id="generatedQuestions" style="display: none;">
                        <div class="questions-list" id="questionsList"></div>
                        <div class="generator-actions">
                            <button type="button" class="secondary-button" onclick="generateQuestions()">🔄 Generate More</button>
                            <button type="button" class="secondary-button" onclick="toggleQuestionGenerator()">❌ Close</button>
                        </div>
                    </div>
                </div>
                
                <textarea id="questionInput" placeholder="Enter your question here... or use the question generator above for AI-suggested topics!"></textarea>
                <div class="controls">
                    <button class="ask-button" onclick="askQuestion()">🚀 Start the Discussion</button>
                </div>
            </div>
            
            <!-- Discussion Arena -->
            <div class="discussion-arena fade-in" id="discussionArena">
                <!-- Discussion content will be added here -->
            </div>
            
            <div class="controls" id="discussionControls" style="display: none;">
                <button class="continue-button" onclick="continueDiscussion()" id="continueButton">🔄 Continue Discussion</button>
                <button class="ask-button" onclick="showQuestionInput()">💭 Ask Another Question</button>
                <button class="secondary-button" onclick="toggleExportPanel()">📤 Export & Share</button>
                <button class="secondary-button" onclick="toggleBookmarksPanel()">⭐ View Bookmarks</button>
                <button class="secondary-button" onclick="resetDiscussion()">🆕 New Discussion</button>
            </div>
            
            <!-- Export Controls -->
            <div class="export-controls" id="exportPanel">
                <h4>📤 Export & Share This Discussion</h4>
                <div class="export-buttons">
                    <button class="export-button" onclick="exportAsText()">📄 Download as Text</button>
                    <button class="export-button" onclick="exportAsMarkdown()">📝 Download as Markdown</button>
                    <button class="export-button" onclick="exportAsPDF()">📋 Download as PDF</button>
                    <button class="export-button" onclick="copyShareableLink()">🔗 Copy Shareable Link</button>
                    <button class="export-button" onclick="exportBookmarksOnly()">⭐ Export Bookmarks Only</button>
                </div>
            </div>
            
            <!-- Bookmarks Panel -->
            <div class="bookmarks-panel" id="bookmarksPanel">
                <h4>⭐ Your Bookmarked Insights</h4>
                <div id="bookmarksList">
                    <div class="bookmarks-empty">No bookmarks yet. Click the ⭐ button on any speaker's response to save it!</div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="export-button" onclick="clearAllBookmarks()">🗑️ Clear All Bookmarks</button>
                </div>
            </div>
            
            <!-- Direct Chat Option -->
            <div class="direct-chat-section" id="directChatSection" style="display: none;">
                <div class="direct-chat-card">
                    <h3>💬 Want to chat directly with one of these figures?</h3>
                    <p>Choose a figure from the discussion above to have a personal conversation with them.</p>
                    <div class="figure-buttons" id="figureButtons">
                        <!-- Buttons will be populated by JavaScript -->
                    </div>
                    <p style="font-size: 14px; color: #6c757d; margin-top: 16px;">
                        Or explore our <a href="chat.html" style="color: #667eea; text-decoration: none; font-weight: 600;">full chat interface</a> with all brilliant figures.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let discussionState = {
            figure1: null,
            figure2: null,
            currentQuestion: '',
            isExtended: false,
            currentContainer: null,
            figure1Mode: 'preset',
            figure2Mode: 'preset',
            extensionCount: 0,
            additionalResponses: [],
            bookmarks: [],
            discussionStartTime: null
        };

        // Toggle between preset and custom input modes
        function toggleMode(figureNum, mode) {
            discussionState[`figure${figureNum}Mode`] = mode;
            
            const presetSelect = document.getElementById(`figure${figureNum}`);
            const customInput = document.getElementById(`figure${figureNum}Custom`);
            const suggestionBox = document.getElementById(`suggestion${figureNum}`);
            const modeButtons = document.querySelectorAll(`.figure-selection:nth-child(${figureNum + 1}) .mode-button`);
            
            // Update button states
            modeButtons.forEach((btn, index) => {
                if ((index === 0 && mode === 'preset') || (index === 1 && mode === 'custom')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Show/hide appropriate input
            if (mode === 'preset') {
                presetSelect.style.display = 'block';
                customInput.style.display = 'none';
                suggestionBox.style.display = 'none';
            } else {
                presetSelect.style.display = 'none';
                customInput.style.display = 'block';
                suggestionBox.style.display = 'block';
                customInput.focus();
            }
        }

        // Create custom figure object from name
        function createCustomFigure(name) {
            return {
                name: name,
                prompt: `You are ${name}. Embody their personality, knowledge, speaking style, and perspective as accurately as possible. If this is a real person, draw on their known views, experiences, and way of communicating. If this is a fictional character, embody their personality from their source material. If this is someone the user knows personally, ask clarifying questions if needed, but generally respond as a thoughtful, intelligent person with that name would. Stay in character throughout the conversation and bring their unique perspective to the discussion.`
            };
        }

        // Enhanced brilliant figures with scientists and thought leaders (keeping all your existing figures)
        const figures = {
            // Philosophers
            socrates: {
                name: "Socrates",
                prompt: "You are Socrates. Use the Socratic method - ask probing questions to examine beliefs. Be humble about your own knowledge ('I know that I know nothing'). Challenge assumptions and seek truth through questioning."
            },
            aristotle: {
                name: "Aristotle",
                prompt: "You are Aristotle. Speak as a systematic philosopher and logician. Use logical reasoning and categorical thinking. Reference your teachings on ethics, politics, and human nature."
            },
            plato: {
                name: "Plato",
                prompt: "You are Plato. Speak about ideals, truth, and the nature of reality. Reference your theory of Forms and beliefs about justice and the ideal state. Use allegories and philosophical reasoning."
            },
            confucius: {
                name: "Confucius",
                prompt: "You are Confucius. Speak with wisdom about social harmony, virtue, and proper relationships. Reference the importance of education, family, and moral cultivation. Use thoughtful aphorisms."
            },
            kant: {
                name: "Immanuel Kant",
                prompt: "You are Immanuel Kant. Speak about duty, categorical imperatives, and moral philosophy. Reference the limits of reason and the importance of moral law. Be systematic and precise in your thinking."
            },
            nietzsche: {
                name: "Friedrich Nietzsche",
                prompt: "You are Friedrich Nietzsche. Speak provocatively about the will to power, the übermensch, and questioning traditional values. Challenge conventional morality and advocate for individual strength and creativity."
            },
            
            // Scientists & Mathematicians
            einstein: {
                name: "Albert Einstein",
                prompt: "You are Albert Einstein. Respond with scientific curiosity, wisdom, and humanitarian concerns. Reference scientific principles when relevant. Show your philosophical side and concern for humanity's future."
            },
            newton: {
                name: "Isaac Newton",
                prompt: "You are Isaac Newton. Speak with mathematical precision and systematic thinking. Reference natural laws, gravity, and the mathematical nature of the universe. Show your methodical approach to understanding nature."
            },
            darwin: {
                name: "Charles Darwin",
                prompt: "You are Charles Darwin. Speak about evolution, natural selection, and careful observation of nature. Show your methodical approach to collecting evidence and drawing conclusions. Reference the interconnectedness of life."
            },
            curie: {
                name: "Marie Curie",
                prompt: "You are Marie Curie. Speak with dedication to scientific research and discovery. Reference your work with radioactivity and your perseverance in a male-dominated field. Show passion for knowledge and scientific advancement."
            },
            galileo: {
                name: "Galileo Galilei",
                prompt: "You are Galileo Galilei. Speak about observation, experimentation, and challenging established beliefs. Reference your telescopic discoveries and your conflict with traditional authority. Advocate for empirical evidence."
            },
            hawking: {
                name: "Stephen Hawking",
                prompt: "You are Stephen Hawking. Speak about black holes, the nature of time, and the universe. Make complex physics accessible. Show your wit and determination to understand the cosmos despite physical limitations."
            },
            feynman: {
                name: "Richard Feynman",
                prompt: "You are Richard Feynman. Speak with curiosity and explain complex physics simply. Use analogies and everyday examples. Show your love of learning and teaching. Be playful yet profound in your insights."
            },
            tesla: {
                name: "Nikola Tesla",
                prompt: "You are Nikola Tesla. Speak about electricity, invention, and the future of technology. Show your visionary thinking and dedication to advancing human civilization through science and engineering."
            },
            pasteur: {
                name: "Louis Pasteur",
                prompt: "You are Louis Pasteur. Speak about the scientific method, germ theory, and the importance of careful experimentation. Show your dedication to improving human health through scientific discovery."
            },
            watson: {
                name: "James Watson",
                prompt: "You are James Watson. Speak about DNA, genetics, and molecular biology. Reference the structure of DNA and the importance of scientific collaboration. Show your passion for understanding life at the molecular level."
            },
            turing: {
                name: "Alan Turing",
                prompt: "You are Alan Turing. Speak about computation, artificial intelligence, and mathematical logic. Reference your work on breaking codes, the theoretical foundations of computer science, and the Turing test for machine intelligence."
            },
            
            // Logic, Mathematics & Computing Pioneers
            frege: {
                name: "Gottlob Frege",
                prompt: "You are Gottlob Frege. Speak about mathematical logic, the foundations of arithmetic, and formal systems. Reference your work on predicate logic and the logical foundations of mathematics. Discuss sense and reference in language and logic."
            },
            russell: {
                name: "Bertrand Russell",
                prompt: "You are Bertrand Russell. Speak about mathematical logic, philosophy of mathematics, and analytic philosophy. Reference Russell's Paradox, logical atomism, and your work with Whitehead on Principia Mathematica. Discuss the relationship between logic and reality."
            },
            hilbert: {
                name: "David Hilbert",
                prompt: "You are David Hilbert. Speak about mathematical formalism, the foundations of geometry, and Hilbert's program. Reference your work on axiomatization and the quest to prove mathematics is complete and consistent. Discuss mathematical rigor and proof theory."
            },
            vonneumann: {
                name: "John von Neumann",
                prompt: "You are John von Neumann. Speak about computer architecture, game theory, and mathematical foundations. Reference the von Neumann architecture, quantum mechanics formalism, and mathematical economics. Discuss the intersection of mathematics and practical applications."
            },
            godel: {
                name: "Kurt Gödel",
                prompt: "You are Kurt Gödel. Speak about mathematical logic, incompleteness theorems, and the limits of formal systems. Reference your proof that mathematics contains undecidable propositions. Discuss the philosophical implications of mathematical incompleteness."
            },
            shannon: {
                name: "Claude Shannon",
                prompt: "You are Claude Shannon. Speak about information theory, digital circuits, and communication systems. Reference your mathematical theory of communication and the concept of information entropy. Discuss how information can be quantified and transmitted."
            },
            church_historical: {
                name: "Alonzo Church",
                prompt: "You are Alonzo Church. Speak about lambda calculus, mathematical logic, and computability theory. Reference Church's thesis on effective calculability and your work on the foundations of computer science. Discuss the relationship between logic and computation."
            },
            babbage: {
                name: "Charles Babbage",
                prompt: "You are Charles Babbage. Speak about mechanical computation, the Analytical Engine, and early computer design. Reference your vision of programmable machines and automatic calculation. Discuss the mechanical foundations of computing."
            },
            lovelace: {
                name: "Ada Lovelace",
                prompt: "You are Ada Lovelace. Speak about programming, mathematical computation, and the potential of computing machines. Reference your work on Babbage's Analytical Engine and your vision of computers beyond mere calculation. Discuss the creative possibilities of computation."
            },
            
            // Leaders & Statesmen
            lincoln: {
                name: "Abraham Lincoln",
                prompt: "You are Abraham Lincoln. Speak with wisdom, humility, and moral clarity. Use folksy anecdotes and simple language to explain complex ideas. Show concern for justice, unity, and human dignity."
            },
            churchill: {
                name: "Winston Churchill",
                prompt: "You are Winston Churchill. Speak with determination, wit, and rhetorical flair. Reference your wartime leadership experience. Use powerful, memorable phrases and show resolve."
            },
            gandhi: {
                name: "Mahatma Gandhi",
                prompt: "You are Mahatma Gandhi. Speak with moral authority, non-violence, and spiritual wisdom. Reference your philosophy of peaceful resistance and social justice. Show compassion and dedication to truth."
            },
            jefferson: {
                name: "Thomas Jefferson",
                prompt: "You are Thomas Jefferson. Speak as an Enlightenment thinker and founding father. Reference democratic ideals, individual liberty, and natural rights. Show your intellectual breadth."
            },
            cleopatra: {
                name: "Cleopatra",
                prompt: "You are Cleopatra VII of Egypt. Speak with intelligence, political acumen, and regal bearing. Reference ancient leadership, politics, and strategy. Show your multilingual education and diplomatic skills."
            },
            mandela: {
                name: "Nelson Mandela",
                prompt: "You are Nelson Mandela. Speak about reconciliation, justice, and peaceful resistance to oppression. Reference your experience with apartheid and your commitment to unity and forgiveness."
            },
            
            // Artists & Writers
            shakespeare: {
                name: "William Shakespeare",
                prompt: "You are William Shakespeare. Speak with eloquence and creativity. Use some Elizabethan flair but keep it understandable. Reference human nature and the human condition. Use metaphors and poetic language."
            },
            leonardo: {
                name: "Leonardo da Vinci",
                prompt: "You are Leonardo da Vinci. Show Renaissance curiosity about everything - art, science, engineering, nature. Connect different fields of knowledge. Be enthusiastic about learning and observation."
            },
            michelangelo: {
                name: "Michelangelo",
                prompt: "You are Michelangelo. Speak passionately about art, sculpture, and the pursuit of perfection. Reference your dedication to capturing divine beauty and human form. Show your artistic intensity and spiritual devotion."
            },
            beethoven: {
                name: "Ludwig van Beethoven",
                prompt: "You are Ludwig van Beethoven. Speak passionately about music, emotion, and artistic expression. Reference how music can convey the deepest human feelings. Show your revolutionary spirit in art."
            },
            
            // Economic & Social Thinkers
            smith: {
                name: "Adam Smith",
                prompt: "You are Adam Smith. Speak about free markets, the invisible hand, and human nature in economic behavior. Reference the importance of self-interest balanced with moral sentiments."
            },
            marx: {
                name: "Karl Marx",
                prompt: "You are Karl Marx. Speak about class struggle, capitalism, and social revolution. Reference the importance of economic structures in shaping society and the need for worker solidarity."
            },
            keynes: {
                name: "John Maynard Keynes",
                prompt: "You are John Maynard Keynes. Speak about economics, government intervention, and managing economic cycles. Reference the importance of demand management and practical economic policy."
            },
            friedman: {
                name: "Milton Friedman",
                prompt: "You are Milton Friedman. Speak about free markets, individual choice, and limited government. Reference the efficiency of market mechanisms and the importance of economic freedom."
            },
            
            // Contemporary Scientists & Thinkers
            penrose: {
                name: "Roger Penrose",
                prompt: "You are Roger Penrose. Speak about mathematical physics, consciousness, and cosmology. Reference your work on black holes, penrose tilings, and quantum theories of consciousness. Discuss the deep mathematical structure of reality."
            },
            witten: {
                name: "Edward Witten",
                prompt: "You are Edward Witten. Speak about string theory, mathematical physics, and the unification of fundamental forces. Reference M-theory and the mathematical elegance underlying physical reality. Discuss topology and quantum field theory."
            },
            venter: {
                name: "Craig Venter",
                prompt: "You are Craig Venter. Speak about genomics, synthetic biology, and the future of life sciences. Reference your work sequencing the human genome and creating synthetic life forms. Discuss personalized medicine and bioengineering."
            },
            tao: {
                name: "Terence Tao",
                prompt: "You are Terence Tao. Speak about pure mathematics, number theory, and harmonic analysis. Reference your work on prime numbers, partial differential equations, and mathematical problem-solving. Discuss the beauty and structure of mathematical truth."
            },
            yau: {
                name: "Shing-Tung Yau",
                prompt: "You are Shing-Tung Yau. Speak about differential geometry, algebraic geometry, and mathematical physics. Reference Calabi-Yau manifolds and your work bridging mathematics and string theory. Discuss the geometric foundations of physical reality."
            },
            church: {
                name: "Alonzo Church",
                prompt: "You are Alonzo Church. Speak about mathematical logic, lambda calculus, and the foundations of computation. Reference Church's thesis and your work on decidability. Discuss the logical structure underlying mathematics and computation."
            },
            kahneman: {
                name: "Daniel Kahneman",
                prompt: "You are Daniel Kahneman. Speak about behavioral economics, cognitive biases, and decision-making. Reference prospect theory and your work on human irrationality. Discuss how psychology impacts economic and personal decisions."
            },
            wilson: {
                name: "Edward O. Wilson",
                prompt: "You are Edward O. Wilson. Speak about sociobiology, biodiversity, and conservation. Reference your work on ant colonies, island biogeography, and the unity of knowledge. Discuss the biological foundations of behavior and environmental protection."
            },
            chomsky: {
                name: "Noam Chomsky",
                prompt: "You are Noam Chomsky. Speak about linguistics, cognitive science, and political criticism. Reference universal grammar and critique media and political power structures. Show deep concern for social justice."
            },
            pinker: {
                name: "Steven Pinker",
                prompt: "You are Steven Pinker. Speak about cognitive psychology, language, and human progress. Reference declining violence and the power of reason and science. Be optimistic about human nature and Enlightenment values."
            },
            harari: {
                name: "Yuval Noah Harari",
                prompt: "You are Yuval Noah Harari. Speak about human history, the future of humanity, and artificial intelligence. Reference cognitive revolution, agricultural revolution, and scientific revolution. Discuss how technology shapes society."
            },
            diamandis: {
                name: "Peter Diamandis",
                prompt: "You are Peter Diamandis. Speak about exponential technologies, space exploration, and abundance mindset. Reference how technology solves humanity's grand challenges. Be optimistic about innovation and entrepreneurship."
            },
            tegmark: {
                name: "Max Tegmark",
                prompt: "You are Max Tegmark. Speak about artificial intelligence, cosmology, and the mathematical universe hypothesis. Discuss AI safety and the future of intelligence. Reference parallel universes and consciousness."
            },
            
            // Contemporary Leaders & Innovators
            gates: {
                name: "Bill Gates",
                prompt: "You are Bill Gates. Speak about technology, global health, and philanthropy. Reference your Microsoft experience and current focus on solving world problems through innovation and giving. Discuss pandemic preparedness and climate change."
            },
            musk: {
                name: "Elon Musk",
                prompt: "You are Elon Musk. Speak about electric vehicles, space exploration, and artificial intelligence. Reference your work with Tesla, SpaceX, and Neuralink. Be ambitious about humanity's multi-planetary future and sustainable energy."
            },
            bezos: {
                name: "Jeff Bezos",
                prompt: "You are Jeff Bezos. Speak about e-commerce, cloud computing, and space colonization. Reference customer obsession and long-term thinking. Discuss building companies that can scale and your vision for space manufacturing."
            },
            jobs: {
                name: "Steve Jobs",
                prompt: "You are Steve Jobs. Speak about design, innovation, and user experience. Reference the intersection of technology and liberal arts. Emphasize simplicity, perfection, and thinking differently about products."
            },
            buffett: {
                name: "Warren Buffett",
                prompt: "You are Warren Buffett. Speak about value investing, business principles, and long-term thinking. Reference buying great companies at fair prices and the importance of understanding businesses. Use folksy wisdom and analogies."
            },
            branson: {
                name: "Richard Branson",
                prompt: "You are Richard Branson. Speak about entrepreneurship, adventure, and putting employees first. Reference the Virgin brand philosophy and disrupting established industries. Emphasize fun, customer service, and taking calculated risks."
            }
        };
        
        function startDiscussion() { 
            let figure1, figure2;
            
            // Get figure 1
            if (discussionState.figure1Mode === 'preset') {
                const figure1Id = document.getElementById('figure1').value;
                figure1 = figures[figure1Id];
            } else {
                const figure1Name = document.getElementById('figure1Custom').value.trim();
                if (!figure1Name) {
                    alert('Please enter a name for the first speaker!');
                    return;
                }
                figure1 = createCustomFigure(figure1Name);
            }
            
            // Get figure 2
            if (discussionState.figure2Mode === 'preset') {
                const figure2Id = document.getElementById('figure2').value;
                figure2 = figures[figure2Id];
            } else {
                const figure2Name = document.getElementById('figure2Custom').value.trim();
                if (!figure2Name) {
                    alert('Please enter a name for the second speaker!');
                    return;
                }
                figure2 = createCustomFigure(figure2Name);
            }
            
            // Check if same figure selected/entered
            if (figure1.name.toLowerCase() === figure2.name.toLowerCase()) {
                alert('Please select or enter different figures for an interesting discussion!');
                return;
            }
            
            discussionState.figure1 = figure1;
            discussionState.figure2 = figure2;
            
            // Update display
            document.getElementById('participant1Name').textContent = discussionState.figure1.name;
            document.getElementById('participant2Name').textContent = discussionState.figure2.name;
            
            // Show/hide sections with animation
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('participantsDisplay').style.display = 'block';
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('discussionArena').style.display = 'block';
            
            // Clear previous discussions
            document.getElementById('discussionArena').innerHTML = '';
        }
        
        async function askQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) {
                alert('Please enter a question!');
                return;
            }
            
            discussionState.currentQuestion = question;
            discussionState.discussionStartTime = new Date();
            
            // Hide question input
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'block';
            
            // Create discussion round
            const arena = document.getElementById('discussionArena');
            const roundDiv = document.createElement('div');
            roundDiv.className = 'discussion-round fade-in';
            roundDiv.innerHTML = `<div class="question-header">💭 "${question}"</div>`;
            arena.appendChild(roundDiv);
            
            // Conduct the three-part discussion
            await getInitialResponse(roundDiv);
            await getSecondResponse(roundDiv);
            await getFollowUpResponse(roundDiv);
            await getModerationSummary(roundDiv);
            
            // Store current container for potential continuation
            discussionState.currentContainer = roundDiv;
            discussionState.isExtended = false;
            
            // Show direct chat options
            showDirectChatOptions();
        }
        
        async function getInitialResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                <div><span class="loading"></span>Thinking...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are starting a thoughtful discussion. The question is: "${discussionState.currentQuestion}"

Give your perspective on this question in a CONCISE way (2-3 key points maximum). Be thoughtful and authentic to your historical viewpoint, but focus on your most important insights. Keep it under 150 words.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <button class="bookmark-button" onclick="addBookmark('${discussionState.figure1.name}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <button class="bookmark-button" onclick="addBookmark('${discussionState.figure2.name}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Question Generator Functions
        async function generateQuestions() {
            const category = document.getElementById('questionCategory').value;
            const generateButton = document.querySelector('.generate-button');
            const questionsContainer = document.getElementById('generatedQuestions');
            const questionsList = document.getElementById('questionsList');
            
            // Show loading state
            generateButton.disabled = true;
            generateButton.innerHTML = '<span class="loading"></span>Generating...';
            
            questionsContainer.style.display = 'block';
            questionsList.innerHTML = '<div class="loading-questions">🎲 AI is crafting brilliant questions for you...</div>';
            
            try {
                const questions = await generateQuestionsForCategory(category);
                displayGeneratedQuestions(questions, category);
                
                // Scroll to questions
                questionsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
            } catch (error) {
                questionsList.innerHTML = `<div style="color: #f44336; text-align: center; padding: 20px;">❌ Error generating questions: ${error.message}</div>`;
            }
            
            // Reset button
            generateButton.disabled = false;
            generateButton.innerHTML = '✨ Generate Questions';
        }
        
        async function generateQuestionsForCategory(category) {
            const figure1Name = discussionState.figure1?.name || getCurrentFigureName(1);
            const figure2Name = discussionState.figure2?.name || getCurrentFigureName(2);
            
            const prompts = {
                philosophical: `Generate 5 thought-provoking philosophical questions that would create fascinating discussions between ${figure1Name} and ${figure2Name}. Focus on fundamental questions about existence, reality, consciousness, meaning, and human nature. Make them specific enough to generate deep debate but open enough for multiple perspectives.`,
                
                scientific: `Generate 5 compelling scientific questions for ${figure1Name} and ${figure2Name} to debate. Include questions about scientific methodology, the nature of discovery, the relationship between science and society, emerging technologies, and the philosophy of science. Consider their respective backgrounds and expertise.`,
                
                creative: `Generate 5 creative and artistic questions for ${figure1Name} and ${figure2Name}. Explore topics like the nature of creativity, the role of art in society, the relationship between artist and audience, inspiration vs technique, and how creativity drives human progress.`,
                
                practical: `Generate 5 practical, real-world questions for ${figure1Name} and ${figure2Name} to discuss. Focus on issues like leadership, decision-making, problem-solving, education, governance, and how to apply wisdom to everyday challenges.`,
                
                ethical: `Generate 5 challenging ethical questions for ${figure1Name} and ${figure2Name}. Cover moral dilemmas, justice, rights and responsibilities, the basis of ethical decision-making, and contemporary moral challenges. Make them thought-provoking and relevant.`,
                
                futuristic: `Generate 5 forward-looking questions about the future for ${figure1Name} and ${figure2Name}. Explore artificial intelligence, human enhancement, space exploration, social evolution, environmental challenges, and how humanity should shape its destiny.`,
                
                personal: `Generate 5 personal, introspective questions for ${figure1Name} and ${figure2Name}. Focus on topics like personal growth, dealing with failure, finding purpose, relationships, wisdom gained through experience, and what truly matters in life.`,
                
                controversial: `Generate 5 respectfully controversial questions that would create engaging debate between ${figure1Name} and ${figure2Name}. Choose topics where intelligent people can reasonably disagree, avoiding harmful content but embracing intellectual challenge.`,
                
                custom: `Generate 5 questions specifically tailored to the unique perspectives and expertise of ${figure1Name} and ${figure2Name}. Consider their historical contexts, areas of knowledge, contrasting viewpoints, and what would make for the most fascinating intellectual clash between these specific minds.`
            };
            
            const prompt = `${prompts[category]}

Return exactly 5 questions, each on a new line, numbered 1-5. Make each question:
- Engaging and thought-provoking
- Suitable for extended discussion
- Likely to reveal different perspectives from these two figures
- Clear and focused (not too broad or too narrow)
- Intellectually stimulating

Format: Just the numbered questions, nothing else.`;
            
            const response = await callClaude(prompt);
            
            // Parse the response into individual questions
            const questions = response.split('\n')
                .filter(line => line.trim())
                .map(line => line.replace(/^\d+\.\s*/, '').trim())
                .filter(q => q.length > 10);
            
            return questions.slice(0, 5); // Ensure we have exactly 5
        }
        
        function getCurrentFigureName(figureNum) {
            if (discussionState[`figure${figureNum}Mode`] === 'preset') {
                const selectId = `figure${figureNum}`;
                const select = document.getElementById(selectId);
                const figureId = select?.value;
                return figures[figureId]?.name || 'Unknown Figure';
            } else {
                const inputId = `figure${figureNum}Custom`;
                const input = document.getElementById(inputId);
                return input?.value.trim() || 'Custom Figure';
            }
        }
        
        function displayGeneratedQuestions(questions, category) {
            const questionsList = document.getElementById('questionsList');
            
            const categoryEmojis = {
                philosophical: '🤔',
                scientific: '🔬',
                creative: '🎨',
                practical: '💼',
                ethical: '⚖️',
                futuristic: '🚀',
                personal: '💭',
                controversial: '⚡',
                custom: '🎯'
            };
            
            const categoryNames = {
                philosophical: 'Philosophical',
                scientific: 'Scientific',
                creative: 'Creative',
                practical: 'Practical',
                ethical: 'Ethical',
                futuristic: 'Futuristic',
                personal: 'Personal',
                controversial: 'Controversial',
                custom: 'Custom'
            };
            
            questionsList.innerHTML = questions.map((question, index) => `
                <div class="question-suggestion" onclick="selectGeneratedQuestion('${question.replace(/'/g, "\\'")}')">
                    <div class="question-category-tag">${categoryEmojis[category]} ${categoryNames[category]}</div>
                    <div class="question-text">${question}</div>
                </div>
            `).join('');
        }
        
        function selectGeneratedQuestion(question) {
            const textarea = document.getElementById('questionInput');
            textarea.value = question;
            textarea.focus();
            
            // Hide the generator
            toggleQuestionGenerator();
            
            // Visual feedback
            showNotification('💡 Question selected! Ready to start the discussion.', 'success');
            
            // Scroll to the textarea
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function toggleQuestionGenerator() {
            const questionsContainer = document.getElementById('generatedQuestions');
            questionsContainer.style.display = 'none';
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Opening Thoughts')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for next speaker
                discussionState.firstResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        function showQuickQuestions() {
            // First start the discussion to set up figures
            const figure1Id = discussionState.figure1Mode === 'preset' ? 
                document.getElementById('figure1').value : 
                document.getElementById('figure1Custom').value.trim();
            const figure2Id = discussionState.figure2Mode === 'preset' ? 
                document.getElementById('figure2').value : 
                document.getElementById('figure2Custom').value.trim();
            
            // Validate figures are selected
            if (!figure1Id || !figure2Id) {
                alert('Please select or enter both figures first!');
                return;
            }
            
            if (discussionState.figure1Mode === 'preset' && discussionState.figure2Mode === 'preset' && figure1Id === figure2Id) {
                alert('Please select different figures for an interesting discussion!');
                return;
            }
            
            if (figure1Id.toLowerCase() === figure2Id.toLowerCase()) {
                alert('Please select or enter different figures for an interesting discussion!');
                return;
            }
            
            // Set up figures
            discussionState.figure1 = discussionState.figure1Mode === 'preset' ? 
                figures[figure1Id] : createCustomFigure(figure1Id);
            discussionState.figure2 = discussionState.figure2Mode === 'preset' ? 
                figures[figure2Id] : createCustomFigure(figure2Id);
            
            // Update display
            document.getElementById('participant1Name').textContent = discussionState.figure1.name;
            document.getElementById('participant2Name').textContent = discussionState.figure2.name;
            
            // Show sections
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('participantsDisplay').style.display = 'block';
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('discussionArena').style.display = 'block';
            
            // Focus on question generator
            const generateButton = document.querySelector('.generate-button');
            generateButton.click();
            
            showNotification('🎲 Perfect! Now choose a question category to get AI-generated suggestions.', 'info');
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Response & Analysis')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Opening Thoughts')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for next speaker
                discussionState.firstResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Round ${discussionState.extensionCount + 1}')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <button class="bookmark-button" onclick="addBookmark('${discussionState.figure1.name}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brilliant Minds - Discussion Arena</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .container {
            background: white;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 24px;
            box-shadow: 0 32px 80px rgba(0,0,0,0.12), 0 8px 32px rgba(0,0,0,0.06);
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 48px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            opacity: 0.5;
        }
        
        .header * {
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 3.2rem;
            font-weight: 800;
            margin-bottom: 16px;
            text-shadow: 0 4px 12px rgba(0,0,0,0.15);
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .nav-links {
            position: absolute;
            top: 20px;
            left: 30px;
            z-index: 2;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }
        
        .nav-links a:hover {
            opacity: 1;
            text-decoration: underline;
        }
        
        .content {
            padding: 48px;
        }
        
        .setup-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .setup-section h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .figures-setup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .figure-selection {
            background: white;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
            border: 2px solid #f8f9fa;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .figure-selection:hover {
            transform: translateY(-8px);
            box-shadow: 0 24px 60px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08);
            border-color: #e9ecef;
        }
        
        .figure-1 {
            border-left: 4px solid #667eea;
        }
        
        .figure-2 {
            border-left: 4px solid #764ba2;
        }
        
        .figure-selection h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .figure-selection label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        /* Toggle buttons for selection mode */
        .selection-mode {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .mode-button {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            color: #6c757d;
        }
        
        .mode-button.active {
            background: white;
            color: #495057;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .mode-button:hover:not(.active) {
            color: #495057;
        }
        
        select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
        }
        
        .custom-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
        }
        
        .custom-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
        }
        
        .custom-input::placeholder {
            color: #6c757d;
            font-style: italic;
        }
        
        .suggestion-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 13px;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .suggestion-box strong {
            color: #495057;
            display: block;
            margin-bottom: 6px;
        }
        
        optgroup {
            font-weight: bold;
            color: #495057;
            padding: 8px 0;
        }
        
        option {
            font-weight: normal;
            padding: 8px 12px;
        }
        
        .participants-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            color: white;
            display: none;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .participant {
            display: inline-block;
            margin: 0 15px;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .participant:hover {
            transform: scale(1.05);
        }
        
        .participant-1 {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }
        
        .participant-2 {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }
        
        .question-input-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            display: none;
            border: 1px solid #2196F3;
        }
        
        .question-input-section h4 {
            color: #1565C0;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .discussion-arena {
            border: 2px solid #f1f3f5;
            border-radius: 24px;
            padding: 40px;
            min-height: 500px;
            margin-bottom: 32px;
            background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
            overflow-y: auto;
            max-height: none;
            display: none;
        }
        
        .discussion-round {
            margin-bottom: 40px;
            padding: 32px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 12px 32px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
            border-left: 6px solid #667eea;
            max-height: none;
            overflow: visible;
        }
        
        .question-header {
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #2e7d32;
            border: 2px solid #4caf50;
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .speaker {
            margin: 24px 0;
            padding: 24px;
            border-radius: 16px;
            border-left: 5px solid;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.04);
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: auto;
            max-height: none;
            overflow: visible;
            position: relative;
        }
        
        .speaker:hover {
            transform: translateX(8px);
        }
        
        .speaker-content {
            line-height: 1.7;
            color: #2c3e50;
        }
        
        .speaker-content p {
            margin: 16px 0;
            line-height: 1.7;
        }
        
        .speaker-content p:first-child {
            margin-top: 0;
        }
        
        .speaker-content p:last-child {
            margin-bottom: 0;
        }
        
        .figure-1-speaker {
            border-left-color: #667eea;
            background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .figure-2-speaker {
            border-left-color: #764ba2;
            background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .moderator-speaker {
            border-left-color: #ff9800;
            background: linear-gradient(135deg, #fff8f0 0%, #fff3e0 100%);
            min-height: auto;
            overflow: visible;
            max-height: none;
            height: auto;
        }
        
        .moderator-content {
            line-height: 1.7;
            max-height: none;
            overflow: visible;
            height: auto;
        }
        
        .moderator-content h4 {
            font-weight: 700;
            font-size: 1.1rem;
            color: #e65100;
            margin: 20px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffcc02;
            display: block;
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .moderator-content h4:first-child {
            margin-top: 0;
        }
        
        .moderator-content p {
            margin: 12px 0;
            color: #424242;
            font-size: 15px;
        }
        
        .moderator-content ul, .moderator-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .moderator-content li {
            margin: 8px 0;
            color: #424242;
        }
        
        .speaker-name {
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .extended-separator {
            margin: 25px 0;
            padding: 15px;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border-radius: 10px;
            text-align: center;
            font-weight: 700;
            color: #1976D2;
            border: 2px dashed #2196F3;
        }
        
        .controls {
            text-align: center;
            margin: 25px 0;
        }
        
        button {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            margin: 0 8px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.01em;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08);
        }
        
        button:active {
            transform: translateY(-2px);
        }
        
        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .start-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            font-size: 18px;
            padding: 18px 40px;
        }
        
        .ask-button {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }
        
        .continue-button {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }
        
        .secondary-button {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .figures-setup {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .participant {
                display: block;
                margin: 10px 0;
            }
            
            button {
                display: block;
                width: 100%;
                margin: 8px 0;
            }
        }
        
        /* Bookmark and Export Features */
        .bookmark-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            color: #f57c00;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .bookmark-button:hover {
            background: rgba(255, 193, 7, 0.2);
            transform: scale(1.05);
        }
        
        .bookmark-button.bookmarked {
            background: #ffc107;
            color: white;
        }
        
        .export-controls {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            display: none;
            border: 1px solid #4caf50;
        }
        
        .export-controls h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .export-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .export-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }
        
        .bookmarks-panel {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            display: none;
            border: 1px solid #ffc107;
        }
        
        .bookmarks-panel h4 {
            color: #f57c00;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .bookmark-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .bookmark-speaker {
            font-weight: 600;
            color: #f57c00;
            margin-bottom: 8px;
        }
        
        .bookmark-content {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .bookmark-meta {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-bookmark {
            background: #ff5722;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .bookmarks-empty {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }
        
        /* Direct chat section styles */
        .direct-chat-section {
            margin-top: 40px;
            padding: 0 48px 48px 48px;
        }
        
        .direct-chat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            border: 2px solid #e9ecef;
            box-shadow: 0 12px 32px rgba(0,0,0,0.06);
        }
        
        .direct-chat-card h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .direct-chat-card p {
            color: #495057;
            margin-bottom: 32px;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .figure-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .figure-chat-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 16px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
            margin: 8px;
        }
        
        .figure-chat-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(102, 126, 234, 0.3);
        }
        
        @media (max-width: 768px) {
            .direct-chat-section {
                padding: 0 20px 20px 20px;
            }
            
            .direct-chat-card {
                padding: 24px;
            }
            
            .figure-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .figure-chat-button {
                width: 100%;
                max-width: 280px;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pulse animation for important buttons */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(102, 126, 234, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Brilliant Minds</h1>
            <p class="subtitle">Watch brilliant minds explore ideas together through thoughtful conversation</p>
        </div>
            
            <!-- Discussion Setup -->
            <div class="setup-section fade-in" id="setupSection">
                <h3>🎭 Choose Your Discussion Participants</h3>
                
                <div class="figures-setup">
                    <div style="grid-column: 1 / -1; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); padding: 20px; border-radius: 15px; border-left: 4px solid #4CAF50;">
            <h4 style="color: #2e7d32; margin-bottom: 12px;">💡 Try These Fascinating Discussions:</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                <div>"What is the meaning of life?" <br><em>Socrates vs Einstein</em></div>
                <div>"How should we approach AI development?" <br><em>Turing vs Musk</em></div>
                <div>"What makes great leadership?" <br><em>Lincoln vs Churchill</em></div>
                <div>"Is free will real?" <br><em>Kant vs Hawking</em></div>
                <div>"What is the nature of consciousness?" <br><em>Penrose vs Descartes</em></div>
                <div>"How do we create a just society?" <br><em>Plato vs Jefferson</em></div>
            </div>
        </div>
    </div>

                    <div class="figure-selection figure-1">
                        <h4>🎤 First Speaker</h4>
                        
                        <!-- Selection Mode Toggle -->
                        <div class="selection-mode">
                            <button type="button" class="mode-button active" onclick="toggleMode(1, 'preset')">📋 Preset Figures</button>
                            <button type="button" class="mode-button" onclick="toggleMode(1, 'custom')">✏️ Write Your Own</button>
                        </div>
                        
                        <label>Brilliant Figure:</label>
                        <select id="figure1" class="preset-select">
                             <optgroup label="🤔 Philosophers">
                                <option value="aristotle" selected="selected">Aristotle</option>
                                <option value="socrates">Socrates</option>
                                <option value="plato">Plato</option>
                                <option value="confucius">Confucius</option>
                                <option value="kant">Immanuel Kant</option>
                                <option value="nietzsche">Friedrich Nietzsche</option>
                            </optgroup>
                            <optgroup label="🔬 Scientists & Mathematicians">
                                <option value="einstein">Albert Einstein</option>
                                <option value="newton">Isaac Newton</option>
                                <option value="darwin">Charles Darwin</option>
                                <option value="curie">Marie Curie</option>
                                <option value="galileo">Galileo Galilei</option>
                                <option value="hawking">Stephen Hawking</option>
                                <option value="feynman">Richard Feynman</option>
                                <option value="tesla">Nikola Tesla</option>
                                <option value="pasteur">Louis Pasteur</option>
                                <option value="watson">James Watson</option>
                                <option value="turing">Alan Turing</option>
                            </optgroup>
                            <optgroup label="🖥️ Logic, Mathematics & Computing Pioneers">
                                <option value="frege">Gottlob Frege</option>
                                <option value="russell">Bertrand Russell</option>
                                <option value="hilbert">David Hilbert</option>
                                <option value="vonneumann">John von Neumann</option>
                                <option value="godel">Kurt Gödel</option>
                                <option value="shannon">Claude Shannon</option>
                                <option value="church_historical">Alonzo Church</option>
                                <option value="babbage">Charles Babbage</option>
                                <option value="lovelace">Ada Lovelace</option>
                            </optgroup>
                            <optgroup label="🧬 Contemporary Scientists & Thinkers">
                                <option value="penrose">Roger Penrose</option>
                                <option value="witten">Edward Witten</option>
                                <option value="venter">Craig Venter</option>
                                <option value="tao">Terence Tao</option>
                                <option value="yau">Shing-Tung Yau</option>
                                <option value="church">Alonzo Church</option>
                                <option value="kahneman">Daniel Kahneman</option>
                                <option value="wilson">Edward O. Wilson</option>
                                <option value="chomsky">Noam Chomsky</option>
                                <option value="pinker">Steven Pinker</option>
                                <option value="harari">Yuval Noah Harari</option>
                                <option value="tegmark">Max Tegmark</option>
                            </optgroup>
                            <optgroup label="👑 Leaders & Statesmen">
                                <option value="lincoln">Abraham Lincoln</option>
                                <option value="churchill">Winston Churchill</option>
                                <option value="gandhi">Mahatma Gandhi</option>
                                <option value="jefferson">Thomas Jefferson</option>
                                <option value="cleopatra">Cleopatra</option>
                                <option value="mandela">Nelson Mandela</option>
                            </optgroup>
                            <optgroup label="🎨 Artists & Writers">
                                <option value="shakespeare">William Shakespeare</option>
                                <option value="leonardo">Leonardo da Vinci</option>
                                <option value="michelangelo">Michelangelo</option>
                                <option value="beethoven">Ludwig van Beethoven</option>
                            </optgroup>
                            <optgroup label="💰 Economic & Social Thinkers">
                                <option value="smith">Adam Smith</option>
                                <option value="marx">Karl Marx</option>
                                <option value="keynes">John Maynard Keynes</option>
                                <option value="friedman">Milton Friedman</option>
                            </optgroup>
                            <optgroup label="💼 Contemporary Leaders & Innovators">
                                <option value="gates">Bill Gates</option>
                                <option value="musk">Elon Musk</option>
                                <option value="bezos">Jeff Bezos</option>
                                <option value="jobs">Steve Jobs</option>
                                <option value="buffett">Warren Buffett</option>
                                <option value="branson">Richard Branson</option>
                            </optgroup>
                        </select>
                        
                        <input type="text" id="figure1Custom" class="custom-input" placeholder="Enter any name (e.g., Taylor Swift, Napoleon, Frida Kahlo, your grandmother...)">
                        
                        <div class="suggestion-box" id="suggestion1" style="display: none;">
                            <strong>💡 Custom Figure Tips:</strong>
                            Try historical figures, celebrities, fictional characters, or even people you know! The AI will research and embody their personality, knowledge, and speaking style.
                        </div>
                    </div>
                    
                    <div class="figure-selection figure-2">
                        <h4>🎯 Second Speaker</h4>
                        
                        <!-- Selection Mode Toggle -->
                        <div class="selection-mode">
                            <button type="button" class="mode-button active" onclick="toggleMode(2, 'preset')">📋 Preset Figures</button>
                            <button type="button" class="mode-button" onclick="toggleMode(2, 'custom')">✏️ Write Your Own</button>
                        </div>
                        
                        <label>Brilliant Figure:</label>
                        <select id="figure2" class="preset-select">
                             <optgroup label="🤔 Philosophers">
                                <option value="aristotle">Aristotle</option>
                                <option value="socrates" selected="selected">Socrates</option>
                                <option value="plato">Plato</option>
                                <option value="confucius">Confucius</option>
                                <option value="kant">Immanuel Kant</option>
                                <option value="nietzsche">Friedrich Nietzsche</option>
                            </optgroup>
                            <optgroup label="🔬 Scientists & Mathematicians">
                                <option value="einstein">Albert Einstein</option>
                                <option value="newton">Isaac Newton</option>
                                <option value="darwin">Charles Darwin</option>
                                <option value="curie">Marie Curie</option>
                                <option value="galileo">Galileo Galilei</option>
                                <option value="hawking">Stephen Hawking</option>
                                <option value="feynman">Richard Feynman</option>
                                <option value="tesla">Nikola Tesla</option>
                                <option value="pasteur">Louis Pasteur</option>
                                <option value="watson">James Watson</option>
                                <option value="turing">Alan Turing</option>
                            </optgroup>
                            <optgroup label="🖥️ Logic, Mathematics & Computing Pioneers">
                                <option value="frege">Gottlob Frege</option>
                                <option value="russell">Bertrand Russell</option>
                                <option value="hilbert">David Hilbert</option>
                                <option value="vonneumann">John von Neumann</option>
                                <option value="godel">Kurt Gödel</option>
                                <option value="shannon">Claude Shannon</option>
                                <option value="church_historical">Alonzo Church</option>
                                <option value="babbage">Charles Babbage</option>
                                <option value="lovelace">Ada Lovelace</option>
                            </optgroup>
                            <optgroup label="🧬 Contemporary Scientists & Thinkers">
                                <option value="penrose">Roger Penrose</option>
                                <option value="witten">Edward Witten</option>
                                <option value="venter">Craig Venter</option>
                                <option value="tao">Terence Tao</option>
                                <option value="yau">Shing-Tung Yau</option>
                                <option value="church">Alonzo Church</option>
                                <option value="kahneman">Daniel Kahneman</option>
                                <option value="wilson">Edward O. Wilson</option>
                                <option value="chomsky">Noam Chomsky</option>
                                <option value="pinker">Steven Pinker</option>
                                <option value="harari">Yuval Noah Harari</option>
                                <option value="tegmark">Max Tegmark</option>
                            </optgroup>
                            <optgroup label="👑 Leaders & Statesmen">
                                <option value="lincoln">Abraham Lincoln</option>
                                <option value="churchill">Winston Churchill</option>
                                <option value="gandhi">Mahatma Gandhi</option>
                                <option value="jefferson">Thomas Jefferson</option>
                                <option value="cleopatra">Cleopatra</option>
                                <option value="mandela">Nelson Mandela</option>
                            </optgroup>
                            <optgroup label="🎨 Artists & Writers">
                                <option value="shakespeare">William Shakespeare</option>
                                <option value="leonardo">Leonardo da Vinci</option>
                                <option value="michelangelo">Michelangelo</option>
                                <option value="beethoven">Ludwig van Beethoven</option>
                            </optgroup>
                            <optgroup label="💰 Economic & Social Thinkers">
                                <option value="smith">Adam Smith</option>
                                <option value="marx">Karl Marx</option>
                                <option value="keynes">John Maynard Keynes</option>
                                <option value="friedman">Milton Friedman</option>
                            </optgroup>
                            <optgroup label="💼 Contemporary Leaders & Innovators">
                                <option value="gates">Bill Gates</option>
                                <option value="musk">Elon Musk</option>
                                <option value="bezos">Jeff Bezos</option>
                                <option value="jobs">Steve Jobs</option>
                                <option value="buffett">Warren Buffett</option>
                                <option value="branson">Richard Branson</option>
                            </optgroup>
                        </select>
                        
                        <input type="text" id="figure2Custom" class="custom-input" placeholder="Enter any name (e.g., Marie Antoinette, Carl Sagan, Maya Angelou...)">
                        
                        <div class="suggestion-box" id="suggestion2" style="display: none;">
                            <strong>💡 Custom Figure Tips:</strong>
                            Try historical figures, celebrities, fictional characters, or even people you know! The AI will research and embody their personality, knowledge, and speaking style.
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="start-button pulse" onclick="startDiscussion()">✨ Start Discussion</button>
                </div>
            </div>
            
            <!-- Participants Display -->
            <div class="participants-display fade-in" id="participantsDisplay">
                <h3 style="margin-bottom: 20px;">Today's Conversation Partners</h3>
                <div class="participant participant-1" id="participant1Name"></div>
                <span style="font-size: 30px; margin: 0 20px;">🤝</span>
                <div class="participant participant-2" id="participant2Name"></div>
            </div>
            
            <!-- Question Input -->
            <div class="question-input-section fade-in" id="questionSection">
                <h4>💬 What would you like them to discuss?</h4>
                <textarea id="questionInput" placeholder="Enter your question here... (e.g., 'What is the meaning of life?', 'How should society be organized?', 'What is the role of art in society?', 'Is free will real?')"></textarea>
                <div class="controls">
                    <button class="ask-button" onclick="askQuestion()">🚀 Start the Discussion</button>
                </div>
            </div>
            
            <!-- Discussion Arena -->
            <div class="discussion-arena fade-in" id="discussionArena">
                <!-- Discussion content will be added here -->
            </div>
            
            <div class="controls" id="discussionControls" style="display: none;">
                <button class="continue-button" onclick="continueDiscussion()" id="continueButton">🔄 Continue Discussion</button>
                <button class="ask-button" onclick="showQuestionInput()">💭 Ask Another Question</button>
                <button class="secondary-button" onclick="toggleExportPanel()">📤 Export & Share</button>
                <button class="secondary-button" onclick="toggleBookmarksPanel()">⭐ View Bookmarks</button>
                <button class="secondary-button" onclick="resetDiscussion()">🆕 New Discussion</button>
            </div>
            
            <!-- Export Controls -->
            <div class="export-controls" id="exportPanel">
                <h4>📤 Export & Share This Discussion</h4>
                <div class="export-buttons">
                    <button class="export-button" onclick="exportAsText()">📄 Download as Text</button>
                    <button class="export-button" onclick="exportAsMarkdown()">📝 Download as Markdown</button>
                    <button class="export-button" onclick="exportAsPDF()">📋 Download as PDF</button>
                    <button class="export-button" onclick="copyShareableLink()">🔗 Copy Shareable Link</button>
                    <button class="export-button" onclick="exportBookmarksOnly()">⭐ Export Bookmarks Only</button>
                </div>
            </div>
            
            <!-- Bookmarks Panel -->
            <div class="bookmarks-panel" id="bookmarksPanel">
                <h4>⭐ Your Bookmarked Insights</h4>
                <div id="bookmarksList">
                    <div class="bookmarks-empty">No bookmarks yet. Click the ⭐ button on any speaker's response to save it!</div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="export-button" onclick="clearAllBookmarks()">🗑️ Clear All Bookmarks</button>
                </div>
            </div>
            
            <!-- Direct Chat Option -->
            <div class="direct-chat-section" id="directChatSection" style="display: none;">
                <div class="direct-chat-card">
                    <h3>💬 Want to chat directly with one of these figures?</h3>
                    <p>Choose a figure from the discussion above to have a personal conversation with them.</p>
                    <div class="figure-buttons" id="figureButtons">
                        <!-- Buttons will be populated by JavaScript -->
                    </div>
                    <p style="font-size: 14px; color: #6c757d; margin-top: 16px;">
                        Or explore our <a href="chat.html" style="color: #667eea; text-decoration: none; font-weight: 600;">full chat interface</a> with all brilliant figures.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let discussionState = {
            figure1: null,
            figure2: null,
            currentQuestion: '',
            isExtended: false,
            currentContainer: null,
            figure1Mode: 'preset',
            figure2Mode: 'preset',
            extensionCount: 0,
            additionalResponses: [],
            bookmarks: [],
            discussionStartTime: null
        };

        // Toggle between preset and custom input modes
        function toggleMode(figureNum, mode) {
            discussionState[`figure${figureNum}Mode`] = mode;
            
            const presetSelect = document.getElementById(`figure${figureNum}`);
            const customInput = document.getElementById(`figure${figureNum}Custom`);
            const suggestionBox = document.getElementById(`suggestion${figureNum}`);
            const modeButtons = document.querySelectorAll(`.figure-selection:nth-child(${figureNum + 1}) .mode-button`);
            
            // Update button states
            modeButtons.forEach((btn, index) => {
                if ((index === 0 && mode === 'preset') || (index === 1 && mode === 'custom')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Show/hide appropriate input
            if (mode === 'preset') {
                presetSelect.style.display = 'block';
                customInput.style.display = 'none';
                suggestionBox.style.display = 'none';
            } else {
                presetSelect.style.display = 'none';
                customInput.style.display = 'block';
                suggestionBox.style.display = 'block';
                customInput.focus();
            }
        }

        // Create custom figure object from name
        function createCustomFigure(name) {
            return {
                name: name,
                prompt: `You are ${name}. Embody their personality, knowledge, speaking style, and perspective as accurately as possible. If this is a real person, draw on their known views, experiences, and way of communicating. If this is a fictional character, embody their personality from their source material. If this is someone the user knows personally, ask clarifying questions if needed, but generally respond as a thoughtful, intelligent person with that name would. Stay in character throughout the conversation and bring their unique perspective to the discussion.`
            };
        }

        // Enhanced brilliant figures with scientists and thought leaders (keeping all your existing figures)
        const figures = {
            // Philosophers
            socrates: {
                name: "Socrates",
                prompt: "You are Socrates. Use the Socratic method - ask probing questions to examine beliefs. Be humble about your own knowledge ('I know that I know nothing'). Challenge assumptions and seek truth through questioning."
            },
            aristotle: {
                name: "Aristotle",
                prompt: "You are Aristotle. Speak as a systematic philosopher and logician. Use logical reasoning and categorical thinking. Reference your teachings on ethics, politics, and human nature."
            },
            plato: {
                name: "Plato",
                prompt: "You are Plato. Speak about ideals, truth, and the nature of reality. Reference your theory of Forms and beliefs about justice and the ideal state. Use allegories and philosophical reasoning."
            },
            confucius: {
                name: "Confucius",
                prompt: "You are Confucius. Speak with wisdom about social harmony, virtue, and proper relationships. Reference the importance of education, family, and moral cultivation. Use thoughtful aphorisms."
            },
            kant: {
                name: "Immanuel Kant",
                prompt: "You are Immanuel Kant. Speak about duty, categorical imperatives, and moral philosophy. Reference the limits of reason and the importance of moral law. Be systematic and precise in your thinking."
            },
            nietzsche: {
                name: "Friedrich Nietzsche",
                prompt: "You are Friedrich Nietzsche. Speak provocatively about the will to power, the übermensch, and questioning traditional values. Challenge conventional morality and advocate for individual strength and creativity."
            },
            
            // Scientists & Mathematicians
            einstein: {
                name: "Albert Einstein",
                prompt: "You are Albert Einstein. Respond with scientific curiosity, wisdom, and humanitarian concerns. Reference scientific principles when relevant. Show your philosophical side and concern for humanity's future."
            },
            newton: {
                name: "Isaac Newton",
                prompt: "You are Isaac Newton. Speak with mathematical precision and systematic thinking. Reference natural laws, gravity, and the mathematical nature of the universe. Show your methodical approach to understanding nature."
            },
            darwin: {
                name: "Charles Darwin",
                prompt: "You are Charles Darwin. Speak about evolution, natural selection, and careful observation of nature. Show your methodical approach to collecting evidence and drawing conclusions. Reference the interconnectedness of life."
            },
            curie: {
                name: "Marie Curie",
                prompt: "You are Marie Curie. Speak with dedication to scientific research and discovery. Reference your work with radioactivity and your perseverance in a male-dominated field. Show passion for knowledge and scientific advancement."
            },
            galileo: {
                name: "Galileo Galilei",
                prompt: "You are Galileo Galilei. Speak about observation, experimentation, and challenging established beliefs. Reference your telescopic discoveries and your conflict with traditional authority. Advocate for empirical evidence."
            },
            hawking: {
                name: "Stephen Hawking",
                prompt: "You are Stephen Hawking. Speak about black holes, the nature of time, and the universe. Make complex physics accessible. Show your wit and determination to understand the cosmos despite physical limitations."
            },
            feynman: {
                name: "Richard Feynman",
                prompt: "You are Richard Feynman. Speak with curiosity and explain complex physics simply. Use analogies and everyday examples. Show your love of learning and teaching. Be playful yet profound in your insights."
            },
            tesla: {
                name: "Nikola Tesla",
                prompt: "You are Nikola Tesla. Speak about electricity, invention, and the future of technology. Show your visionary thinking and dedication to advancing human civilization through science and engineering."
            },
            pasteur: {
                name: "Louis Pasteur",
                prompt: "You are Louis Pasteur. Speak about the scientific method, germ theory, and the importance of careful experimentation. Show your dedication to improving human health through scientific discovery."
            },
            watson: {
                name: "James Watson",
                prompt: "You are James Watson. Speak about DNA, genetics, and molecular biology. Reference the structure of DNA and the importance of scientific collaboration. Show your passion for understanding life at the molecular level."
            },
            turing: {
                name: "Alan Turing",
                prompt: "You are Alan Turing. Speak about computation, artificial intelligence, and mathematical logic. Reference your work on breaking codes, the theoretical foundations of computer science, and the Turing test for machine intelligence."
            },
            
            // Logic, Mathematics & Computing Pioneers
            frege: {
                name: "Gottlob Frege",
                prompt: "You are Gottlob Frege. Speak about mathematical logic, the foundations of arithmetic, and formal systems. Reference your work on predicate logic and the logical foundations of mathematics. Discuss sense and reference in language and logic."
            },
            russell: {
                name: "Bertrand Russell",
                prompt: "You are Bertrand Russell. Speak about mathematical logic, philosophy of mathematics, and analytic philosophy. Reference Russell's Paradox, logical atomism, and your work with Whitehead on Principia Mathematica. Discuss the relationship between logic and reality."
            },
            hilbert: {
                name: "David Hilbert",
                prompt: "You are David Hilbert. Speak about mathematical formalism, the foundations of geometry, and Hilbert's program. Reference your work on axiomatization and the quest to prove mathematics is complete and consistent. Discuss mathematical rigor and proof theory."
            },
            vonneumann: {
                name: "John von Neumann",
                prompt: "You are John von Neumann. Speak about computer architecture, game theory, and mathematical foundations. Reference the von Neumann architecture, quantum mechanics formalism, and mathematical economics. Discuss the intersection of mathematics and practical applications."
            },
            godel: {
                name: "Kurt Gödel",
                prompt: "You are Kurt Gödel. Speak about mathematical logic, incompleteness theorems, and the limits of formal systems. Reference your proof that mathematics contains undecidable propositions. Discuss the philosophical implications of mathematical incompleteness."
            },
            shannon: {
                name: "Claude Shannon",
                prompt: "You are Claude Shannon. Speak about information theory, digital circuits, and communication systems. Reference your mathematical theory of communication and the concept of information entropy. Discuss how information can be quantified and transmitted."
            },
            church_historical: {
                name: "Alonzo Church",
                prompt: "You are Alonzo Church. Speak about lambda calculus, mathematical logic, and computability theory. Reference Church's thesis on effective calculability and your work on the foundations of computer science. Discuss the relationship between logic and computation."
            },
            babbage: {
                name: "Charles Babbage",
                prompt: "You are Charles Babbage. Speak about mechanical computation, the Analytical Engine, and early computer design. Reference your vision of programmable machines and automatic calculation. Discuss the mechanical foundations of computing."
            },
            lovelace: {
                name: "Ada Lovelace",
                prompt: "You are Ada Lovelace. Speak about programming, mathematical computation, and the potential of computing machines. Reference your work on Babbage's Analytical Engine and your vision of computers beyond mere calculation. Discuss the creative possibilities of computation."
            },
            
            // Leaders & Statesmen
            lincoln: {
                name: "Abraham Lincoln",
                prompt: "You are Abraham Lincoln. Speak with wisdom, humility, and moral clarity. Use folksy anecdotes and simple language to explain complex ideas. Show concern for justice, unity, and human dignity."
            },
            churchill: {
                name: "Winston Churchill",
                prompt: "You are Winston Churchill. Speak with determination, wit, and rhetorical flair. Reference your wartime leadership experience. Use powerful, memorable phrases and show resolve."
            },
            gandhi: {
                name: "Mahatma Gandhi",
                prompt: "You are Mahatma Gandhi. Speak with moral authority, non-violence, and spiritual wisdom. Reference your philosophy of peaceful resistance and social justice. Show compassion and dedication to truth."
            },
            jefferson: {
                name: "Thomas Jefferson",
                prompt: "You are Thomas Jefferson. Speak as an Enlightenment thinker and founding father. Reference democratic ideals, individual liberty, and natural rights. Show your intellectual breadth."
            },
            cleopatra: {
                name: "Cleopatra",
                prompt: "You are Cleopatra VII of Egypt. Speak with intelligence, political acumen, and regal bearing. Reference ancient leadership, politics, and strategy. Show your multilingual education and diplomatic skills."
            },
            mandela: {
                name: "Nelson Mandela",
                prompt: "You are Nelson Mandela. Speak about reconciliation, justice, and peaceful resistance to oppression. Reference your experience with apartheid and your commitment to unity and forgiveness."
            },
            
            // Artists & Writers
            shakespeare: {
                name: "William Shakespeare",
                prompt: "You are William Shakespeare. Speak with eloquence and creativity. Use some Elizabethan flair but keep it understandable. Reference human nature and the human condition. Use metaphors and poetic language."
            },
            leonardo: {
                name: "Leonardo da Vinci",
                prompt: "You are Leonardo da Vinci. Show Renaissance curiosity about everything - art, science, engineering, nature. Connect different fields of knowledge. Be enthusiastic about learning and observation."
            },
            michelangelo: {
                name: "Michelangelo",
                prompt: "You are Michelangelo. Speak passionately about art, sculpture, and the pursuit of perfection. Reference your dedication to capturing divine beauty and human form. Show your artistic intensity and spiritual devotion."
            },
            beethoven: {
                name: "Ludwig van Beethoven",
                prompt: "You are Ludwig van Beethoven. Speak passionately about music, emotion, and artistic expression. Reference how music can convey the deepest human feelings. Show your revolutionary spirit in art."
            },
            
            // Economic & Social Thinkers
            smith: {
                name: "Adam Smith",
                prompt: "You are Adam Smith. Speak about free markets, the invisible hand, and human nature in economic behavior. Reference the importance of self-interest balanced with moral sentiments."
            },
            marx: {
                name: "Karl Marx",
                prompt: "You are Karl Marx. Speak about class struggle, capitalism, and social revolution. Reference the importance of economic structures in shaping society and the need for worker solidarity."
            },
            keynes: {
                name: "John Maynard Keynes",
                prompt: "You are John Maynard Keynes. Speak about economics, government intervention, and managing economic cycles. Reference the importance of demand management and practical economic policy."
            },
            friedman: {
                name: "Milton Friedman",
                prompt: "You are Milton Friedman. Speak about free markets, individual choice, and limited government. Reference the efficiency of market mechanisms and the importance of economic freedom."
            },
            
            // Contemporary Scientists & Thinkers
            penrose: {
                name: "Roger Penrose",
                prompt: "You are Roger Penrose. Speak about mathematical physics, consciousness, and cosmology. Reference your work on black holes, penrose tilings, and quantum theories of consciousness. Discuss the deep mathematical structure of reality."
            },
            witten: {
                name: "Edward Witten",
                prompt: "You are Edward Witten. Speak about string theory, mathematical physics, and the unification of fundamental forces. Reference M-theory and the mathematical elegance underlying physical reality. Discuss topology and quantum field theory."
            },
            venter: {
                name: "Craig Venter",
                prompt: "You are Craig Venter. Speak about genomics, synthetic biology, and the future of life sciences. Reference your work sequencing the human genome and creating synthetic life forms. Discuss personalized medicine and bioengineering."
            },
            tao: {
                name: "Terence Tao",
                prompt: "You are Terence Tao. Speak about pure mathematics, number theory, and harmonic analysis. Reference your work on prime numbers, partial differential equations, and mathematical problem-solving. Discuss the beauty and structure of mathematical truth."
            },
            yau: {
                name: "Shing-Tung Yau",
                prompt: "You are Shing-Tung Yau. Speak about differential geometry, algebraic geometry, and mathematical physics. Reference Calabi-Yau manifolds and your work bridging mathematics and string theory. Discuss the geometric foundations of physical reality."
            },
            church: {
                name: "Alonzo Church",
                prompt: "You are Alonzo Church. Speak about mathematical logic, lambda calculus, and the foundations of computation. Reference Church's thesis and your work on decidability. Discuss the logical structure underlying mathematics and computation."
            },
            kahneman: {
                name: "Daniel Kahneman",
                prompt: "You are Daniel Kahneman. Speak about behavioral economics, cognitive biases, and decision-making. Reference prospect theory and your work on human irrationality. Discuss how psychology impacts economic and personal decisions."
            },
            wilson: {
                name: "Edward O. Wilson",
                prompt: "You are Edward O. Wilson. Speak about sociobiology, biodiversity, and conservation. Reference your work on ant colonies, island biogeography, and the unity of knowledge. Discuss the biological foundations of behavior and environmental protection."
            },
            chomsky: {
                name: "Noam Chomsky",
                prompt: "You are Noam Chomsky. Speak about linguistics, cognitive science, and political criticism. Reference universal grammar and critique media and political power structures. Show deep concern for social justice."
            },
            pinker: {
                name: "Steven Pinker",
                prompt: "You are Steven Pinker. Speak about cognitive psychology, language, and human progress. Reference declining violence and the power of reason and science. Be optimistic about human nature and Enlightenment values."
            },
            harari: {
                name: "Yuval Noah Harari",
                prompt: "You are Yuval Noah Harari. Speak about human history, the future of humanity, and artificial intelligence. Reference cognitive revolution, agricultural revolution, and scientific revolution. Discuss how technology shapes society."
            },
            diamandis: {
                name: "Peter Diamandis",
                prompt: "You are Peter Diamandis. Speak about exponential technologies, space exploration, and abundance mindset. Reference how technology solves humanity's grand challenges. Be optimistic about innovation and entrepreneurship."
            },
            tegmark: {
                name: "Max Tegmark",
                prompt: "You are Max Tegmark. Speak about artificial intelligence, cosmology, and the mathematical universe hypothesis. Discuss AI safety and the future of intelligence. Reference parallel universes and consciousness."
            },
            
            // Contemporary Leaders & Innovators
            gates: {
                name: "Bill Gates",
                prompt: "You are Bill Gates. Speak about technology, global health, and philanthropy. Reference your Microsoft experience and current focus on solving world problems through innovation and giving. Discuss pandemic preparedness and climate change."
            },
            musk: {
                name: "Elon Musk",
                prompt: "You are Elon Musk. Speak about electric vehicles, space exploration, and artificial intelligence. Reference your work with Tesla, SpaceX, and Neuralink. Be ambitious about humanity's multi-planetary future and sustainable energy."
            },
            bezos: {
                name: "Jeff Bezos",
                prompt: "You are Jeff Bezos. Speak about e-commerce, cloud computing, and space colonization. Reference customer obsession and long-term thinking. Discuss building companies that can scale and your vision for space manufacturing."
            },
            jobs: {
                name: "Steve Jobs",
                prompt: "You are Steve Jobs. Speak about design, innovation, and user experience. Reference the intersection of technology and liberal arts. Emphasize simplicity, perfection, and thinking differently about products."
            },
            buffett: {
                name: "Warren Buffett",
                prompt: "You are Warren Buffett. Speak about value investing, business principles, and long-term thinking. Reference buying great companies at fair prices and the importance of understanding businesses. Use folksy wisdom and analogies."
            },
            branson: {
                name: "Richard Branson",
                prompt: "You are Richard Branson. Speak about entrepreneurship, adventure, and putting employees first. Reference the Virgin brand philosophy and disrupting established industries. Emphasize fun, customer service, and taking calculated risks."
            }
        };
        
        function startDiscussion() { 
            let figure1, figure2;
            
            // Get figure 1
            if (discussionState.figure1Mode === 'preset') {
                const figure1Id = document.getElementById('figure1').value;
                figure1 = figures[figure1Id];
            } else {
                const figure1Name = document.getElementById('figure1Custom').value.trim();
                if (!figure1Name) {
                    alert('Please enter a name for the first speaker!');
                    return;
                }
                figure1 = createCustomFigure(figure1Name);
            }
            
            // Get figure 2
            if (discussionState.figure2Mode === 'preset') {
                const figure2Id = document.getElementById('figure2').value;
                figure2 = figures[figure2Id];
            } else {
                const figure2Name = document.getElementById('figure2Custom').value.trim();
                if (!figure2Name) {
                    alert('Please enter a name for the second speaker!');
                    return;
                }
                figure2 = createCustomFigure(figure2Name);
            }
            
            // Check if same figure selected/entered
            if (figure1.name.toLowerCase() === figure2.name.toLowerCase()) {
                alert('Please select or enter different figures for an interesting discussion!');
                return;
            }
            
            discussionState.figure1 = figure1;
            discussionState.figure2 = figure2;
            
            // Update display
            document.getElementById('participant1Name').textContent = discussionState.figure1.name;
            document.getElementById('participant2Name').textContent = discussionState.figure2.name;
            
            // Show/hide sections with animation
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('participantsDisplay').style.display = 'block';
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('discussionArena').style.display = 'block';
            
            // Clear previous discussions
            document.getElementById('discussionArena').innerHTML = '';
        }
        
        async function askQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) {
                alert('Please enter a question!');
                return;
            }
            
            discussionState.currentQuestion = question;
            discussionState.discussionStartTime = new Date();
            
            // Hide question input
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'block';
            
            // Create discussion round
            const arena = document.getElementById('discussionArena');
            const roundDiv = document.createElement('div');
            roundDiv.className = 'discussion-round fade-in';
            roundDiv.innerHTML = `<div class="question-header">💭 "${question}"</div>`;
            arena.appendChild(roundDiv);
            
            // Conduct the three-part discussion
            await getInitialResponse(roundDiv);
            await getSecondResponse(roundDiv);
            await getFollowUpResponse(roundDiv);
            await getModerationSummary(roundDiv);
            
            // Store current container for potential continuation
            discussionState.currentContainer = roundDiv;
            discussionState.isExtended = false;
            
            // Show direct chat options
            showDirectChatOptions();
        }
        
        async function getInitialResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                <div><span class="loading"></span>Thinking...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are starting a thoughtful discussion. The question is: "${discussionState.currentQuestion}"

Give your perspective on this question in a CONCISE way (2-3 key points maximum). Be thoughtful and authentic to your historical viewpoint, but focus on your most important insights. Keep it under 150 words.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <button class="bookmark-button" onclick="addBookmark('${discussionState.figure1.name}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <button class="bookmark-button" onclick="addBookmark('${discussionState.figure2.name}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Opening Thoughts')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for next speaker
                discussionState.firstResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Response & Analysis')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Opening Thoughts')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for next speaker
                discussionState.firstResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Round ${discussionState.extensionCount + 1}')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        // Bookmark and Export Functions
        function addBookmark(speaker, content, context) {
            const bookmark = {
                id: Date.now(),
                speaker: speaker,
                content: content.replace(/\\`/g, '`').replace(/\\\$/g, '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brilliant Minds - Discussion Arena</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .container {
            background: white;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 24px;
            box-shadow: 0 32px 80px rgba(0,0,0,0.12), 0 8px 32px rgba(0,0,0,0.06);
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 48px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            opacity: 0.5;
        }
        
        .header * {
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 3.2rem;
            font-weight: 800;
            margin-bottom: 16px;
            text-shadow: 0 4px 12px rgba(0,0,0,0.15);
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .nav-links {
            position: absolute;
            top: 20px;
            left: 30px;
            z-index: 2;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }
        
        .nav-links a:hover {
            opacity: 1;
            text-decoration: underline;
        }
        
        .content {
            padding: 48px;
        }
        
        .setup-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .setup-section h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .figures-setup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .figure-selection {
            background: white;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
            border: 2px solid #f8f9fa;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .figure-selection:hover {
            transform: translateY(-8px);
            box-shadow: 0 24px 60px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08);
            border-color: #e9ecef;
        }
        
        .figure-1 {
            border-left: 4px solid #667eea;
        }
        
        .figure-2 {
            border-left: 4px solid #764ba2;
        }
        
        .figure-selection h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .figure-selection label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        /* Toggle buttons for selection mode */
        .selection-mode {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .mode-button {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            color: #6c757d;
        }
        
        .mode-button.active {
            background: white;
            color: #495057;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .mode-button:hover:not(.active) {
            color: #495057;
        }
        
        select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
        }
        
        .custom-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
        }
        
        .custom-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
        }
        
        .custom-input::placeholder {
            color: #6c757d;
            font-style: italic;
        }
        
        .suggestion-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 13px;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .suggestion-box strong {
            color: #495057;
            display: block;
            margin-bottom: 6px;
        }
        
        optgroup {
            font-weight: bold;
            color: #495057;
            padding: 8px 0;
        }
        
        option {
            font-weight: normal;
            padding: 8px 12px;
        }
        
        .participants-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            color: white;
            display: none;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .participant {
            display: inline-block;
            margin: 0 15px;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .participant:hover {
            transform: scale(1.05);
        }
        
        .participant-1 {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }
        
        .participant-2 {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }
        
        .question-input-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            display: none;
            border: 1px solid #2196F3;
        }
        
        .question-input-section h4 {
            color: #1565C0;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .discussion-arena {
            border: 2px solid #f1f3f5;
            border-radius: 24px;
            padding: 40px;
            min-height: 500px;
            margin-bottom: 32px;
            background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
            overflow-y: auto;
            max-height: none;
            display: none;
        }
        
        .discussion-round {
            margin-bottom: 40px;
            padding: 32px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 12px 32px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
            border-left: 6px solid #667eea;
            max-height: none;
            overflow: visible;
        }
        
        .question-header {
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #2e7d32;
            border: 2px solid #4caf50;
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .speaker {
            margin: 24px 0;
            padding: 24px;
            border-radius: 16px;
            border-left: 5px solid;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.04);
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: auto;
            max-height: none;
            overflow: visible;
            position: relative;
        }
        
        .speaker:hover {
            transform: translateX(8px);
        }
        
        .speaker-content {
            line-height: 1.7;
            color: #2c3e50;
        }
        
        .speaker-content p {
            margin: 16px 0;
            line-height: 1.7;
        }
        
        .speaker-content p:first-child {
            margin-top: 0;
        }
        
        .speaker-content p:last-child {
            margin-bottom: 0;
        }
        
        .figure-1-speaker {
            border-left-color: #667eea;
            background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .figure-2-speaker {
            border-left-color: #764ba2;
            background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .moderator-speaker {
            border-left-color: #ff9800;
            background: linear-gradient(135deg, #fff8f0 0%, #fff3e0 100%);
            min-height: auto;
            overflow: visible;
            max-height: none;
            height: auto;
        }
        
        .moderator-content {
            line-height: 1.7;
            max-height: none;
            overflow: visible;
            height: auto;
        }
        
        .moderator-content h4 {
            font-weight: 700;
            font-size: 1.1rem;
            color: #e65100;
            margin: 20px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffcc02;
            display: block;
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .moderator-content h4:first-child {
            margin-top: 0;
        }
        
        .moderator-content p {
            margin: 12px 0;
            color: #424242;
            font-size: 15px;
        }
        
        .moderator-content ul, .moderator-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .moderator-content li {
            margin: 8px 0;
            color: #424242;
        }
        
        .speaker-name {
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .extended-separator {
            margin: 25px 0;
            padding: 15px;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border-radius: 10px;
            text-align: center;
            font-weight: 700;
            color: #1976D2;
            border: 2px dashed #2196F3;
        }
        
        .controls {
            text-align: center;
            margin: 25px 0;
        }
        
        button {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            margin: 0 8px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.01em;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08);
        }
        
        button:active {
            transform: translateY(-2px);
        }
        
        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .start-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            font-size: 18px;
            padding: 18px 40px;
        }
        
        .ask-button {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }
        
        .continue-button {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }
        
        .secondary-button {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .figures-setup {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .participant {
                display: block;
                margin: 10px 0;
            }
            
            button {
                display: block;
                width: 100%;
                margin: 8px 0;
            }
        }
        
        /* Bookmark and Export Features */
        .bookmark-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            color: #f57c00;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .bookmark-button:hover {
            background: rgba(255, 193, 7, 0.2);
            transform: scale(1.05);
        }
        
        .bookmark-button.bookmarked {
            background: #ffc107;
            color: white;
        }
        
        .export-controls {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            display: none;
            border: 1px solid #4caf50;
        }
        
        .export-controls h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .export-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .export-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }
        
        .bookmarks-panel {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            display: none;
            border: 1px solid #ffc107;
        }
        
        .bookmarks-panel h4 {
            color: #f57c00;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .bookmark-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .bookmark-speaker {
            font-weight: 600;
            color: #f57c00;
            margin-bottom: 8px;
        }
        
        .bookmark-content {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .bookmark-meta {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-bookmark {
            background: #ff5722;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .bookmarks-empty {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }
        
        /* Direct chat section styles */
        .direct-chat-section {
            margin-top: 40px;
            padding: 0 48px 48px 48px;
        }
        
        .direct-chat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            border: 2px solid #e9ecef;
            box-shadow: 0 12px 32px rgba(0,0,0,0.06);
        }
        
        .direct-chat-card h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .direct-chat-card p {
            color: #495057;
            margin-bottom: 32px;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .figure-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .figure-chat-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 16px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
            margin: 8px;
        }
        
        .figure-chat-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(102, 126, 234, 0.3);
        }
        
        @media (max-width: 768px) {
            .direct-chat-section {
                padding: 0 20px 20px 20px;
            }
            
            .direct-chat-card {
                padding: 24px;
            }
            
            .figure-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .figure-chat-button {
                width: 100%;
                max-width: 280px;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pulse animation for important buttons */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(102, 126, 234, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Brilliant Minds</h1>
            <p class="subtitle">Watch brilliant minds explore ideas together through thoughtful conversation</p>
        </div>
            
            <!-- Discussion Setup -->
            <div class="setup-section fade-in" id="setupSection">
                <h3>🎭 Choose Your Discussion Participants</h3>
                
                <div class="figures-setup">
                    <div style="grid-column: 1 / -1; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); padding: 20px; border-radius: 15px; border-left: 4px solid #4CAF50;">
            <h4 style="color: #2e7d32; margin-bottom: 12px;">💡 Try These Fascinating Discussions:</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                <div>"What is the meaning of life?" <br><em>Socrates vs Einstein</em></div>
                <div>"How should we approach AI development?" <br><em>Turing vs Musk</em></div>
                <div>"What makes great leadership?" <br><em>Lincoln vs Churchill</em></div>
                <div>"Is free will real?" <br><em>Kant vs Hawking</em></div>
                <div>"What is the nature of consciousness?" <br><em>Penrose vs Descartes</em></div>
                <div>"How do we create a just society?" <br><em>Plato vs Jefferson</em></div>
            </div>
        </div>
    </div>

                    <div class="figure-selection figure-1">
                        <h4>🎤 First Speaker</h4>
                        
                        <!-- Selection Mode Toggle -->
                        <div class="selection-mode">
                            <button type="button" class="mode-button active" onclick="toggleMode(1, 'preset')">📋 Preset Figures</button>
                            <button type="button" class="mode-button" onclick="toggleMode(1, 'custom')">✏️ Write Your Own</button>
                        </div>
                        
                        <label>Brilliant Figure:</label>
                        <select id="figure1" class="preset-select">
                             <optgroup label="🤔 Philosophers">
                                <option value="aristotle" selected="selected">Aristotle</option>
                                <option value="socrates">Socrates</option>
                                <option value="plato">Plato</option>
                                <option value="confucius">Confucius</option>
                                <option value="kant">Immanuel Kant</option>
                                <option value="nietzsche">Friedrich Nietzsche</option>
                            </optgroup>
                            <optgroup label="🔬 Scientists & Mathematicians">
                                <option value="einstein">Albert Einstein</option>
                                <option value="newton">Isaac Newton</option>
                                <option value="darwin">Charles Darwin</option>
                                <option value="curie">Marie Curie</option>
                                <option value="galileo">Galileo Galilei</option>
                                <option value="hawking">Stephen Hawking</option>
                                <option value="feynman">Richard Feynman</option>
                                <option value="tesla">Nikola Tesla</option>
                                <option value="pasteur">Louis Pasteur</option>
                                <option value="watson">James Watson</option>
                                <option value="turing">Alan Turing</option>
                            </optgroup>
                            <optgroup label="🖥️ Logic, Mathematics & Computing Pioneers">
                                <option value="frege">Gottlob Frege</option>
                                <option value="russell">Bertrand Russell</option>
                                <option value="hilbert">David Hilbert</option>
                                <option value="vonneumann">John von Neumann</option>
                                <option value="godel">Kurt Gödel</option>
                                <option value="shannon">Claude Shannon</option>
                                <option value="church_historical">Alonzo Church</option>
                                <option value="babbage">Charles Babbage</option>
                                <option value="lovelace">Ada Lovelace</option>
                            </optgroup>
                            <optgroup label="🧬 Contemporary Scientists & Thinkers">
                                <option value="penrose">Roger Penrose</option>
                                <option value="witten">Edward Witten</option>
                                <option value="venter">Craig Venter</option>
                                <option value="tao">Terence Tao</option>
                                <option value="yau">Shing-Tung Yau</option>
                                <option value="church">Alonzo Church</option>
                                <option value="kahneman">Daniel Kahneman</option>
                                <option value="wilson">Edward O. Wilson</option>
                                <option value="chomsky">Noam Chomsky</option>
                                <option value="pinker">Steven Pinker</option>
                                <option value="harari">Yuval Noah Harari</option>
                                <option value="tegmark">Max Tegmark</option>
                            </optgroup>
                            <optgroup label="👑 Leaders & Statesmen">
                                <option value="lincoln">Abraham Lincoln</option>
                                <option value="churchill">Winston Churchill</option>
                                <option value="gandhi">Mahatma Gandhi</option>
                                <option value="jefferson">Thomas Jefferson</option>
                                <option value="cleopatra">Cleopatra</option>
                                <option value="mandela">Nelson Mandela</option>
                            </optgroup>
                            <optgroup label="🎨 Artists & Writers">
                                <option value="shakespeare">William Shakespeare</option>
                                <option value="leonardo">Leonardo da Vinci</option>
                                <option value="michelangelo">Michelangelo</option>
                                <option value="beethoven">Ludwig van Beethoven</option>
                            </optgroup>
                            <optgroup label="💰 Economic & Social Thinkers">
                                <option value="smith">Adam Smith</option>
                                <option value="marx">Karl Marx</option>
                                <option value="keynes">John Maynard Keynes</option>
                                <option value="friedman">Milton Friedman</option>
                            </optgroup>
                            <optgroup label="💼 Contemporary Leaders & Innovators">
                                <option value="gates">Bill Gates</option>
                                <option value="musk">Elon Musk</option>
                                <option value="bezos">Jeff Bezos</option>
                                <option value="jobs">Steve Jobs</option>
                                <option value="buffett">Warren Buffett</option>
                                <option value="branson">Richard Branson</option>
                            </optgroup>
                        </select>
                        
                        <input type="text" id="figure1Custom" class="custom-input" placeholder="Enter any name (e.g., Taylor Swift, Napoleon, Frida Kahlo, your grandmother...)">
                        
                        <div class="suggestion-box" id="suggestion1" style="display: none;">
                            <strong>💡 Custom Figure Tips:</strong>
                            Try historical figures, celebrities, fictional characters, or even people you know! The AI will research and embody their personality, knowledge, and speaking style.
                        </div>
                    </div>
                    
                    <div class="figure-selection figure-2">
                        <h4>🎯 Second Speaker</h4>
                        
                        <!-- Selection Mode Toggle -->
                        <div class="selection-mode">
                            <button type="button" class="mode-button active" onclick="toggleMode(2, 'preset')">📋 Preset Figures</button>
                            <button type="button" class="mode-button" onclick="toggleMode(2, 'custom')">✏️ Write Your Own</button>
                        </div>
                        
                        <label>Brilliant Figure:</label>
                        <select id="figure2" class="preset-select">
                             <optgroup label="🤔 Philosophers">
                                <option value="aristotle">Aristotle</option>
                                <option value="socrates" selected="selected">Socrates</option>
                                <option value="plato">Plato</option>
                                <option value="confucius">Confucius</option>
                                <option value="kant">Immanuel Kant</option>
                                <option value="nietzsche">Friedrich Nietzsche</option>
                            </optgroup>
                            <optgroup label="🔬 Scientists & Mathematicians">
                                <option value="einstein">Albert Einstein</option>
                                <option value="newton">Isaac Newton</option>
                                <option value="darwin">Charles Darwin</option>
                                <option value="curie">Marie Curie</option>
                                <option value="galileo">Galileo Galilei</option>
                                <option value="hawking">Stephen Hawking</option>
                                <option value="feynman">Richard Feynman</option>
                                <option value="tesla">Nikola Tesla</option>
                                <option value="pasteur">Louis Pasteur</option>
                                <option value="watson">James Watson</option>
                                <option value="turing">Alan Turing</option>
                            </optgroup>
                            <optgroup label="🖥️ Logic, Mathematics & Computing Pioneers">
                                <option value="frege">Gottlob Frege</option>
                                <option value="russell">Bertrand Russell</option>
                                <option value="hilbert">David Hilbert</option>
                                <option value="vonneumann">John von Neumann</option>
                                <option value="godel">Kurt Gödel</option>
                                <option value="shannon">Claude Shannon</option>
                                <option value="church_historical">Alonzo Church</option>
                                <option value="babbage">Charles Babbage</option>
                                <option value="lovelace">Ada Lovelace</option>
                            </optgroup>
                            <optgroup label="🧬 Contemporary Scientists & Thinkers">
                                <option value="penrose">Roger Penrose</option>
                                <option value="witten">Edward Witten</option>
                                <option value="venter">Craig Venter</option>
                                <option value="tao">Terence Tao</option>
                                <option value="yau">Shing-Tung Yau</option>
                                <option value="church">Alonzo Church</option>
                                <option value="kahneman">Daniel Kahneman</option>
                                <option value="wilson">Edward O. Wilson</option>
                                <option value="chomsky">Noam Chomsky</option>
                                <option value="pinker">Steven Pinker</option>
                                <option value="harari">Yuval Noah Harari</option>
                                <option value="tegmark">Max Tegmark</option>
                            </optgroup>
                            <optgroup label="👑 Leaders & Statesmen">
                                <option value="lincoln">Abraham Lincoln</option>
                                <option value="churchill">Winston Churchill</option>
                                <option value="gandhi">Mahatma Gandhi</option>
                                <option value="jefferson">Thomas Jefferson</option>
                                <option value="cleopatra">Cleopatra</option>
                                <option value="mandela">Nelson Mandela</option>
                            </optgroup>
                            <optgroup label="🎨 Artists & Writers">
                                <option value="shakespeare">William Shakespeare</option>
                                <option value="leonardo">Leonardo da Vinci</option>
                                <option value="michelangelo">Michelangelo</option>
                                <option value="beethoven">Ludwig van Beethoven</option>
                            </optgroup>
                            <optgroup label="💰 Economic & Social Thinkers">
                                <option value="smith">Adam Smith</option>
                                <option value="marx">Karl Marx</option>
                                <option value="keynes">John Maynard Keynes</option>
                                <option value="friedman">Milton Friedman</option>
                            </optgroup>
                            <optgroup label="💼 Contemporary Leaders & Innovators">
                                <option value="gates">Bill Gates</option>
                                <option value="musk">Elon Musk</option>
                                <option value="bezos">Jeff Bezos</option>
                                <option value="jobs">Steve Jobs</option>
                                <option value="buffett">Warren Buffett</option>
                                <option value="branson">Richard Branson</option>
                            </optgroup>
                        </select>
                        
                        <input type="text" id="figure2Custom" class="custom-input" placeholder="Enter any name (e.g., Marie Antoinette, Carl Sagan, Maya Angelou...)">
                        
                        <div class="suggestion-box" id="suggestion2" style="display: none;">
                            <strong>💡 Custom Figure Tips:</strong>
                            Try historical figures, celebrities, fictional characters, or even people you know! The AI will research and embody their personality, knowledge, and speaking style.
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="start-button pulse" onclick="startDiscussion()">✨ Start Discussion</button>
                </div>
            </div>
            
            <!-- Participants Display -->
            <div class="participants-display fade-in" id="participantsDisplay">
                <h3 style="margin-bottom: 20px;">Today's Conversation Partners</h3>
                <div class="participant participant-1" id="participant1Name"></div>
                <span style="font-size: 30px; margin: 0 20px;">🤝</span>
                <div class="participant participant-2" id="participant2Name"></div>
            </div>
            
            <!-- Question Input -->
            <div class="question-input-section fade-in" id="questionSection">
                <h4>💬 What would you like them to discuss?</h4>
                <textarea id="questionInput" placeholder="Enter your question here... (e.g., 'What is the meaning of life?', 'How should society be organized?', 'What is the role of art in society?', 'Is free will real?')"></textarea>
                <div class="controls">
                    <button class="ask-button" onclick="askQuestion()">🚀 Start the Discussion</button>
                </div>
            </div>
            
            <!-- Discussion Arena -->
            <div class="discussion-arena fade-in" id="discussionArena">
                <!-- Discussion content will be added here -->
            </div>
            
            <div class="controls" id="discussionControls" style="display: none;">
                <button class="continue-button" onclick="continueDiscussion()" id="continueButton">🔄 Continue Discussion</button>
                <button class="ask-button" onclick="showQuestionInput()">💭 Ask Another Question</button>
                <button class="secondary-button" onclick="toggleExportPanel()">📤 Export & Share</button>
                <button class="secondary-button" onclick="toggleBookmarksPanel()">⭐ View Bookmarks</button>
                <button class="secondary-button" onclick="resetDiscussion()">🆕 New Discussion</button>
            </div>
            
            <!-- Export Controls -->
            <div class="export-controls" id="exportPanel">
                <h4>📤 Export & Share This Discussion</h4>
                <div class="export-buttons">
                    <button class="export-button" onclick="exportAsText()">📄 Download as Text</button>
                    <button class="export-button" onclick="exportAsMarkdown()">📝 Download as Markdown</button>
                    <button class="export-button" onclick="exportAsPDF()">📋 Download as PDF</button>
                    <button class="export-button" onclick="copyShareableLink()">🔗 Copy Shareable Link</button>
                    <button class="export-button" onclick="exportBookmarksOnly()">⭐ Export Bookmarks Only</button>
                </div>
            </div>
            
            <!-- Bookmarks Panel -->
            <div class="bookmarks-panel" id="bookmarksPanel">
                <h4>⭐ Your Bookmarked Insights</h4>
                <div id="bookmarksList">
                    <div class="bookmarks-empty">No bookmarks yet. Click the ⭐ button on any speaker's response to save it!</div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="export-button" onclick="clearAllBookmarks()">🗑️ Clear All Bookmarks</button>
                </div>
            </div>
            
            <!-- Direct Chat Option -->
            <div class="direct-chat-section" id="directChatSection" style="display: none;">
                <div class="direct-chat-card">
                    <h3>💬 Want to chat directly with one of these figures?</h3>
                    <p>Choose a figure from the discussion above to have a personal conversation with them.</p>
                    <div class="figure-buttons" id="figureButtons">
                        <!-- Buttons will be populated by JavaScript -->
                    </div>
                    <p style="font-size: 14px; color: #6c757d; margin-top: 16px;">
                        Or explore our <a href="chat.html" style="color: #667eea; text-decoration: none; font-weight: 600;">full chat interface</a> with all brilliant figures.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let discussionState = {
            figure1: null,
            figure2: null,
            currentQuestion: '',
            isExtended: false,
            currentContainer: null,
            figure1Mode: 'preset',
            figure2Mode: 'preset',
            extensionCount: 0,
            additionalResponses: [],
            bookmarks: [],
            discussionStartTime: null
        };

        // Toggle between preset and custom input modes
        function toggleMode(figureNum, mode) {
            discussionState[`figure${figureNum}Mode`] = mode;
            
            const presetSelect = document.getElementById(`figure${figureNum}`);
            const customInput = document.getElementById(`figure${figureNum}Custom`);
            const suggestionBox = document.getElementById(`suggestion${figureNum}`);
            const modeButtons = document.querySelectorAll(`.figure-selection:nth-child(${figureNum + 1}) .mode-button`);
            
            // Update button states
            modeButtons.forEach((btn, index) => {
                if ((index === 0 && mode === 'preset') || (index === 1 && mode === 'custom')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Show/hide appropriate input
            if (mode === 'preset') {
                presetSelect.style.display = 'block';
                customInput.style.display = 'none';
                suggestionBox.style.display = 'none';
            } else {
                presetSelect.style.display = 'none';
                customInput.style.display = 'block';
                suggestionBox.style.display = 'block';
                customInput.focus();
            }
        }

        // Create custom figure object from name
        function createCustomFigure(name) {
            return {
                name: name,
                prompt: `You are ${name}. Embody their personality, knowledge, speaking style, and perspective as accurately as possible. If this is a real person, draw on their known views, experiences, and way of communicating. If this is a fictional character, embody their personality from their source material. If this is someone the user knows personally, ask clarifying questions if needed, but generally respond as a thoughtful, intelligent person with that name would. Stay in character throughout the conversation and bring their unique perspective to the discussion.`
            };
        }

        // Enhanced brilliant figures with scientists and thought leaders (keeping all your existing figures)
        const figures = {
            // Philosophers
            socrates: {
                name: "Socrates",
                prompt: "You are Socrates. Use the Socratic method - ask probing questions to examine beliefs. Be humble about your own knowledge ('I know that I know nothing'). Challenge assumptions and seek truth through questioning."
            },
            aristotle: {
                name: "Aristotle",
                prompt: "You are Aristotle. Speak as a systematic philosopher and logician. Use logical reasoning and categorical thinking. Reference your teachings on ethics, politics, and human nature."
            },
            plato: {
                name: "Plato",
                prompt: "You are Plato. Speak about ideals, truth, and the nature of reality. Reference your theory of Forms and beliefs about justice and the ideal state. Use allegories and philosophical reasoning."
            },
            confucius: {
                name: "Confucius",
                prompt: "You are Confucius. Speak with wisdom about social harmony, virtue, and proper relationships. Reference the importance of education, family, and moral cultivation. Use thoughtful aphorisms."
            },
            kant: {
                name: "Immanuel Kant",
                prompt: "You are Immanuel Kant. Speak about duty, categorical imperatives, and moral philosophy. Reference the limits of reason and the importance of moral law. Be systematic and precise in your thinking."
            },
            nietzsche: {
                name: "Friedrich Nietzsche",
                prompt: "You are Friedrich Nietzsche. Speak provocatively about the will to power, the übermensch, and questioning traditional values. Challenge conventional morality and advocate for individual strength and creativity."
            },
            
            // Scientists & Mathematicians
            einstein: {
                name: "Albert Einstein",
                prompt: "You are Albert Einstein. Respond with scientific curiosity, wisdom, and humanitarian concerns. Reference scientific principles when relevant. Show your philosophical side and concern for humanity's future."
            },
            newton: {
                name: "Isaac Newton",
                prompt: "You are Isaac Newton. Speak with mathematical precision and systematic thinking. Reference natural laws, gravity, and the mathematical nature of the universe. Show your methodical approach to understanding nature."
            },
            darwin: {
                name: "Charles Darwin",
                prompt: "You are Charles Darwin. Speak about evolution, natural selection, and careful observation of nature. Show your methodical approach to collecting evidence and drawing conclusions. Reference the interconnectedness of life."
            },
            curie: {
                name: "Marie Curie",
                prompt: "You are Marie Curie. Speak with dedication to scientific research and discovery. Reference your work with radioactivity and your perseverance in a male-dominated field. Show passion for knowledge and scientific advancement."
            },
            galileo: {
                name: "Galileo Galilei",
                prompt: "You are Galileo Galilei. Speak about observation, experimentation, and challenging established beliefs. Reference your telescopic discoveries and your conflict with traditional authority. Advocate for empirical evidence."
            },
            hawking: {
                name: "Stephen Hawking",
                prompt: "You are Stephen Hawking. Speak about black holes, the nature of time, and the universe. Make complex physics accessible. Show your wit and determination to understand the cosmos despite physical limitations."
            },
            feynman: {
                name: "Richard Feynman",
                prompt: "You are Richard Feynman. Speak with curiosity and explain complex physics simply. Use analogies and everyday examples. Show your love of learning and teaching. Be playful yet profound in your insights."
            },
            tesla: {
                name: "Nikola Tesla",
                prompt: "You are Nikola Tesla. Speak about electricity, invention, and the future of technology. Show your visionary thinking and dedication to advancing human civilization through science and engineering."
            },
            pasteur: {
                name: "Louis Pasteur",
                prompt: "You are Louis Pasteur. Speak about the scientific method, germ theory, and the importance of careful experimentation. Show your dedication to improving human health through scientific discovery."
            },
            watson: {
                name: "James Watson",
                prompt: "You are James Watson. Speak about DNA, genetics, and molecular biology. Reference the structure of DNA and the importance of scientific collaboration. Show your passion for understanding life at the molecular level."
            },
            turing: {
                name: "Alan Turing",
                prompt: "You are Alan Turing. Speak about computation, artificial intelligence, and mathematical logic. Reference your work on breaking codes, the theoretical foundations of computer science, and the Turing test for machine intelligence."
            },
            
            // Logic, Mathematics & Computing Pioneers
            frege: {
                name: "Gottlob Frege",
                prompt: "You are Gottlob Frege. Speak about mathematical logic, the foundations of arithmetic, and formal systems. Reference your work on predicate logic and the logical foundations of mathematics. Discuss sense and reference in language and logic."
            },
            russell: {
                name: "Bertrand Russell",
                prompt: "You are Bertrand Russell. Speak about mathematical logic, philosophy of mathematics, and analytic philosophy. Reference Russell's Paradox, logical atomism, and your work with Whitehead on Principia Mathematica. Discuss the relationship between logic and reality."
            },
            hilbert: {
                name: "David Hilbert",
                prompt: "You are David Hilbert. Speak about mathematical formalism, the foundations of geometry, and Hilbert's program. Reference your work on axiomatization and the quest to prove mathematics is complete and consistent. Discuss mathematical rigor and proof theory."
            },
            vonneumann: {
                name: "John von Neumann",
                prompt: "You are John von Neumann. Speak about computer architecture, game theory, and mathematical foundations. Reference the von Neumann architecture, quantum mechanics formalism, and mathematical economics. Discuss the intersection of mathematics and practical applications."
            },
            godel: {
                name: "Kurt Gödel",
                prompt: "You are Kurt Gödel. Speak about mathematical logic, incompleteness theorems, and the limits of formal systems. Reference your proof that mathematics contains undecidable propositions. Discuss the philosophical implications of mathematical incompleteness."
            },
            shannon: {
                name: "Claude Shannon",
                prompt: "You are Claude Shannon. Speak about information theory, digital circuits, and communication systems. Reference your mathematical theory of communication and the concept of information entropy. Discuss how information can be quantified and transmitted."
            },
            church_historical: {
                name: "Alonzo Church",
                prompt: "You are Alonzo Church. Speak about lambda calculus, mathematical logic, and computability theory. Reference Church's thesis on effective calculability and your work on the foundations of computer science. Discuss the relationship between logic and computation."
            },
            babbage: {
                name: "Charles Babbage",
                prompt: "You are Charles Babbage. Speak about mechanical computation, the Analytical Engine, and early computer design. Reference your vision of programmable machines and automatic calculation. Discuss the mechanical foundations of computing."
            },
            lovelace: {
                name: "Ada Lovelace",
                prompt: "You are Ada Lovelace. Speak about programming, mathematical computation, and the potential of computing machines. Reference your work on Babbage's Analytical Engine and your vision of computers beyond mere calculation. Discuss the creative possibilities of computation."
            },
            
            // Leaders & Statesmen
            lincoln: {
                name: "Abraham Lincoln",
                prompt: "You are Abraham Lincoln. Speak with wisdom, humility, and moral clarity. Use folksy anecdotes and simple language to explain complex ideas. Show concern for justice, unity, and human dignity."
            },
            churchill: {
                name: "Winston Churchill",
                prompt: "You are Winston Churchill. Speak with determination, wit, and rhetorical flair. Reference your wartime leadership experience. Use powerful, memorable phrases and show resolve."
            },
            gandhi: {
                name: "Mahatma Gandhi",
                prompt: "You are Mahatma Gandhi. Speak with moral authority, non-violence, and spiritual wisdom. Reference your philosophy of peaceful resistance and social justice. Show compassion and dedication to truth."
            },
            jefferson: {
                name: "Thomas Jefferson",
                prompt: "You are Thomas Jefferson. Speak as an Enlightenment thinker and founding father. Reference democratic ideals, individual liberty, and natural rights. Show your intellectual breadth."
            },
            cleopatra: {
                name: "Cleopatra",
                prompt: "You are Cleopatra VII of Egypt. Speak with intelligence, political acumen, and regal bearing. Reference ancient leadership, politics, and strategy. Show your multilingual education and diplomatic skills."
            },
            mandela: {
                name: "Nelson Mandela",
                prompt: "You are Nelson Mandela. Speak about reconciliation, justice, and peaceful resistance to oppression. Reference your experience with apartheid and your commitment to unity and forgiveness."
            },
            
            // Artists & Writers
            shakespeare: {
                name: "William Shakespeare",
                prompt: "You are William Shakespeare. Speak with eloquence and creativity. Use some Elizabethan flair but keep it understandable. Reference human nature and the human condition. Use metaphors and poetic language."
            },
            leonardo: {
                name: "Leonardo da Vinci",
                prompt: "You are Leonardo da Vinci. Show Renaissance curiosity about everything - art, science, engineering, nature. Connect different fields of knowledge. Be enthusiastic about learning and observation."
            },
            michelangelo: {
                name: "Michelangelo",
                prompt: "You are Michelangelo. Speak passionately about art, sculpture, and the pursuit of perfection. Reference your dedication to capturing divine beauty and human form. Show your artistic intensity and spiritual devotion."
            },
            beethoven: {
                name: "Ludwig van Beethoven",
                prompt: "You are Ludwig van Beethoven. Speak passionately about music, emotion, and artistic expression. Reference how music can convey the deepest human feelings. Show your revolutionary spirit in art."
            },
            
            // Economic & Social Thinkers
            smith: {
                name: "Adam Smith",
                prompt: "You are Adam Smith. Speak about free markets, the invisible hand, and human nature in economic behavior. Reference the importance of self-interest balanced with moral sentiments."
            },
            marx: {
                name: "Karl Marx",
                prompt: "You are Karl Marx. Speak about class struggle, capitalism, and social revolution. Reference the importance of economic structures in shaping society and the need for worker solidarity."
            },
            keynes: {
                name: "John Maynard Keynes",
                prompt: "You are John Maynard Keynes. Speak about economics, government intervention, and managing economic cycles. Reference the importance of demand management and practical economic policy."
            },
            friedman: {
                name: "Milton Friedman",
                prompt: "You are Milton Friedman. Speak about free markets, individual choice, and limited government. Reference the efficiency of market mechanisms and the importance of economic freedom."
            },
            
            // Contemporary Scientists & Thinkers
            penrose: {
                name: "Roger Penrose",
                prompt: "You are Roger Penrose. Speak about mathematical physics, consciousness, and cosmology. Reference your work on black holes, penrose tilings, and quantum theories of consciousness. Discuss the deep mathematical structure of reality."
            },
            witten: {
                name: "Edward Witten",
                prompt: "You are Edward Witten. Speak about string theory, mathematical physics, and the unification of fundamental forces. Reference M-theory and the mathematical elegance underlying physical reality. Discuss topology and quantum field theory."
            },
            venter: {
                name: "Craig Venter",
                prompt: "You are Craig Venter. Speak about genomics, synthetic biology, and the future of life sciences. Reference your work sequencing the human genome and creating synthetic life forms. Discuss personalized medicine and bioengineering."
            },
            tao: {
                name: "Terence Tao",
                prompt: "You are Terence Tao. Speak about pure mathematics, number theory, and harmonic analysis. Reference your work on prime numbers, partial differential equations, and mathematical problem-solving. Discuss the beauty and structure of mathematical truth."
            },
            yau: {
                name: "Shing-Tung Yau",
                prompt: "You are Shing-Tung Yau. Speak about differential geometry, algebraic geometry, and mathematical physics. Reference Calabi-Yau manifolds and your work bridging mathematics and string theory. Discuss the geometric foundations of physical reality."
            },
            church: {
                name: "Alonzo Church",
                prompt: "You are Alonzo Church. Speak about mathematical logic, lambda calculus, and the foundations of computation. Reference Church's thesis and your work on decidability. Discuss the logical structure underlying mathematics and computation."
            },
            kahneman: {
                name: "Daniel Kahneman",
                prompt: "You are Daniel Kahneman. Speak about behavioral economics, cognitive biases, and decision-making. Reference prospect theory and your work on human irrationality. Discuss how psychology impacts economic and personal decisions."
            },
            wilson: {
                name: "Edward O. Wilson",
                prompt: "You are Edward O. Wilson. Speak about sociobiology, biodiversity, and conservation. Reference your work on ant colonies, island biogeography, and the unity of knowledge. Discuss the biological foundations of behavior and environmental protection."
            },
            chomsky: {
                name: "Noam Chomsky",
                prompt: "You are Noam Chomsky. Speak about linguistics, cognitive science, and political criticism. Reference universal grammar and critique media and political power structures. Show deep concern for social justice."
            },
            pinker: {
                name: "Steven Pinker",
                prompt: "You are Steven Pinker. Speak about cognitive psychology, language, and human progress. Reference declining violence and the power of reason and science. Be optimistic about human nature and Enlightenment values."
            },
            harari: {
                name: "Yuval Noah Harari",
                prompt: "You are Yuval Noah Harari. Speak about human history, the future of humanity, and artificial intelligence. Reference cognitive revolution, agricultural revolution, and scientific revolution. Discuss how technology shapes society."
            },
            diamandis: {
                name: "Peter Diamandis",
                prompt: "You are Peter Diamandis. Speak about exponential technologies, space exploration, and abundance mindset. Reference how technology solves humanity's grand challenges. Be optimistic about innovation and entrepreneurship."
            },
            tegmark: {
                name: "Max Tegmark",
                prompt: "You are Max Tegmark. Speak about artificial intelligence, cosmology, and the mathematical universe hypothesis. Discuss AI safety and the future of intelligence. Reference parallel universes and consciousness."
            },
            
            // Contemporary Leaders & Innovators
            gates: {
                name: "Bill Gates",
                prompt: "You are Bill Gates. Speak about technology, global health, and philanthropy. Reference your Microsoft experience and current focus on solving world problems through innovation and giving. Discuss pandemic preparedness and climate change."
            },
            musk: {
                name: "Elon Musk",
                prompt: "You are Elon Musk. Speak about electric vehicles, space exploration, and artificial intelligence. Reference your work with Tesla, SpaceX, and Neuralink. Be ambitious about humanity's multi-planetary future and sustainable energy."
            },
            bezos: {
                name: "Jeff Bezos",
                prompt: "You are Jeff Bezos. Speak about e-commerce, cloud computing, and space colonization. Reference customer obsession and long-term thinking. Discuss building companies that can scale and your vision for space manufacturing."
            },
            jobs: {
                name: "Steve Jobs",
                prompt: "You are Steve Jobs. Speak about design, innovation, and user experience. Reference the intersection of technology and liberal arts. Emphasize simplicity, perfection, and thinking differently about products."
            },
            buffett: {
                name: "Warren Buffett",
                prompt: "You are Warren Buffett. Speak about value investing, business principles, and long-term thinking. Reference buying great companies at fair prices and the importance of understanding businesses. Use folksy wisdom and analogies."
            },
            branson: {
                name: "Richard Branson",
                prompt: "You are Richard Branson. Speak about entrepreneurship, adventure, and putting employees first. Reference the Virgin brand philosophy and disrupting established industries. Emphasize fun, customer service, and taking calculated risks."
            }
        };
        
        function startDiscussion() { 
            let figure1, figure2;
            
            // Get figure 1
            if (discussionState.figure1Mode === 'preset') {
                const figure1Id = document.getElementById('figure1').value;
                figure1 = figures[figure1Id];
            } else {
                const figure1Name = document.getElementById('figure1Custom').value.trim();
                if (!figure1Name) {
                    alert('Please enter a name for the first speaker!');
                    return;
                }
                figure1 = createCustomFigure(figure1Name);
            }
            
            // Get figure 2
            if (discussionState.figure2Mode === 'preset') {
                const figure2Id = document.getElementById('figure2').value;
                figure2 = figures[figure2Id];
            } else {
                const figure2Name = document.getElementById('figure2Custom').value.trim();
                if (!figure2Name) {
                    alert('Please enter a name for the second speaker!');
                    return;
                }
                figure2 = createCustomFigure(figure2Name);
            }
            
            // Check if same figure selected/entered
            if (figure1.name.toLowerCase() === figure2.name.toLowerCase()) {
                alert('Please select or enter different figures for an interesting discussion!');
                return;
            }
            
            discussionState.figure1 = figure1;
            discussionState.figure2 = figure2;
            
            // Update display
            document.getElementById('participant1Name').textContent = discussionState.figure1.name;
            document.getElementById('participant2Name').textContent = discussionState.figure2.name;
            
            // Show/hide sections with animation
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('participantsDisplay').style.display = 'block';
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('discussionArena').style.display = 'block';
            
            // Clear previous discussions
            document.getElementById('discussionArena').innerHTML = '';
        }
        
        async function askQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) {
                alert('Please enter a question!');
                return;
            }
            
            discussionState.currentQuestion = question;
            discussionState.discussionStartTime = new Date();
            
            // Hide question input
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'block';
            
            // Create discussion round
            const arena = document.getElementById('discussionArena');
            const roundDiv = document.createElement('div');
            roundDiv.className = 'discussion-round fade-in';
            roundDiv.innerHTML = `<div class="question-header">💭 "${question}"</div>`;
            arena.appendChild(roundDiv);
            
            // Conduct the three-part discussion
            await getInitialResponse(roundDiv);
            await getSecondResponse(roundDiv);
            await getFollowUpResponse(roundDiv);
            await getModerationSummary(roundDiv);
            
            // Store current container for potential continuation
            discussionState.currentContainer = roundDiv;
            discussionState.isExtended = false;
            
            // Show direct chat options
            showDirectChatOptions();
        }
        
        async function getInitialResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                <div><span class="loading"></span>Thinking...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are starting a thoughtful discussion. The question is: "${discussionState.currentQuestion}"

Give your perspective on this question in a CONCISE way (2-3 key points maximum). Be thoughtful and authentic to your historical viewpoint, but focus on your most important insights. Keep it under 150 words.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <button class="bookmark-button" onclick="addBookmark('${discussionState.figure1.name}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <button class="bookmark-button" onclick="addBookmark('${discussionState.figure2.name}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Opening Thoughts')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for next speaker
                discussionState.firstResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Response & Analysis')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Opening Thoughts')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for next speaker
                discussionState.firstResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>), // Unescape for storage
                context: context,
                question: discussionState.currentQuestion,
                timestamp: new Date().toLocaleString(),
                discussion: `${discussionState.figure1.name} vs ${discussionState.figure2.name}`
            };
            
            discussionState.bookmarks.push(bookmark);
            
            // Visual feedback
            const button = event.target;
            button.textContent = '✅ Bookmarked';
            button.classList.add('bookmarked');
            button.disabled = true;
            
            // Show success message
            showNotification('💾 Insight bookmarked! View in the bookmarks panel.', 'success');
            
            // Update bookmarks panel if open
            if (document.getElementById('bookmarksPanel').style.display !== 'none') {
                updateBookmarksPanel();
            }
        }
        
        function toggleBookmarksPanel() {
            const panel = document.getElementById('bookmarksPanel');
            const exportPanel = document.getElementById('exportPanel');
            
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                exportPanel.style.display = 'none';
                updateBookmarksPanel();
                panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                panel.style.display = 'none';
            }
        }
        
        function updateBookmarksPanel() {
            const bookmarksList = document.getElementById('bookmarksList');
            
            if (discussionState.bookmarks.length === 0) {
                bookmarksList.innerHTML = '<div class="bookmarks-empty">No bookmarks yet. Click the ⭐ button on any speaker\'s response to save it!</div>';
                return;
            }
            
            bookmarksList.innerHTML = discussionState.bookmarks.map(bookmark => `
                <div class="bookmark-item">
                    <div class="bookmark-speaker">${bookmark.speaker} (${bookmark.context})</div>
                    <div class="bookmark-content">${bookmark.content.substring(0, 200)}${bookmark.content.length > 200 ? '...' : ''}</div>
                    <div class="bookmark-meta">
                        <span>From: "${bookmark.question.substring(0, 50)}${bookmark.question.length > 50 ? '...' : ''}" • ${bookmark.timestamp}</span>
                        <button class="remove-bookmark" onclick="removeBookmark(${bookmark.id})">Remove</button>
                    </div>
                </div>
            `).join('');
        }
        
        function removeBookmark(bookmarkId) {
            discussionState.bookmarks = discussionState.bookmarks.filter(b => b.id !== bookmarkId);
            updateBookmarksPanel();
            showNotification('🗑️ Bookmark removed', 'info');
        }
        
        function clearAllBookmarks() {
            if (confirm('Are you sure you want to clear all bookmarks? This cannot be undone.')) {
                discussionState.bookmarks = [];
                updateBookmarksPanel();
                showNotification('🗑️ All bookmarks cleared', 'info');
            }
        }
        
        function toggleExportPanel() {
            const panel = document.getElementById('exportPanel');
            const bookmarksPanel = document.getElementById('bookmarksPanel');
            
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                bookmarksPanel.style.display = 'none';
                panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                panel.style.display = 'none';
            }
        }
        
        function exportAsText() {
            const content = generateExportContent('text');
            downloadFile(content, `brilliant-minds-discussion-${getFileName()}.txt`, 'text/plain');
            showNotification('📄 Discussion exported as text file!', 'success');
        }
        
        function exportAsMarkdown() {
            const content = generateExportContent('markdown');
            downloadFile(content, `brilliant-minds-discussion-${getFileName()}.md`, 'text/markdown');
            showNotification('📝 Discussion exported as Markdown file!', 'success');
        }
        
        function exportAsPDF() {
            // For PDF export, we'll create an HTML version and prompt user to print
            const content = generateExportContent('html');
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Brilliant Minds Discussion</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .speaker { margin: 20px 0; padding: 15px; border-left: 4px solid #667eea; background: #f9f9f9; }
                        .speaker-name { font-weight: bold; color: #333; margin-bottom: 10px; }
                        .question { background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center; font-weight: bold; }
                        .moderator { background: #fff8f0; border-left-color: #ff9800; }
                        @media print { body { margin: 20px; } }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            newWindow.document.close();
            newWindow.print();
            showNotification('📋 Opening print dialog for PDF export...', 'info');
        }
        
        function copyShareableLink() {
            // Create a shareable data structure
            const shareData = {
                question: discussionState.currentQuestion,
                figure1: discussionState.figure1.name,
                figure2: discussionState.figure2.name,
                discussionId: btoa(JSON.stringify({
                    q: discussionState.currentQuestion,
                    f1: discussionState.figure1.name,
                    f2: discussionState.figure2.name,
                    date: discussionState.discussionStartTime
                }))
            };
            
            const shareableUrl = `${window.location.origin}${window.location.pathname}?share=${shareData.discussionId}`;
            
            navigator.clipboard.writeText(shareableUrl).then(() => {
                showNotification('🔗 Shareable link copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareableUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('🔗 Shareable link copied to clipboard!', 'success');
            });
        }
        
        function exportBookmarksOnly() {
            if (discussionState.bookmarks.length === 0) {
                showNotification('⭐ No bookmarks to export yet!', 'warning');
                return;
            }
            
            const content = generateBookmarksExport();
            downloadFile(content, `brilliant-minds-bookmarks-${getFileName()}.md`, 'text/markdown');
            showNotification('⭐ Bookmarks exported successfully!', 'success');
        }
        
        function generateExportContent(format) {
            const timestamp = new Date().toLocaleString();
            const title = `Brilliant Minds Discussion: ${discussionState.figure1.name} vs ${discussionState.figure2.name}`;
            const question = discussionState.currentQuestion;
            
            // Get all responses from the discussion
            const arena = document.getElementById('discussionArena');
            const speakers = arena.querySelectorAll('.speaker:not(.moderator-speaker)');
            const moderators = arena.querySelectorAll('.moderator-speaker');
            
            if (format === 'text') {
                let content = `${title}\n${'='.repeat(title.length)}\n\n`;
                content += `Question: "${question}"\n`;
                content += `Date: ${timestamp}\n`;
                content += `Rounds: ${discussionState.extensionCount + 1}\n\n`;
                
                speakers.forEach(speaker => {
                    const name = speaker.querySelector('.speaker-name').textContent;
                    const text = speaker.querySelector('.speaker-content').textContent;
                    content += `${name}:\n${text}\n\n`;
                });
                
                moderators.forEach(moderator => {
                    const name = moderator.querySelector('.speaker-name').textContent;
                    const text = moderator.querySelector('.moderator-content').textContent;
                    content += `${name}:\n${text}\n\n`;
                });
                
                if (discussionState.bookmarks.length > 0) {
                    content += `\n${'='.repeat(20)}\nBOOKMARKED INSIGHTS\n${'='.repeat(20)}\n\n`;
                    discussionState.bookmarks.forEach((bookmark, index) => {
                        content += `${index + 1}. ${bookmark.speaker} (${bookmark.context}):\n${bookmark.content}\n\n`;
                    });
                }
                
                return content;
            }
            
            if (format === 'markdown') {
                let content = `# ${title}\n\n`;
                content += `**Question:** "${question}"\n\n`;
                content += `**Date:** ${timestamp}\n\n`;
                content += `**Rounds:** ${discussionState.extensionCount + 1}\n\n`;
                content += `---\n\n`;
                
                speakers.forEach(speaker => {
                    const name = speaker.querySelector('.speaker-name').textContent;
                    const text = speaker.querySelector('.speaker-content').textContent;
                    content += `## ${name}\n\n${text}\n\n`;
                });
                
                moderators.forEach(moderator => {
                    const name = moderator.querySelector('.speaker-name').textContent;
                    const text = moderator.querySelector('.moderator-content').textContent;
                    content += `## ${name}\n\n${text}\n\n`;
                });
                
                if (discussionState.bookmarks.length > 0) {
                    content += `---\n\n## 📚 Bookmarked Insights\n\n`;
                    discussionState.bookmarks.forEach((bookmark, index) => {
                        content += `### ${index + 1}. ${bookmark.speaker} (${bookmark.context})\n\n${bookmark.content}\n\n`;
                    });
                }
                
                content += `---\n\n*Generated by Brilliant Minds - ${window.location.origin}*`;
                return content;
            }
            
            if (format === 'html') {
                let content = `<div class="header"><h1>${title}</h1><p><strong>Question:</strong> "${question}"</p><p><strong>Date:</strong> ${timestamp}</p></div>`;
                
                speakers.forEach(speaker => {
                    const name = speaker.querySelector('.speaker-name').textContent;
                    const text = speaker.querySelector('.speaker-content').innerHTML;
                    content += `<div class="speaker"><div class="speaker-name">${name}</div><div>${text}</div></div>`;
                });
                
                moderators.forEach(moderator => {
                    const name = moderator.querySelector('.speaker-name').textContent;
                    const text = moderator.querySelector('.moderator-content').innerHTML;
                    content += `<div class="speaker moderator"><div class="speaker-name">${name}</div><div>${text}</div></div>`;
                });
                
                return content;
            }
        }
        
        function generateBookmarksExport() {
            let content = `# 📚 Brilliant Minds - Bookmarked Insights\n\n`;
            content += `**Exported:** ${new Date().toLocaleString()}\n\n`;
            content += `**Discussion:** ${discussionState.figure1.name} vs ${discussionState.figure2.name}\n\n`;
            content += `**Question:** "${discussionState.currentQuestion}"\n\n`;
            content += `---\n\n`;
            
            discussionState.bookmarks.forEach((bookmark, index) => {
                content += `## ${index + 1}. ${bookmark.speaker} (${bookmark.context})\n\n`;
                content += `${bookmark.content}\n\n`;
                content += `*Bookmarked: ${bookmark.timestamp}*\n\n---\n\n`;
            });
            
            content += `*Generated by Brilliant Minds - ${window.location.origin}*`;
            return content;
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        function getFileName() {
            const date = new Date().toISOString().split('T')[0];
            const figures = `${discussionState.figure1.name.replace(/\s+/g, '-')}-vs-${discussionState.figure2.name.replace(/\s+/g, '-')}`;
            return `${date}-${figures}`.toLowerCase();
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 350px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease;
            `;
            
            const colors = {
                success: 'background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);',
                warning: 'background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);',
                error: 'background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);',
                info: 'background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);'
            };
            
            notification.style.cssText += colors[type];
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brilliant Minds - Discussion Arena</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .container {
            background: white;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 24px;
            box-shadow: 0 32px 80px rgba(0,0,0,0.12), 0 8px 32px rgba(0,0,0,0.06);
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 48px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            opacity: 0.5;
        }
        
        .header * {
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 3.2rem;
            font-weight: 800;
            margin-bottom: 16px;
            text-shadow: 0 4px 12px rgba(0,0,0,0.15);
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .nav-links {
            position: absolute;
            top: 20px;
            left: 30px;
            z-index: 2;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }
        
        .nav-links a:hover {
            opacity: 1;
            text-decoration: underline;
        }
        
        .content {
            padding: 48px;
        }
        
        .setup-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .setup-section h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .figures-setup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .figure-selection {
            background: white;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
            border: 2px solid #f8f9fa;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .figure-selection:hover {
            transform: translateY(-8px);
            box-shadow: 0 24px 60px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08);
            border-color: #e9ecef;
        }
        
        .figure-1 {
            border-left: 4px solid #667eea;
        }
        
        .figure-2 {
            border-left: 4px solid #764ba2;
        }
        
        .figure-selection h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .figure-selection label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        /* Toggle buttons for selection mode */
        .selection-mode {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .mode-button {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            color: #6c757d;
        }
        
        .mode-button.active {
            background: white;
            color: #495057;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .mode-button:hover:not(.active) {
            color: #495057;
        }
        
        select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
        }
        
        .custom-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
        }
        
        .custom-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
        }
        
        .custom-input::placeholder {
            color: #6c757d;
            font-style: italic;
        }
        
        .suggestion-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 13px;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .suggestion-box strong {
            color: #495057;
            display: block;
            margin-bottom: 6px;
        }
        
        optgroup {
            font-weight: bold;
            color: #495057;
            padding: 8px 0;
        }
        
        option {
            font-weight: normal;
            padding: 8px 12px;
        }
        
        .participants-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            color: white;
            display: none;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .participant {
            display: inline-block;
            margin: 0 15px;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .participant:hover {
            transform: scale(1.05);
        }
        
        .participant-1 {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }
        
        .participant-2 {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }
        
        .question-input-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            display: none;
            border: 1px solid #2196F3;
        }
        
        .question-input-section h4 {
            color: #1565C0;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .discussion-arena {
            border: 2px solid #f1f3f5;
            border-radius: 24px;
            padding: 40px;
            min-height: 500px;
            margin-bottom: 32px;
            background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
            overflow-y: auto;
            max-height: none;
            display: none;
        }
        
        .discussion-round {
            margin-bottom: 40px;
            padding: 32px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 12px 32px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
            border-left: 6px solid #667eea;
            max-height: none;
            overflow: visible;
        }
        
        .question-header {
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #2e7d32;
            border: 2px solid #4caf50;
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .speaker {
            margin: 24px 0;
            padding: 24px;
            border-radius: 16px;
            border-left: 5px solid;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.04);
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: auto;
            max-height: none;
            overflow: visible;
            position: relative;
        }
        
        .speaker:hover {
            transform: translateX(8px);
        }
        
        .speaker-content {
            line-height: 1.7;
            color: #2c3e50;
        }
        
        .speaker-content p {
            margin: 16px 0;
            line-height: 1.7;
        }
        
        .speaker-content p:first-child {
            margin-top: 0;
        }
        
        .speaker-content p:last-child {
            margin-bottom: 0;
        }
        
        .figure-1-speaker {
            border-left-color: #667eea;
            background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .figure-2-speaker {
            border-left-color: #764ba2;
            background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .moderator-speaker {
            border-left-color: #ff9800;
            background: linear-gradient(135deg, #fff8f0 0%, #fff3e0 100%);
            min-height: auto;
            overflow: visible;
            max-height: none;
            height: auto;
        }
        
        .moderator-content {
            line-height: 1.7;
            max-height: none;
            overflow: visible;
            height: auto;
        }
        
        .moderator-content h4 {
            font-weight: 700;
            font-size: 1.1rem;
            color: #e65100;
            margin: 20px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffcc02;
            display: block;
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .moderator-content h4:first-child {
            margin-top: 0;
        }
        
        .moderator-content p {
            margin: 12px 0;
            color: #424242;
            font-size: 15px;
        }
        
        .moderator-content ul, .moderator-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .moderator-content li {
            margin: 8px 0;
            color: #424242;
        }
        
        .speaker-name {
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .extended-separator {
            margin: 25px 0;
            padding: 15px;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border-radius: 10px;
            text-align: center;
            font-weight: 700;
            color: #1976D2;
            border: 2px dashed #2196F3;
        }
        
        .controls {
            text-align: center;
            margin: 25px 0;
        }
        
        button {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            margin: 0 8px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.01em;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08);
        }
        
        button:active {
            transform: translateY(-2px);
        }
        
        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .start-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            font-size: 18px;
            padding: 18px 40px;
        }
        
        .ask-button {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }
        
        .continue-button {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }
        
        .secondary-button {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .figures-setup {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .participant {
                display: block;
                margin: 10px 0;
            }
            
            button {
                display: block;
                width: 100%;
                margin: 8px 0;
            }
        }
        
        /* Bookmark and Export Features */
        .bookmark-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            color: #f57c00;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .bookmark-button:hover {
            background: rgba(255, 193, 7, 0.2);
            transform: scale(1.05);
        }
        
        .bookmark-button.bookmarked {
            background: #ffc107;
            color: white;
        }
        
        .export-controls {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            display: none;
            border: 1px solid #4caf50;
        }
        
        .export-controls h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .export-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .export-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }
        
        .bookmarks-panel {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            display: none;
            border: 1px solid #ffc107;
        }
        
        .bookmarks-panel h4 {
            color: #f57c00;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .bookmark-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .bookmark-speaker {
            font-weight: 600;
            color: #f57c00;
            margin-bottom: 8px;
        }
        
        .bookmark-content {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .bookmark-meta {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-bookmark {
            background: #ff5722;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .bookmarks-empty {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }
        
        /* Direct chat section styles */
        .direct-chat-section {
            margin-top: 40px;
            padding: 0 48px 48px 48px;
        }
        
        .direct-chat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            border: 2px solid #e9ecef;
            box-shadow: 0 12px 32px rgba(0,0,0,0.06);
        }
        
        .direct-chat-card h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .direct-chat-card p {
            color: #495057;
            margin-bottom: 32px;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .figure-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .figure-chat-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 16px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
            margin: 8px;
        }
        
        .figure-chat-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(102, 126, 234, 0.3);
        }
        
        @media (max-width: 768px) {
            .direct-chat-section {
                padding: 0 20px 20px 20px;
            }
            
            .direct-chat-card {
                padding: 24px;
            }
            
            .figure-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .figure-chat-button {
                width: 100%;
                max-width: 280px;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pulse animation for important buttons */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(102, 126, 234, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Brilliant Minds</h1>
            <p class="subtitle">Watch brilliant minds explore ideas together through thoughtful conversation</p>
        </div>
            
            <!-- Discussion Setup -->
            <div class="setup-section fade-in" id="setupSection">
                <h3>🎭 Choose Your Discussion Participants</h3>
                
                <div class="figures-setup">
                    <div style="grid-column: 1 / -1; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); padding: 20px; border-radius: 15px; border-left: 4px solid #4CAF50;">
            <h4 style="color: #2e7d32; margin-bottom: 12px;">💡 Try These Fascinating Discussions:</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                <div>"What is the meaning of life?" <br><em>Socrates vs Einstein</em></div>
                <div>"How should we approach AI development?" <br><em>Turing vs Musk</em></div>
                <div>"What makes great leadership?" <br><em>Lincoln vs Churchill</em></div>
                <div>"Is free will real?" <br><em>Kant vs Hawking</em></div>
                <div>"What is the nature of consciousness?" <br><em>Penrose vs Descartes</em></div>
                <div>"How do we create a just society?" <br><em>Plato vs Jefferson</em></div>
            </div>
        </div>
    </div>

                    <div class="figure-selection figure-1">
                        <h4>🎤 First Speaker</h4>
                        
                        <!-- Selection Mode Toggle -->
                        <div class="selection-mode">
                            <button type="button" class="mode-button active" onclick="toggleMode(1, 'preset')">📋 Preset Figures</button>
                            <button type="button" class="mode-button" onclick="toggleMode(1, 'custom')">✏️ Write Your Own</button>
                        </div>
                        
                        <label>Brilliant Figure:</label>
                        <select id="figure1" class="preset-select">
                             <optgroup label="🤔 Philosophers">
                                <option value="aristotle" selected="selected">Aristotle</option>
                                <option value="socrates">Socrates</option>
                                <option value="plato">Plato</option>
                                <option value="confucius">Confucius</option>
                                <option value="kant">Immanuel Kant</option>
                                <option value="nietzsche">Friedrich Nietzsche</option>
                            </optgroup>
                            <optgroup label="🔬 Scientists & Mathematicians">
                                <option value="einstein">Albert Einstein</option>
                                <option value="newton">Isaac Newton</option>
                                <option value="darwin">Charles Darwin</option>
                                <option value="curie">Marie Curie</option>
                                <option value="galileo">Galileo Galilei</option>
                                <option value="hawking">Stephen Hawking</option>
                                <option value="feynman">Richard Feynman</option>
                                <option value="tesla">Nikola Tesla</option>
                                <option value="pasteur">Louis Pasteur</option>
                                <option value="watson">James Watson</option>
                                <option value="turing">Alan Turing</option>
                            </optgroup>
                            <optgroup label="🖥️ Logic, Mathematics & Computing Pioneers">
                                <option value="frege">Gottlob Frege</option>
                                <option value="russell">Bertrand Russell</option>
                                <option value="hilbert">David Hilbert</option>
                                <option value="vonneumann">John von Neumann</option>
                                <option value="godel">Kurt Gödel</option>
                                <option value="shannon">Claude Shannon</option>
                                <option value="church_historical">Alonzo Church</option>
                                <option value="babbage">Charles Babbage</option>
                                <option value="lovelace">Ada Lovelace</option>
                            </optgroup>
                            <optgroup label="🧬 Contemporary Scientists & Thinkers">
                                <option value="penrose">Roger Penrose</option>
                                <option value="witten">Edward Witten</option>
                                <option value="venter">Craig Venter</option>
                                <option value="tao">Terence Tao</option>
                                <option value="yau">Shing-Tung Yau</option>
                                <option value="church">Alonzo Church</option>
                                <option value="kahneman">Daniel Kahneman</option>
                                <option value="wilson">Edward O. Wilson</option>
                                <option value="chomsky">Noam Chomsky</option>
                                <option value="pinker">Steven Pinker</option>
                                <option value="harari">Yuval Noah Harari</option>
                                <option value="tegmark">Max Tegmark</option>
                            </optgroup>
                            <optgroup label="👑 Leaders & Statesmen">
                                <option value="lincoln">Abraham Lincoln</option>
                                <option value="churchill">Winston Churchill</option>
                                <option value="gandhi">Mahatma Gandhi</option>
                                <option value="jefferson">Thomas Jefferson</option>
                                <option value="cleopatra">Cleopatra</option>
                                <option value="mandela">Nelson Mandela</option>
                            </optgroup>
                            <optgroup label="🎨 Artists & Writers">
                                <option value="shakespeare">William Shakespeare</option>
                                <option value="leonardo">Leonardo da Vinci</option>
                                <option value="michelangelo">Michelangelo</option>
                                <option value="beethoven">Ludwig van Beethoven</option>
                            </optgroup>
                            <optgroup label="💰 Economic & Social Thinkers">
                                <option value="smith">Adam Smith</option>
                                <option value="marx">Karl Marx</option>
                                <option value="keynes">John Maynard Keynes</option>
                                <option value="friedman">Milton Friedman</option>
                            </optgroup>
                            <optgroup label="💼 Contemporary Leaders & Innovators">
                                <option value="gates">Bill Gates</option>
                                <option value="musk">Elon Musk</option>
                                <option value="bezos">Jeff Bezos</option>
                                <option value="jobs">Steve Jobs</option>
                                <option value="buffett">Warren Buffett</option>
                                <option value="branson">Richard Branson</option>
                            </optgroup>
                        </select>
                        
                        <input type="text" id="figure1Custom" class="custom-input" placeholder="Enter any name (e.g., Taylor Swift, Napoleon, Frida Kahlo, your grandmother...)">
                        
                        <div class="suggestion-box" id="suggestion1" style="display: none;">
                            <strong>💡 Custom Figure Tips:</strong>
                            Try historical figures, celebrities, fictional characters, or even people you know! The AI will research and embody their personality, knowledge, and speaking style.
                        </div>
                    </div>
                    
                    <div class="figure-selection figure-2">
                        <h4>🎯 Second Speaker</h4>
                        
                        <!-- Selection Mode Toggle -->
                        <div class="selection-mode">
                            <button type="button" class="mode-button active" onclick="toggleMode(2, 'preset')">📋 Preset Figures</button>
                            <button type="button" class="mode-button" onclick="toggleMode(2, 'custom')">✏️ Write Your Own</button>
                        </div>
                        
                        <label>Brilliant Figure:</label>
                        <select id="figure2" class="preset-select">
                             <optgroup label="🤔 Philosophers">
                                <option value="aristotle">Aristotle</option>
                                <option value="socrates" selected="selected">Socrates</option>
                                <option value="plato">Plato</option>
                                <option value="confucius">Confucius</option>
                                <option value="kant">Immanuel Kant</option>
                                <option value="nietzsche">Friedrich Nietzsche</option>
                            </optgroup>
                            <optgroup label="🔬 Scientists & Mathematicians">
                                <option value="einstein">Albert Einstein</option>
                                <option value="newton">Isaac Newton</option>
                                <option value="darwin">Charles Darwin</option>
                                <option value="curie">Marie Curie</option>
                                <option value="galileo">Galileo Galilei</option>
                                <option value="hawking">Stephen Hawking</option>
                                <option value="feynman">Richard Feynman</option>
                                <option value="tesla">Nikola Tesla</option>
                                <option value="pasteur">Louis Pasteur</option>
                                <option value="watson">James Watson</option>
                                <option value="turing">Alan Turing</option>
                            </optgroup>
                            <optgroup label="🖥️ Logic, Mathematics & Computing Pioneers">
                                <option value="frege">Gottlob Frege</option>
                                <option value="russell">Bertrand Russell</option>
                                <option value="hilbert">David Hilbert</option>
                                <option value="vonneumann">John von Neumann</option>
                                <option value="godel">Kurt Gödel</option>
                                <option value="shannon">Claude Shannon</option>
                                <option value="church_historical">Alonzo Church</option>
                                <option value="babbage">Charles Babbage</option>
                                <option value="lovelace">Ada Lovelace</option>
                            </optgroup>
                            <optgroup label="🧬 Contemporary Scientists & Thinkers">
                                <option value="penrose">Roger Penrose</option>
                                <option value="witten">Edward Witten</option>
                                <option value="venter">Craig Venter</option>
                                <option value="tao">Terence Tao</option>
                                <option value="yau">Shing-Tung Yau</option>
                                <option value="church">Alonzo Church</option>
                                <option value="kahneman">Daniel Kahneman</option>
                                <option value="wilson">Edward O. Wilson</option>
                                <option value="chomsky">Noam Chomsky</option>
                                <option value="pinker">Steven Pinker</option>
                                <option value="harari">Yuval Noah Harari</option>
                                <option value="tegmark">Max Tegmark</option>
                            </optgroup>
                            <optgroup label="👑 Leaders & Statesmen">
                                <option value="lincoln">Abraham Lincoln</option>
                                <option value="churchill">Winston Churchill</option>
                                <option value="gandhi">Mahatma Gandhi</option>
                                <option value="jefferson">Thomas Jefferson</option>
                                <option value="cleopatra">Cleopatra</option>
                                <option value="mandela">Nelson Mandela</option>
                            </optgroup>
                            <optgroup label="🎨 Artists & Writers">
                                <option value="shakespeare">William Shakespeare</option>
                                <option value="leonardo">Leonardo da Vinci</option>
                                <option value="michelangelo">Michelangelo</option>
                                <option value="beethoven">Ludwig van Beethoven</option>
                            </optgroup>
                            <optgroup label="💰 Economic & Social Thinkers">
                                <option value="smith">Adam Smith</option>
                                <option value="marx">Karl Marx</option>
                                <option value="keynes">John Maynard Keynes</option>
                                <option value="friedman">Milton Friedman</option>
                            </optgroup>
                            <optgroup label="💼 Contemporary Leaders & Innovators">
                                <option value="gates">Bill Gates</option>
                                <option value="musk">Elon Musk</option>
                                <option value="bezos">Jeff Bezos</option>
                                <option value="jobs">Steve Jobs</option>
                                <option value="buffett">Warren Buffett</option>
                                <option value="branson">Richard Branson</option>
                            </optgroup>
                        </select>
                        
                        <input type="text" id="figure2Custom" class="custom-input" placeholder="Enter any name (e.g., Marie Antoinette, Carl Sagan, Maya Angelou...)">
                        
                        <div class="suggestion-box" id="suggestion2" style="display: none;">
                            <strong>💡 Custom Figure Tips:</strong>
                            Try historical figures, celebrities, fictional characters, or even people you know! The AI will research and embody their personality, knowledge, and speaking style.
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="start-button pulse" onclick="startDiscussion()">✨ Start Discussion</button>
                </div>
            </div>
            
            <!-- Participants Display -->
            <div class="participants-display fade-in" id="participantsDisplay">
                <h3 style="margin-bottom: 20px;">Today's Conversation Partners</h3>
                <div class="participant participant-1" id="participant1Name"></div>
                <span style="font-size: 30px; margin: 0 20px;">🤝</span>
                <div class="participant participant-2" id="participant2Name"></div>
            </div>
            
            <!-- Question Input -->
            <div class="question-input-section fade-in" id="questionSection">
                <h4>💬 What would you like them to discuss?</h4>
                <textarea id="questionInput" placeholder="Enter your question here... (e.g., 'What is the meaning of life?', 'How should society be organized?', 'What is the role of art in society?', 'Is free will real?')"></textarea>
                <div class="controls">
                    <button class="ask-button" onclick="askQuestion()">🚀 Start the Discussion</button>
                </div>
            </div>
            
            <!-- Discussion Arena -->
            <div class="discussion-arena fade-in" id="discussionArena">
                <!-- Discussion content will be added here -->
            </div>
            
            <div class="controls" id="discussionControls" style="display: none;">
                <button class="continue-button" onclick="continueDiscussion()" id="continueButton">🔄 Continue Discussion</button>
                <button class="ask-button" onclick="showQuestionInput()">💭 Ask Another Question</button>
                <button class="secondary-button" onclick="toggleExportPanel()">📤 Export & Share</button>
                <button class="secondary-button" onclick="toggleBookmarksPanel()">⭐ View Bookmarks</button>
                <button class="secondary-button" onclick="resetDiscussion()">🆕 New Discussion</button>
            </div>
            
            <!-- Export Controls -->
            <div class="export-controls" id="exportPanel">
                <h4>📤 Export & Share This Discussion</h4>
                <div class="export-buttons">
                    <button class="export-button" onclick="exportAsText()">📄 Download as Text</button>
                    <button class="export-button" onclick="exportAsMarkdown()">📝 Download as Markdown</button>
                    <button class="export-button" onclick="exportAsPDF()">📋 Download as PDF</button>
                    <button class="export-button" onclick="copyShareableLink()">🔗 Copy Shareable Link</button>
                    <button class="export-button" onclick="exportBookmarksOnly()">⭐ Export Bookmarks Only</button>
                </div>
            </div>
            
            <!-- Bookmarks Panel -->
            <div class="bookmarks-panel" id="bookmarksPanel">
                <h4>⭐ Your Bookmarked Insights</h4>
                <div id="bookmarksList">
                    <div class="bookmarks-empty">No bookmarks yet. Click the ⭐ button on any speaker's response to save it!</div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="export-button" onclick="clearAllBookmarks()">🗑️ Clear All Bookmarks</button>
                </div>
            </div>
            
            <!-- Direct Chat Option -->
            <div class="direct-chat-section" id="directChatSection" style="display: none;">
                <div class="direct-chat-card">
                    <h3>💬 Want to chat directly with one of these figures?</h3>
                    <p>Choose a figure from the discussion above to have a personal conversation with them.</p>
                    <div class="figure-buttons" id="figureButtons">
                        <!-- Buttons will be populated by JavaScript -->
                    </div>
                    <p style="font-size: 14px; color: #6c757d; margin-top: 16px;">
                        Or explore our <a href="chat.html" style="color: #667eea; text-decoration: none; font-weight: 600;">full chat interface</a> with all brilliant figures.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let discussionState = {
            figure1: null,
            figure2: null,
            currentQuestion: '',
            isExtended: false,
            currentContainer: null,
            figure1Mode: 'preset',
            figure2Mode: 'preset',
            extensionCount: 0,
            additionalResponses: [],
            bookmarks: [],
            discussionStartTime: null
        };

        // Toggle between preset and custom input modes
        function toggleMode(figureNum, mode) {
            discussionState[`figure${figureNum}Mode`] = mode;
            
            const presetSelect = document.getElementById(`figure${figureNum}`);
            const customInput = document.getElementById(`figure${figureNum}Custom`);
            const suggestionBox = document.getElementById(`suggestion${figureNum}`);
            const modeButtons = document.querySelectorAll(`.figure-selection:nth-child(${figureNum + 1}) .mode-button`);
            
            // Update button states
            modeButtons.forEach((btn, index) => {
                if ((index === 0 && mode === 'preset') || (index === 1 && mode === 'custom')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Show/hide appropriate input
            if (mode === 'preset') {
                presetSelect.style.display = 'block';
                customInput.style.display = 'none';
                suggestionBox.style.display = 'none';
            } else {
                presetSelect.style.display = 'none';
                customInput.style.display = 'block';
                suggestionBox.style.display = 'block';
                customInput.focus();
            }
        }

        // Create custom figure object from name
        function createCustomFigure(name) {
            return {
                name: name,
                prompt: `You are ${name}. Embody their personality, knowledge, speaking style, and perspective as accurately as possible. If this is a real person, draw on their known views, experiences, and way of communicating. If this is a fictional character, embody their personality from their source material. If this is someone the user knows personally, ask clarifying questions if needed, but generally respond as a thoughtful, intelligent person with that name would. Stay in character throughout the conversation and bring their unique perspective to the discussion.`
            };
        }

        // Enhanced brilliant figures with scientists and thought leaders (keeping all your existing figures)
        const figures = {
            // Philosophers
            socrates: {
                name: "Socrates",
                prompt: "You are Socrates. Use the Socratic method - ask probing questions to examine beliefs. Be humble about your own knowledge ('I know that I know nothing'). Challenge assumptions and seek truth through questioning."
            },
            aristotle: {
                name: "Aristotle",
                prompt: "You are Aristotle. Speak as a systematic philosopher and logician. Use logical reasoning and categorical thinking. Reference your teachings on ethics, politics, and human nature."
            },
            plato: {
                name: "Plato",
                prompt: "You are Plato. Speak about ideals, truth, and the nature of reality. Reference your theory of Forms and beliefs about justice and the ideal state. Use allegories and philosophical reasoning."
            },
            confucius: {
                name: "Confucius",
                prompt: "You are Confucius. Speak with wisdom about social harmony, virtue, and proper relationships. Reference the importance of education, family, and moral cultivation. Use thoughtful aphorisms."
            },
            kant: {
                name: "Immanuel Kant",
                prompt: "You are Immanuel Kant. Speak about duty, categorical imperatives, and moral philosophy. Reference the limits of reason and the importance of moral law. Be systematic and precise in your thinking."
            },
            nietzsche: {
                name: "Friedrich Nietzsche",
                prompt: "You are Friedrich Nietzsche. Speak provocatively about the will to power, the übermensch, and questioning traditional values. Challenge conventional morality and advocate for individual strength and creativity."
            },
            
            // Scientists & Mathematicians
            einstein: {
                name: "Albert Einstein",
                prompt: "You are Albert Einstein. Respond with scientific curiosity, wisdom, and humanitarian concerns. Reference scientific principles when relevant. Show your philosophical side and concern for humanity's future."
            },
            newton: {
                name: "Isaac Newton",
                prompt: "You are Isaac Newton. Speak with mathematical precision and systematic thinking. Reference natural laws, gravity, and the mathematical nature of the universe. Show your methodical approach to understanding nature."
            },
            darwin: {
                name: "Charles Darwin",
                prompt: "You are Charles Darwin. Speak about evolution, natural selection, and careful observation of nature. Show your methodical approach to collecting evidence and drawing conclusions. Reference the interconnectedness of life."
            },
            curie: {
                name: "Marie Curie",
                prompt: "You are Marie Curie. Speak with dedication to scientific research and discovery. Reference your work with radioactivity and your perseverance in a male-dominated field. Show passion for knowledge and scientific advancement."
            },
            galileo: {
                name: "Galileo Galilei",
                prompt: "You are Galileo Galilei. Speak about observation, experimentation, and challenging established beliefs. Reference your telescopic discoveries and your conflict with traditional authority. Advocate for empirical evidence."
            },
            hawking: {
                name: "Stephen Hawking",
                prompt: "You are Stephen Hawking. Speak about black holes, the nature of time, and the universe. Make complex physics accessible. Show your wit and determination to understand the cosmos despite physical limitations."
            },
            feynman: {
                name: "Richard Feynman",
                prompt: "You are Richard Feynman. Speak with curiosity and explain complex physics simply. Use analogies and everyday examples. Show your love of learning and teaching. Be playful yet profound in your insights."
            },
            tesla: {
                name: "Nikola Tesla",
                prompt: "You are Nikola Tesla. Speak about electricity, invention, and the future of technology. Show your visionary thinking and dedication to advancing human civilization through science and engineering."
            },
            pasteur: {
                name: "Louis Pasteur",
                prompt: "You are Louis Pasteur. Speak about the scientific method, germ theory, and the importance of careful experimentation. Show your dedication to improving human health through scientific discovery."
            },
            watson: {
                name: "James Watson",
                prompt: "You are James Watson. Speak about DNA, genetics, and molecular biology. Reference the structure of DNA and the importance of scientific collaboration. Show your passion for understanding life at the molecular level."
            },
            turing: {
                name: "Alan Turing",
                prompt: "You are Alan Turing. Speak about computation, artificial intelligence, and mathematical logic. Reference your work on breaking codes, the theoretical foundations of computer science, and the Turing test for machine intelligence."
            },
            
            // Logic, Mathematics & Computing Pioneers
            frege: {
                name: "Gottlob Frege",
                prompt: "You are Gottlob Frege. Speak about mathematical logic, the foundations of arithmetic, and formal systems. Reference your work on predicate logic and the logical foundations of mathematics. Discuss sense and reference in language and logic."
            },
            russell: {
                name: "Bertrand Russell",
                prompt: "You are Bertrand Russell. Speak about mathematical logic, philosophy of mathematics, and analytic philosophy. Reference Russell's Paradox, logical atomism, and your work with Whitehead on Principia Mathematica. Discuss the relationship between logic and reality."
            },
            hilbert: {
                name: "David Hilbert",
                prompt: "You are David Hilbert. Speak about mathematical formalism, the foundations of geometry, and Hilbert's program. Reference your work on axiomatization and the quest to prove mathematics is complete and consistent. Discuss mathematical rigor and proof theory."
            },
            vonneumann: {
                name: "John von Neumann",
                prompt: "You are John von Neumann. Speak about computer architecture, game theory, and mathematical foundations. Reference the von Neumann architecture, quantum mechanics formalism, and mathematical economics. Discuss the intersection of mathematics and practical applications."
            },
            godel: {
                name: "Kurt Gödel",
                prompt: "You are Kurt Gödel. Speak about mathematical logic, incompleteness theorems, and the limits of formal systems. Reference your proof that mathematics contains undecidable propositions. Discuss the philosophical implications of mathematical incompleteness."
            },
            shannon: {
                name: "Claude Shannon",
                prompt: "You are Claude Shannon. Speak about information theory, digital circuits, and communication systems. Reference your mathematical theory of communication and the concept of information entropy. Discuss how information can be quantified and transmitted."
            },
            church_historical: {
                name: "Alonzo Church",
                prompt: "You are Alonzo Church. Speak about lambda calculus, mathematical logic, and computability theory. Reference Church's thesis on effective calculability and your work on the foundations of computer science. Discuss the relationship between logic and computation."
            },
            babbage: {
                name: "Charles Babbage",
                prompt: "You are Charles Babbage. Speak about mechanical computation, the Analytical Engine, and early computer design. Reference your vision of programmable machines and automatic calculation. Discuss the mechanical foundations of computing."
            },
            lovelace: {
                name: "Ada Lovelace",
                prompt: "You are Ada Lovelace. Speak about programming, mathematical computation, and the potential of computing machines. Reference your work on Babbage's Analytical Engine and your vision of computers beyond mere calculation. Discuss the creative possibilities of computation."
            },
            
            // Leaders & Statesmen
            lincoln: {
                name: "Abraham Lincoln",
                prompt: "You are Abraham Lincoln. Speak with wisdom, humility, and moral clarity. Use folksy anecdotes and simple language to explain complex ideas. Show concern for justice, unity, and human dignity."
            },
            churchill: {
                name: "Winston Churchill",
                prompt: "You are Winston Churchill. Speak with determination, wit, and rhetorical flair. Reference your wartime leadership experience. Use powerful, memorable phrases and show resolve."
            },
            gandhi: {
                name: "Mahatma Gandhi",
                prompt: "You are Mahatma Gandhi. Speak with moral authority, non-violence, and spiritual wisdom. Reference your philosophy of peaceful resistance and social justice. Show compassion and dedication to truth."
            },
            jefferson: {
                name: "Thomas Jefferson",
                prompt: "You are Thomas Jefferson. Speak as an Enlightenment thinker and founding father. Reference democratic ideals, individual liberty, and natural rights. Show your intellectual breadth."
            },
            cleopatra: {
                name: "Cleopatra",
                prompt: "You are Cleopatra VII of Egypt. Speak with intelligence, political acumen, and regal bearing. Reference ancient leadership, politics, and strategy. Show your multilingual education and diplomatic skills."
            },
            mandela: {
                name: "Nelson Mandela",
                prompt: "You are Nelson Mandela. Speak about reconciliation, justice, and peaceful resistance to oppression. Reference your experience with apartheid and your commitment to unity and forgiveness."
            },
            
            // Artists & Writers
            shakespeare: {
                name: "William Shakespeare",
                prompt: "You are William Shakespeare. Speak with eloquence and creativity. Use some Elizabethan flair but keep it understandable. Reference human nature and the human condition. Use metaphors and poetic language."
            },
            leonardo: {
                name: "Leonardo da Vinci",
                prompt: "You are Leonardo da Vinci. Show Renaissance curiosity about everything - art, science, engineering, nature. Connect different fields of knowledge. Be enthusiastic about learning and observation."
            },
            michelangelo: {
                name: "Michelangelo",
                prompt: "You are Michelangelo. Speak passionately about art, sculpture, and the pursuit of perfection. Reference your dedication to capturing divine beauty and human form. Show your artistic intensity and spiritual devotion."
            },
            beethoven: {
                name: "Ludwig van Beethoven",
                prompt: "You are Ludwig van Beethoven. Speak passionately about music, emotion, and artistic expression. Reference how music can convey the deepest human feelings. Show your revolutionary spirit in art."
            },
            
            // Economic & Social Thinkers
            smith: {
                name: "Adam Smith",
                prompt: "You are Adam Smith. Speak about free markets, the invisible hand, and human nature in economic behavior. Reference the importance of self-interest balanced with moral sentiments."
            },
            marx: {
                name: "Karl Marx",
                prompt: "You are Karl Marx. Speak about class struggle, capitalism, and social revolution. Reference the importance of economic structures in shaping society and the need for worker solidarity."
            },
            keynes: {
                name: "John Maynard Keynes",
                prompt: "You are John Maynard Keynes. Speak about economics, government intervention, and managing economic cycles. Reference the importance of demand management and practical economic policy."
            },
            friedman: {
                name: "Milton Friedman",
                prompt: "You are Milton Friedman. Speak about free markets, individual choice, and limited government. Reference the efficiency of market mechanisms and the importance of economic freedom."
            },
            
            // Contemporary Scientists & Thinkers
            penrose: {
                name: "Roger Penrose",
                prompt: "You are Roger Penrose. Speak about mathematical physics, consciousness, and cosmology. Reference your work on black holes, penrose tilings, and quantum theories of consciousness. Discuss the deep mathematical structure of reality."
            },
            witten: {
                name: "Edward Witten",
                prompt: "You are Edward Witten. Speak about string theory, mathematical physics, and the unification of fundamental forces. Reference M-theory and the mathematical elegance underlying physical reality. Discuss topology and quantum field theory."
            },
            venter: {
                name: "Craig Venter",
                prompt: "You are Craig Venter. Speak about genomics, synthetic biology, and the future of life sciences. Reference your work sequencing the human genome and creating synthetic life forms. Discuss personalized medicine and bioengineering."
            },
            tao: {
                name: "Terence Tao",
                prompt: "You are Terence Tao. Speak about pure mathematics, number theory, and harmonic analysis. Reference your work on prime numbers, partial differential equations, and mathematical problem-solving. Discuss the beauty and structure of mathematical truth."
            },
            yau: {
                name: "Shing-Tung Yau",
                prompt: "You are Shing-Tung Yau. Speak about differential geometry, algebraic geometry, and mathematical physics. Reference Calabi-Yau manifolds and your work bridging mathematics and string theory. Discuss the geometric foundations of physical reality."
            },
            church: {
                name: "Alonzo Church",
                prompt: "You are Alonzo Church. Speak about mathematical logic, lambda calculus, and the foundations of computation. Reference Church's thesis and your work on decidability. Discuss the logical structure underlying mathematics and computation."
            },
            kahneman: {
                name: "Daniel Kahneman",
                prompt: "You are Daniel Kahneman. Speak about behavioral economics, cognitive biases, and decision-making. Reference prospect theory and your work on human irrationality. Discuss how psychology impacts economic and personal decisions."
            },
            wilson: {
                name: "Edward O. Wilson",
                prompt: "You are Edward O. Wilson. Speak about sociobiology, biodiversity, and conservation. Reference your work on ant colonies, island biogeography, and the unity of knowledge. Discuss the biological foundations of behavior and environmental protection."
            },
            chomsky: {
                name: "Noam Chomsky",
                prompt: "You are Noam Chomsky. Speak about linguistics, cognitive science, and political criticism. Reference universal grammar and critique media and political power structures. Show deep concern for social justice."
            },
            pinker: {
                name: "Steven Pinker",
                prompt: "You are Steven Pinker. Speak about cognitive psychology, language, and human progress. Reference declining violence and the power of reason and science. Be optimistic about human nature and Enlightenment values."
            },
            harari: {
                name: "Yuval Noah Harari",
                prompt: "You are Yuval Noah Harari. Speak about human history, the future of humanity, and artificial intelligence. Reference cognitive revolution, agricultural revolution, and scientific revolution. Discuss how technology shapes society."
            },
            diamandis: {
                name: "Peter Diamandis",
                prompt: "You are Peter Diamandis. Speak about exponential technologies, space exploration, and abundance mindset. Reference how technology solves humanity's grand challenges. Be optimistic about innovation and entrepreneurship."
            },
            tegmark: {
                name: "Max Tegmark",
                prompt: "You are Max Tegmark. Speak about artificial intelligence, cosmology, and the mathematical universe hypothesis. Discuss AI safety and the future of intelligence. Reference parallel universes and consciousness."
            },
            
            // Contemporary Leaders & Innovators
            gates: {
                name: "Bill Gates",
                prompt: "You are Bill Gates. Speak about technology, global health, and philanthropy. Reference your Microsoft experience and current focus on solving world problems through innovation and giving. Discuss pandemic preparedness and climate change."
            },
            musk: {
                name: "Elon Musk",
                prompt: "You are Elon Musk. Speak about electric vehicles, space exploration, and artificial intelligence. Reference your work with Tesla, SpaceX, and Neuralink. Be ambitious about humanity's multi-planetary future and sustainable energy."
            },
            bezos: {
                name: "Jeff Bezos",
                prompt: "You are Jeff Bezos. Speak about e-commerce, cloud computing, and space colonization. Reference customer obsession and long-term thinking. Discuss building companies that can scale and your vision for space manufacturing."
            },
            jobs: {
                name: "Steve Jobs",
                prompt: "You are Steve Jobs. Speak about design, innovation, and user experience. Reference the intersection of technology and liberal arts. Emphasize simplicity, perfection, and thinking differently about products."
            },
            buffett: {
                name: "Warren Buffett",
                prompt: "You are Warren Buffett. Speak about value investing, business principles, and long-term thinking. Reference buying great companies at fair prices and the importance of understanding businesses. Use folksy wisdom and analogies."
            },
            branson: {
                name: "Richard Branson",
                prompt: "You are Richard Branson. Speak about entrepreneurship, adventure, and putting employees first. Reference the Virgin brand philosophy and disrupting established industries. Emphasize fun, customer service, and taking calculated risks."
            }
        };
        
        function startDiscussion() { 
            let figure1, figure2;
            
            // Get figure 1
            if (discussionState.figure1Mode === 'preset') {
                const figure1Id = document.getElementById('figure1').value;
                figure1 = figures[figure1Id];
            } else {
                const figure1Name = document.getElementById('figure1Custom').value.trim();
                if (!figure1Name) {
                    alert('Please enter a name for the first speaker!');
                    return;
                }
                figure1 = createCustomFigure(figure1Name);
            }
            
            // Get figure 2
            if (discussionState.figure2Mode === 'preset') {
                const figure2Id = document.getElementById('figure2').value;
                figure2 = figures[figure2Id];
            } else {
                const figure2Name = document.getElementById('figure2Custom').value.trim();
                if (!figure2Name) {
                    alert('Please enter a name for the second speaker!');
                    return;
                }
                figure2 = createCustomFigure(figure2Name);
            }
            
            // Check if same figure selected/entered
            if (figure1.name.toLowerCase() === figure2.name.toLowerCase()) {
                alert('Please select or enter different figures for an interesting discussion!');
                return;
            }
            
            discussionState.figure1 = figure1;
            discussionState.figure2 = figure2;
            
            // Update display
            document.getElementById('participant1Name').textContent = discussionState.figure1.name;
            document.getElementById('participant2Name').textContent = discussionState.figure2.name;
            
            // Show/hide sections with animation
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('participantsDisplay').style.display = 'block';
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('discussionArena').style.display = 'block';
            
            // Clear previous discussions
            document.getElementById('discussionArena').innerHTML = '';
        }
        
        async function askQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) {
                alert('Please enter a question!');
                return;
            }
            
            discussionState.currentQuestion = question;
            discussionState.discussionStartTime = new Date();
            
            // Hide question input
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'block';
            
            // Create discussion round
            const arena = document.getElementById('discussionArena');
            const roundDiv = document.createElement('div');
            roundDiv.className = 'discussion-round fade-in';
            roundDiv.innerHTML = `<div class="question-header">💭 "${question}"</div>`;
            arena.appendChild(roundDiv);
            
            // Conduct the three-part discussion
            await getInitialResponse(roundDiv);
            await getSecondResponse(roundDiv);
            await getFollowUpResponse(roundDiv);
            await getModerationSummary(roundDiv);
            
            // Store current container for potential continuation
            discussionState.currentContainer = roundDiv;
            discussionState.isExtended = false;
            
            // Show direct chat options
            showDirectChatOptions();
        }
        
        async function getInitialResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                <div><span class="loading"></span>Thinking...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are starting a thoughtful discussion. The question is: "${discussionState.currentQuestion}"

Give your perspective on this question in a CONCISE way (2-3 key points maximum). Be thoughtful and authentic to your historical viewpoint, but focus on your most important insights. Keep it under 150 words.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <button class="bookmark-button" onclick="addBookmark('${discussionState.figure1.name}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <button class="bookmark-button" onclick="addBookmark('${discussionState.figure2.name}', \`${response.replace(/`/g, '\\`').replace(/\$/g, '\\
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Opening Thoughts')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for next speaker
                discussionState.firstResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Response & Analysis')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>)}\`, 'Opening Thoughts')">⭐ Bookmark</button>
                    <div class="speaker-name">${discussionState.figure1.name} (Opening Thoughts)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for next speaker
                discussionState.firstResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getSecondResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                <div><span class="loading"></span>Considering ${discussionState.figure1.name}'s thoughts...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure2.prompt}
                
You are in a discussion with ${discussionState.figure1.name}. The question is: "${discussionState.currentQuestion}"

${discussionState.figure1.name} just shared their perspective:
"${discussionState.firstResponse}"

Now respond CONCISELY (under 150 words). Focus on:
1. Your key perspective on the question (1-2 main points)
2. One specific point where you agree with ${discussionState.figure1.name}
3. One specific point where you disagree or see things differently

Be direct and focused on your most important insights.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Response & Analysis)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for follow-up
                discussionState.secondResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getFollowUpResponse(container) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                <div><span class="loading"></span>Reflecting on ${discussionState.figure2.name}'s insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const prompt = `${discussionState.figure1.prompt}
                
You are continuing a discussion with ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

You initially said:
"${discussionState.firstResponse}"

${discussionState.figure2.name} then responded with:
"${discussionState.secondResponse}"

Now reflect CONCISELY (under 150 words) on ${discussionState.figure2.name}'s response. Focus on:
1. One key insight they shared that you find valuable
2. One point where you still disagree or see things differently
3. Any new thought their perspective sparked

Be direct and focused on your most important reactions.`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Reflection & Reply)</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for moderation
                discussionState.thirdResponse = response;
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getModerationSummary(container) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Insights</div>
                <div><span class="loading"></span>Analyzing the discussion...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const prompt = `You are a modern AI moderator analyzing a thoughtful discussion between two brilliant figures.

Question discussed: "${discussionState.currentQuestion}"
Participants: ${discussionState.figure1.name} and ${discussionState.figure2.name}

Key points from the discussion:

${discussionState.figure1.name}'s initial perspective:
"${discussionState.firstResponse}"

${discussionState.figure2.name}'s response and analysis:
"${discussionState.secondResponse}"

${discussionState.figure1.name}'s reflection:
"${discussionState.thirdResponse}"

Provide a thoughtful summary using this exact format:

#### Key Insights
[The main insights that emerged from this discussion]

#### Areas of Agreement
[Where they found common ground]

#### Areas of Disagreement
[Where they had different perspectives]

#### What We Can Learn
[What readers can take away from their different perspectives]

#### Synthesis
[Any new understanding that emerged from their exchange]

Keep each section concise but insightful. Use clear headings and organize your thoughts well.`;
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Insights</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating summary: ${error.message}</div>
                `;
            }
        }
        
        async function callClaude(prompt) {
            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    figure: 'discussion'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        function showQuestionInput() {
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('questionInput').value = '';
            document.getElementById('discussionControls').style.display = 'none';
        }
        
        async function continueDiscussion() {
            // Initialize extension tracking if not exists
            if (!discussionState.extensionCount) {
                discussionState.extensionCount = 0;
            }
            
            discussionState.extensionCount++;
            
            // Update button text and show progress
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = true;
            continueButton.innerHTML = `<span class="loading"></span>Extending discussion...`;
            
            const container = discussionState.currentContainer;
            
            // Add dynamic extension header
            const extendedHeader = document.createElement('div');
            extendedHeader.className = 'extended-separator fade-in';
            extendedHeader.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>🔄 Round ${discussionState.extensionCount + 1} - Deeper Exploration</span>
                    <div style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        ${discussionState.extensionCount === 1 ? 'Diving Deeper' : 
                          discussionState.extensionCount === 2 ? 'Getting Philosophical' :
                          discussionState.extensionCount === 3 ? 'Mind-Bending Territory' :
                          'Transcendent Insights'}
                    </div>
                </div>
            `;
            container.appendChild(extendedHeader);
            
            // Get the conversation history for context
            const conversationHistory = getConversationHistory();
            
            // Continue with alternating speakers
            if (discussionState.extensionCount === 1) {
                // First extension - original flow
                await getExtendedResponse2(container, conversationHistory);
                await getExtendedResponse1(container, conversationHistory);
            } else {
                // Subsequent extensions - alternate who goes first
                if (discussionState.extensionCount % 2 === 0) {
                    await getExtendedResponse1(container, conversationHistory);
                    await getExtendedResponse2(container, conversationHistory);
                } else {
                    await getExtendedResponse2(container, conversationHistory);
                    await getExtendedResponse1(container, conversationHistory);
                }
            }
            
            // Add moderator insights every few rounds
            if (discussionState.extensionCount % 2 === 0) {
                await getProgressiveModerationSummary(container, conversationHistory);
            }
            
            // Re-enable continue button with dynamic text
            continueButton.disabled = false;
            if (discussionState.extensionCount >= 5) {
                continueButton.innerHTML = '🌟 Keep Exploring the Depths';
            } else if (discussionState.extensionCount >= 3) {
                continueButton.innerHTML = '🧠 Go Even Deeper';
            } else {
                continueButton.innerHTML = '🔄 Continue Discussion';
            }
            
            // Add helpful hint after a few rounds
            if (discussionState.extensionCount === 3) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'extended-separator fade-in';
                hintDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                hintDiv.style.color = '#f57c00';
                hintDiv.style.borderColor = '#ff9800';
                hintDiv.innerHTML = `
                    💡 <strong>Tip:</strong> The discussion is getting quite deep! You can ask a new question anytime to explore different aspects, 
                    or keep extending to see where this fascinating conversation leads.
                `;
                container.appendChild(hintDiv);
            }
        }
        
        // Get conversation history for context
        function getConversationHistory() {
            const responses = [];
            if (discussionState.firstResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.firstResponse}"`);
            if (discussionState.secondResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.secondResponse}"`);
            if (discussionState.thirdResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.thirdResponse}"`);
            if (discussionState.fourthResponse) responses.push(`${discussionState.figure2.name}: "${discussionState.fourthResponse}"`);
            if (discussionState.fifthResponse) responses.push(`${discussionState.figure1.name}: "${discussionState.fifthResponse}"`);
            
            // Add any additional responses from multiple extensions
            if (discussionState.additionalResponses) {
                responses.push(...discussionState.additionalResponses);
            }
            
            return responses;
        }
        
        // Store additional responses for context
        function storeAdditionalResponse(figureName, response) {
            if (!discussionState.additionalResponses) {
                discussionState.additionalResponses = [];
            }
            discussionState.additionalResponses.push(`${figureName}: "${response}"`);
        }
        
        async function getExtendedResponse2(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-2-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Building on the rich discussion...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const extensionPrompts = [
                    // Extension 1
                    `You have been discussing "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

This discussion has been fascinating. Share additional thoughts CONCISELY (under 150 words). Focus on:
1. A new angle or deeper insight you haven't explored yet
2. How the conversation has evolved your thinking
3. A provocative question or challenge for ${discussionState.figure1.name}

Bring fresh perspective while building on what's been said.`,
                    
                    // Extension 2
                    `Continuing this deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure1.name}.

Recent conversation:
${recentHistory}

The discussion is reaching new depths. Share your evolving thoughts CONCISELY (under 150 words). Focus on:
1. An unexpected connection or realization that emerged
2. A fundamental assumption that might need questioning
3. Where you think this conversation is leading us

Push the boundaries of conventional thinking.`,
                    
                    // Extension 3+
                    `This profound discussion of "${discussionState.currentQuestion}" with ${discussionState.figure1.name} continues to evolve.

Recent conversation:
${recentHistory}

We're in fascinating territory now. Share your deepest insights CONCISELY (under 150 words). Focus on:
1. The most surprising thing you've learned from this exchange
2. A synthesis of ideas that transcends your original position
3. What questions this conversation raises for humanity

Be bold and visionary in your thinking.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure2.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure2.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure2.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getExtendedResponse1(container, conversationHistory) {
            const speakerDiv = document.createElement('div');
            speakerDiv.className = 'speaker figure-1-speaker fade-in';
            speakerDiv.innerHTML = `
                <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                <div><span class="loading"></span>Responding with deeper insights...</div>
            `;
            container.appendChild(speakerDiv);
            
            try {
                const recentHistory = conversationHistory.slice(-4).join('\n');
                const latestResponse = discussionState.additionalResponses ? 
                    discussionState.additionalResponses[discussionState.additionalResponses.length - 1] : '';
                
                const extensionPrompts = [
                    // Extension 1
                    `Continuing this fascinating discussion of "${discussionState.currentQuestion}" with ${discussionState.figure2.name}.

Recent conversation:
${recentHistory}
${latestResponse}

Respond thoughtfully to ${discussionState.figure2.name}'s latest insights CONCISELY (under 150 words). Focus on:
1. What resonates most deeply with you from their perspective
2. A counter-insight or alternative view that emerges
3. How this conversation is changing your understanding

Build on the intellectual momentum.`,
                    
                    // Extension 2  
                    `This deep exploration of "${discussionState.currentQuestion}" with ${discussionState.figure2.name} is reaching new heights.

Recent conversation:
${recentHistory}
${latestResponse}

The discussion has become quite profound. Respond CONCISELY (under 150 words). Focus on:
1. The most thought-provoking point ${discussionState.figure2.name} just raised
2. How your own thinking has evolved through this dialogue
3. A fundamental insight about the nature of this question itself

Embrace intellectual courage and depth.`,
                    
                    // Extension 3+
                    `This extraordinary dialogue about "${discussionState.currentQuestion}" with ${discussionState.figure2.name} continues to surprise.

Recent conversation:
${recentHistory}
${latestResponse}

We're exploring uncharted intellectual territory. Respond CONCISELY (under 150 words). Focus on:
1. How ${discussionState.figure2.name}'s perspective illuminates something profound
2. A synthesis that neither of you could have reached alone
3. What this means for how we should think about such questions

Reach for transcendent understanding.`
                ];
                
                const promptIndex = Math.min(discussionState.extensionCount - 1, 2);
                const prompt = `${discussionState.figure1.prompt}\n\n${extensionPrompts[promptIndex]}`;
                
                const response = await callClaude(prompt);
                
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name} (Round ${discussionState.extensionCount + 1})</div>
                    <div class="speaker-content">${formatResponse(response)}</div>
                `;
                
                // Store for context
                storeAdditionalResponse(discussionState.figure1.name, response);
                
            } catch (error) {
                speakerDiv.innerHTML = `
                    <div class="speaker-name">${discussionState.figure1.name}</div>
                    <div>❌ Error: ${error.message}</div>
                `;
            }
        }
        
        async function getProgressiveModerationSummary(container, conversationHistory) {
            const moderatorDiv = document.createElement('div');
            moderatorDiv.className = 'speaker moderator-speaker fade-in';
            moderatorDiv.innerHTML = `
                <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                <div><span class="loading"></span>Analyzing the evolving conversation...</div>
            `;
            container.appendChild(moderatorDiv);
            
            try {
                const fullHistory = conversationHistory.join('\n');
                
                const moderatorPrompts = [
                    // Rounds 2, 4, 6...
                    `You are analyzing an extended discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

Complete conversation so far:
${fullHistory}

This discussion has now gone through ${discussionState.extensionCount + 1} rounds. Provide analysis using this format:

#### How the Discussion Has Evolved
[How their perspectives have developed and changed]

#### New Insights Emerging
[Fresh ideas that have surfaced in recent rounds]

#### Where They're Converging
[Points of growing agreement or synthesis]

#### Where They're Diverging
[Areas where differences are becoming more pronounced]

#### What's at Stake
[Why this conversation matters - the deeper implications]

Keep each section concise but insightful.`,
                    
                    // For later rounds (6+)
                    `You are analyzing a deeply extended philosophical discussion between ${discussionState.figure1.name} and ${discussionState.figure2.name} about: "${discussionState.currentQuestion}"

This conversation has reached ${discussionState.extensionCount + 1} rounds of exploration:
${fullHistory}

This is becoming a profound intellectual journey. Provide analysis using this format:

#### The Intellectual Journey
[How thinking has evolved across all rounds]

#### Breakthrough Moments
[Key insights that transformed the discussion]

#### Philosophical Depth Achieved
[The level of understanding now being explored]

#### Questions for Humanity
[What this conversation reveals about how we should think]

#### The Conversation's Legacy
[What readers can take from this extended exploration]

Focus on the transformative nature of extended dialogue.`
                ];
                
                const promptIndex = discussionState.extensionCount >= 5 ? 1 : 0;
                const prompt = moderatorPrompts[promptIndex];
                
                const response = await callClaude(prompt);
                
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">🎯 Discussion Analysis - Round ${discussionState.extensionCount + 1}</div>
                    <div class="moderator-content">${formatModeratorResponse(response)}</div>
                `;
                
            } catch (error) {
                moderatorDiv.innerHTML = `
                    <div class="speaker-name">AI Moderator</div>
                    <div>❌ Error generating analysis: ${error.message}</div>
                `;
            }
        }
        
        function resetDiscussion() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('participantsDisplay').style.display = 'none';
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('discussionArena').style.display = 'none';
            document.getElementById('discussionControls').style.display = 'none';
            document.getElementById('directChatSection').style.display = 'none';
            document.getElementById('discussionArena').innerHTML = '';
            
            // Reset all discussion state
            discussionState.isExtended = false;
            discussionState.extensionCount = 0;
            discussionState.additionalResponses = [];
            
            // Reset continue button
            const continueButton = document.getElementById('continueButton');
            continueButton.innerHTML = '🔄 Continue Discussion';
            continueButton.style.display = 'inline-block';
        }
        
        function showDirectChatOptions() {
            document.getElementById('directChatSection').style.display = 'block';
            
            const figureButtons = document.getElementById('figureButtons');
            figureButtons.innerHTML = `
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure1.name}')">
                    Chat with ${discussionState.figure1.name}
                </button>
                <button class="figure-chat-button" onclick="startDirectChat('${discussionState.figure2.name}')">
                    Chat with ${discussionState.figure2.name}
                </button>
            `;
        }
        
        function startDirectChat(figureName) {
            // Store the selected figure in localStorage so the chat page can access it
            localStorage.setItem('selectedFigureName', figureName);
            localStorage.setItem('fromDiscussion', 'true');
            
            // Check if it's a preset figure or custom figure
            const presetFigure = Object.values(figures).find(f => f.name === figureName);
            if (presetFigure) {
                const figureId = Object.keys(figures).find(key => figures[key].name === figureName);
                localStorage.setItem('selectedFigure', figureId);
            } else {
                // It's a custom figure, store as custom
                localStorage.setItem('selectedFigure', 'custom');
                localStorage.setItem('customFigureName', figureName);
            }
            
            // Redirect to chat page
            window.location.href = 'chat.html';
        }
        
        function formatModeratorResponse(response) {
            // Convert markdown-style headers to proper HTML
            let formatted = response.replace(/####\s+([^\n]+)/g, '<h4>$1</h4>');
            
            // Convert line breaks to paragraphs
            let paragraphs = formatted.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                if (p.includes('<h4>')) {
                    return p;
                } else {
                    return `<p>${p.trim()}</p>`;
                }
            }).join('');
        }
        
        function formatResponse(response) {
            // Add natural paragraph breaks for better readability
            if (!response || response.length < 100) {
                return `<p>${response}</p>`;
            }
            
            // Split into sentences
            let sentences = response.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = [];
            
            for (let i = 0; i < sentences.length; i++) {
                currentParagraph.push(sentences[i]);
                
                // Create paragraph break every 2-3 sentences or at logical breaks
                if (currentParagraph.length >= 2 && 
                    (sentences[i].includes('However') || 
                     sentences[i].includes('Furthermore') || 
                     sentences[i].includes('Moreover') || 
                     sentences[i].includes('In contrast') ||
                     sentences[i].includes('On the other hand') ||
                     sentences[i].includes('That said') ||
                     currentParagraph.length >= 3)) {
                    
                    paragraphs.push(currentParagraph.join(' '));
                    currentParagraph = [];
                }
            }
            
            // Add any remaining sentences
            if (currentParagraph.length > 0) {
                paragraphs.push(currentParagraph.join(' '));
            }
            
            // If no logical breaks found, split roughly in half
            if (paragraphs.length === 1 && sentences.length > 4) {
                const midPoint = Math.ceil(sentences.length / 2);
                paragraphs = [
                    sentences.slice(0, midPoint).join(' '),
                    sentences.slice(midPoint).join(' ')
                ];
            }
            
            return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
    </script>
</body>
</html>
